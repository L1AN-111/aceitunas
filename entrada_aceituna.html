<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporaci√≥n Costa Verde - Panel de Gesti√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #FAF8F5;
            min-height: 100vh;
            color: #0f172a;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Custom Scrollbar for modals */
        .modal-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .modal-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .modal-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        .modal-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Header */
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .brand-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #4a5c3c, #1a1a1a);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border-radius: 50px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3d4f31, #1a1a1a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #334155;
        }

        .user-role {
            font-size: 0.7rem;
            background: #0f172a;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            color: #64748b;
            transition: .2s;
        }

        .btn-logout:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            padding: 1.5rem 0;
            position: relative;
            height: calc(100vh - 65px);
            position: sticky;
            top: 65px;
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            padding: 0 1.5rem;
            margin-bottom: 0.8rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.9rem 1.5rem;
            color: #64748b;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #f8fafc;
            color: #0f172a;
            padding-left: 1.8rem;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1);
        }

        .nav-item.active {
            background: #f5f7f3;
            color: #3d4f31;
            border-left-color: #3d4f31;
        }

        .nav-item.active .nav-icon {
            stroke: #3d4f31;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            stroke: #94a3b8;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        /* Sidebar Decoration */
        .sidebar-decoration {
            position: absolute;
            bottom: 2rem;
            left: 0;
            right: 0;
            padding: 1.5rem;
            text-align: center;
            border-top: 1px solid #f1f5f9;
        }

        .decoration-icon {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            opacity: 0.6;
        }

        .decoration-text {
            font-size: 0.75rem;
            color: #94a3b8;
            line-height: 1.4;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.3rem;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 0.95rem;
        }

        /* Cards */
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
        }

        .btn-add {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.3rem;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: .2s;
        }

        .btn-add:hover {
            background: #1e293b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* Section Title with Name/Time */
        .section-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            border-radius: 12px;
            color: white;
        }

        .section-title-bar h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .section-title-bar .datetime {
            font-size: 0.85rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Filters Bar */
        .filters-bar {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #64748b;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: #16a34a;
            color: #16a34a;
        }

        .filter-btn.active {
            background: #16a34a;
            border-color: #16a34a;
            color: white;
        }

        .filter-select {
            padding: 0.5rem 2rem 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #0f172a;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3d4f31;
        }

        /* Entries Grid - Tarjetas en cuadr√≠cula */
        .entries-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.2rem;
        }

        .entry-card {
            display: flex;
            flex-direction: column;
            padding: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .entry-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3d4f31, #5a7245);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .entry-card:hover {
            border-color: #3d4f31;
            box-shadow: 0 20px 40px rgba(61, 79, 49, 0.15), 0 8px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-8px) scale(1.02);
        }

        .entry-card:hover::before {
            opacity: 1;
        }

        .entry-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .entry-card-header .color-tag {
            font-size: 0.75rem;
        }

        .entry-card-header .entry-date {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .entry-card-body {
            padding: 1.2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .entry-field {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .entry-field-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
        }

        .entry-field-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #0f172a;
        }

        .entry-field-value.highlight {
            color: #3d4f31;
            font-weight: 600;
        }

        .entry-card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            background: #fafafa;
            border-top: 1px solid #f1f5f9;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        .pagination-btn {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #3d4f31;
            color: #3d4f31;
        }

        .pagination-btn.active {
            background: #3d4f31;
            border-color: #3d4f31;
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0 1rem;
        }

        .color-tag {
            display: inline-block;
            padding: 0.3rem 0.9rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .color-tag.verde {
            background: #e8ede5;
            color: #3d4f31;
        }

        .color-tag.negra {
            background: #1e293b;
            color: #fff;
        }

        .color-tag.mulata {
            background: #f5e6d3;
            color: #8b6914;
        }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .btn-icon.edit:hover {
            background: #4a5c3c;
            border-color: #4a5c3c;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 92, 60, 0.3);
        }

        .btn-icon.delete:hover {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-icon.view:hover {
            background: #3d4f31;
            border-color: #3d4f31;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(61, 79, 49, 0.3);
        }

        /* Delete Confirmation Modal */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .confirm-icon {
            width: 64px;
            height: 64px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.2rem;
        }

        .confirm-icon svg {
            width: 32px;
            height: 32px;
            stroke: #dc2626;
            stroke-width: 2;
            fill: none;
        }

        .confirm-modal h3 {
            font-size: 1.2rem;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .confirm-modal p {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .confirm-actions {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
        }

        .btn-confirm-cancel {
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.15s;
        }

        .btn-confirm-cancel:hover {
            background: #f8fafc;
        }

        .btn-confirm-delete {
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            border: none;
            background: #dc2626;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.15s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-confirm-delete:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .btn-confirm-delete svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .no-entries {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .no-entries-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Section containers */
        .section-container {
            display: none;
        }

        .section-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Empty Section */
        .empty-section {
            text-align: center;
            padding: 4rem 2rem;
            color: #94a3b8;
        }

        .empty-section .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.4;
        }

        .empty-section h3 {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 950px;
            margin: 2rem 0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.3rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .btn-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .15s;
        }

        .btn-close:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 65vh;
            overflow-y: auto;
        }

        /* Form */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #16a34a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dcfce7;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .form-label {
            font-size: 0.82rem;
            color: #475569;
            font-weight: 500;
        }

        .form-input,
        .form-select {
            padding: 0.7rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            color: #0f172a;
            font-size: 0.9rem;
            font-family: inherit;
            transition: .15s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
            background: white;
        }

        .form-input::placeholder {
            color: #94a3b8;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Color Selection */
        .color-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .color-option {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            padding: 1.3rem;
            cursor: pointer;
            transition: .2s;
            text-align: center;
        }

        .color-option:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }

        .color-option.selected {
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .color-option .color-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 0.7rem;
        }

        .color-option[data-color="verde"] .color-icon {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .color-option[data-color="negra"] .color-icon {
            background: linear-gradient(135deg, #64748b, #475569);
        }

        .color-option[data-color="mulata"] .color-icon {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }

        .color-option .color-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
        }

        /* Variety Selection */
        .variety-section {
            display: none;
            margin-top: 1.2rem;
        }

        .variety-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .variety-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.7rem;
        }

        .variety-option {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.9rem;
            cursor: pointer;
            transition: .15s;
            text-align: center;
            font-weight: 500;
            font-size: 0.85rem;
            color: #64748b;
        }

        .variety-option:hover {
            border-color: #16a34a;
            color: #0f172a;
        }

        .variety-option.selected {
            border-color: #16a34a;
            background: #f0fdf4;
            color: #16a34a;
        }

        /* Process Section */
        .process-section {
            display: none;
            margin-top: 1.2rem;
            padding: 1.2rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .process-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .process-title {
            font-size: 0.85rem;
            color: #16a34a;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .process-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }

        .process-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            color: #64748b;
            cursor: pointer;
            transition: .15s;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .process-btn:hover {
            border-color: #16a34a;
            color: #0f172a;
        }

        .process-btn.selected {
            border-color: #0ea5e9;
            background: #f0f9ff;
            color: #0ea5e9;
        }

        /* Subprocess */
        .subprocess-section {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            border: 1px dashed #cbd5e1;
        }

        .subprocess-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Calibration */
        .calibration-section {
            display: none;
            margin-top: 1.2rem;
            padding: 1.2rem;
            background: #f0fdf4;
            border-radius: 12px;
            border: 1px solid #bbf7d0;
        }

        .calibration-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .calibration-title {
            font-size: 0.9rem;
            color: #16a34a;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .destination-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
        }

        .destination-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: .15s;
            text-align: center;
        }

        .destination-btn:hover {
            border-color: #16a34a;
        }

        .destination-btn.selected {
            border-color: #16a34a;
            background: #dcfce7;
        }

        .destination-btn .dest-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }

        .destination-btn .dest-name {
            font-weight: 500;
            font-size: 0.85rem;
            color: #0f172a;
        }

        .caliber-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            gap: 0.5rem;
        }

        .caliber-option {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.6rem;
            cursor: pointer;
            transition: .15s;
            text-align: center;
            font-weight: 500;
            font-size: 0.8rem;
            color: #64748b;
        }

        .caliber-option:hover {
            border-color: #16a34a;
        }

        .caliber-option.selected {
            border-color: #16a34a;
            background: #dcfce7;
            color: #16a34a;
        }

        /* Envase Section */
        .envase-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .envase-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
        }

        .envase-header {
            font-weight: 600;
            font-size: 0.95rem;
            color: #0f172a;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #16a34a;
        }

        .envase-fields {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .envase-fields .form-group {
            flex: 1;
            min-width: 80px;
        }

        .envase-subtotal {
            font-weight: 600;
            color: #16a34a;
            font-size: 0.9rem;
            padding: 0.5rem;
            background: #f0fdf4;
            border-radius: 6px;
            white-space: nowrap;
        }

        .total-kg-display {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .total-kg-display strong {
            font-size: 1.3rem;
            color: #4ade80;
        }

        /* Caliber Input */
        .caliber-grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.8rem;
        }

        .caliber-input-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.6rem;
            text-align: center;
        }

        .caliber-input-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.4rem;
        }

        .caliber-input-item input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
        }

        .caliber-input-item input:focus {
            border-color: #16a34a;
            outline: none;
        }

        .caliber-input-item.variety-item {
            background: #fef3c7;
            border-color: #fcd34d;
        }

        .caliber-input-item.variety-item label {
            color: #92400e;
        }

        /* ========== ALMAC√âN STYLES ========== */
        .almacen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            flex: 1;
            padding: 0.7rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .search-box input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-search {
            padding: 0.7rem 1.2rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-search:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .almacen-actions {
            display: flex;
            gap: 0.8rem;
        }

        .btn-ferreteria {
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-ferreteria:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .btn-salida {
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-salida:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        /* Cuadrantes Grid */
        .cuadrantes-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .cuadrante-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cuadrante-row-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            padding: 0.5rem 1rem;
            background: linear-gradient(90deg, #f1f5f9, transparent);
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }

        .cuadrante-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .cuadrante-cell {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 120px;
        }

        .cuadrante-cell:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .cuadrante-cell.occupied {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: #16a34a;
        }

        .cuadrante-cell.empty {
            background: #f8fafc;
            border-style: dashed;
        }

        .cuadrante-id {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .cuadrante-info {
            font-size: 0.75rem;
            color: #64748b;
        }

        .cuadrante-info .tag {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-right: 0.3rem;
            margin-bottom: 0.3rem;
        }

        .tag.fibra {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .tag.bidon {
            background: #fef3c7;
            color: #92400e;
        }

        .tag.verde {
            background: #dcfce7;
            color: #16a34a;
        }

        .tag.negra {
            background: #1e293b;
            color: white;
        }

        .tag.mulata {
            background: #a78bfa;
            color: white;
        }

        /* Salida Modal Options */
        .salida-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .salida-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .salida-option:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .salida-option.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
        }

        .salida-option-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .salida-option-title {
            font-weight: 600;
            color: #1e293b;
        }

        .salida-option-desc {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        /* Venta Type Buttons */
        .venta-type-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .venta-type-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .venta-type-btn:hover {
            border-color: #16a34a;
        }

        .venta-type-btn.selected {
            border-color: #16a34a;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #16a34a;
        }

        /* Modal Footer */
        .modal-footer {
            padding: 1.2rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: .15s;
            border: none;
        }

        .btn-cancel {
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }

        .btn-cancel:hover {
            background: #f8fafc;
        }

        .btn-save {
            background: #0f172a;
            color: white;
        }

        .btn-save:hover {
            background: #1e293b;
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .content {
                padding: 1rem;
            }

            .color-selection {
                grid-template-columns: 1fr;
            }

            .destination-options {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 0.8rem 1rem;
            }

            .entries-list {
                grid-template-columns: 1fr;
            }

            .section-title-bar {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-btn {
                text-align: center;
            }

            .pagination-container {
                flex-wrap: wrap;
            }

            .pagination-btn {
                min-width: 36px;
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .entry-card-body {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <div class="brand-dot"></div>
            <span>Corporaci√≥n Costa Verde</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span class="user-name" id="userName">Administrador</span>
                <span class="user-role">Admin</span>
            </div>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="nav-section-title">Men√∫ Principal</div>
            <div class="nav-item active" data-section="entrada" onclick="showSection('entrada')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                    <circle cx="12" cy="12" r="4"></circle>
                    <path d="M12 8v-2M12 18v-2M8 12H6M18 12h-2"></path>
                </svg>
                Entrada de Aceituna
            </div>
            <div class="nav-item" data-section="almacen" onclick="showSection('almacen')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18"></path>
                    <path d="M5 21V7l7-4 7 4v14"></path>
                    <path d="M9 21v-6h6v6"></path>
                    <path d="M9 9h6"></path>
                    <path d="M9 12h6"></path>
                </svg>
                Almac√©n
            </div>
            <div class="nav-item" data-section="salida" onclick="showSection('salida')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Salida
            </div>
            <div class="nav-item" data-section="reportes" onclick="showSection('reportes')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                Reportes
            </div>
            <div class="nav-item" data-section="record" onclick="showSection('record')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Record Hist√≥rico
            </div>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Entrada de Aceituna Section -->
            <div class="section-container active" id="section-entrada">
                <div class="page-header">
                    <h1 class="page-title">Entrada de Aceituna</h1>
                    <p class="page-subtitle">Gesti√≥n de compras y registro de aceituna</p>
                </div>

                <div class="card">
                    <!-- Title Bar with Username and Datetime -->
                    <div class="section-title-bar">
                        <h2 id="titleBarName">Bienvenido, Usuario</h2>
                        <div class="datetime" id="titleBarDatetime">
                            <span id="currentDate">--</span>
                            <span>|</span>
                            <span id="currentTime">--:--</span>
                        </div>
                    </div>

                    <div class="card-header">
                        <h3 class="card-title">Compras Registradas</h3>
                        <button class="btn-add" onclick="openModal()">
                            <span>+</span> A√±adir Compra
                        </button>
                    </div>

                    <!-- Filters Bar -->
                    <div class="filters-bar">
                        <span class="filter-label">Ordenar por:</span>
                        <button class="filter-btn active" onclick="sortEntries('newest')" data-sort="newest">M√°s
                            Recientes</button>
                        <button class="filter-btn" onclick="sortEntries('oldest')" data-sort="oldest">M√°s
                            Antiguos</button>
                        <select class="filter-select" onchange="sortEntries(this.value)">
                            <option value="">Precio</option>
                            <option value="price-high">Precio: Mayor a Menor</option>
                            <option value="price-low">Precio: Menor a Mayor</option>
                        </select>
                        <select class="filter-select" onchange="sortEntries(this.value)">
                            <option value="">Peso</option>
                            <option value="weight-high">Peso: Mayor a Menor</option>
                            <option value="weight-low">Peso: Menor a Mayor</option>
                        </select>
                    </div>

                    <div class="entries-list" id="entriesList">
                        <div class="no-entries">
                            <div class="no-entries-icon">üì≠</div>
                            <p>No hay compras registradas a√∫n</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container" id="paginationContainer">
                        <!-- Pagination buttons will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Almac√©n Section -->
            <div class="section-container" id="section-almacen">
                <!-- Pantalla de Selecci√≥n de Almac√©n -->
                <div id="almacenSeleccion" style="display: block;">
                    <div class="page-header" style="text-align: center; margin-bottom: 2rem;">
                        <h1 class="page-title">Almac√©n</h1>
                        <p class="page-subtitle">Seleccione el tipo de almac√©n que desea gestionar</p>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 1rem; min-height: 60vh;">
                        <!-- Almac√©n de Insumos -->
                        <div onclick="mostrarAlmacenInsumos()" style="background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 50%, #38bdf8 100%); 
                                   border-radius: 24px; 
                                   padding: 3rem; 
                                   display: flex; 
                                   flex-direction: column; 
                                   justify-content: center; 
                                   align-items: center; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   box-shadow: 0 10px 40px rgba(3, 105, 161, 0.3);
                                   border: 3px solid transparent;"
                            onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 20px 60px rgba(3, 105, 161, 0.4)';"
                            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 40px rgba(3, 105, 161, 0.3)';">
                            <div style="font-size: 5rem; margin-bottom: 1.5rem;">üì¶</div>
                            <h2
                                style="color: white; font-size: 2rem; margin-bottom: 1rem; font-weight: 700; text-align: center;">
                                Almac√©n de Insumos</h2>
                            <p
                                style="color: rgba(255,255,255,0.9); font-size: 1.1rem; text-align: center; max-width: 300px;">
                                Gesti√≥n de insumos para la producci√≥n: salmuera, qu√≠micos, materiales y m√°s.
                            </p>
                            <div
                                style="margin-top: 2rem; background: rgba(255,255,255,0.2); padding: 0.8rem 2rem; border-radius: 30px; color: white; font-weight: 600;">
                                Ingresar ‚Üí
                            </div>
                        </div>

                        <!-- Almac√©n de Aceitunas -->
                        <div onclick="mostrarAlmacenAceitunas()" style="background: linear-gradient(135deg, #3d4f31 0%, #4a5c3c 50%, #5a6e4a 100%); 
                                   border-radius: 24px; 
                                   padding: 3rem; 
                                   display: flex; 
                                   flex-direction: column; 
                                   justify-content: center; 
                                   align-items: center; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   box-shadow: 0 10px 40px rgba(61, 79, 49, 0.3);
                                   border: 3px solid transparent;"
                            onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 20px 60px rgba(61, 79, 49, 0.4)';"
                            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 40px rgba(61, 79, 49, 0.3)';">
                            <div style="font-size: 5rem; margin-bottom: 1.5rem;">ü´í</div>
                            <h2
                                style="color: white; font-size: 2rem; margin-bottom: 1rem; font-weight: 700; text-align: center;">
                                Almac√©n de Aceitunas</h2>
                            <p
                                style="color: rgba(255,255,255,0.9); font-size: 1.1rem; text-align: center; max-width: 300px;">
                                Control de inventario, cuadrantes y ubicaciones de stock de aceitunas.
                            </p>
                            <div
                                style="margin-top: 2rem; background: rgba(255,255,255,0.2); padding: 0.8rem 2rem; border-radius: 30px; color: white; font-weight: 600;">
                                Ingresar ‚Üí
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Almac√©n de Insumos -->
                <div id="almacenInsumosContent" style="display: none;">
                    <div class="page-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" style="color: #0369a1;">Almac√©n de Insumos</h1>
                            <p class="page-subtitle">Control de stock de insumos para la producci√≥n</p>
                        </div>
                        <button onclick="volverAlmacenSeleccion()"
                            style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            ‚Üê Volver
                        </button>
                    </div>

                    <div class="card">
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #0369a1; font-size: 1.1rem; margin-bottom: 0.5rem;">Stock de Insumos de
                                Salmuera</h3>
                            <p style="color: #64748b; font-size: 0.85rem;">Ingrese o retire productos del inventario</p>
                        </div>

                        <!-- Tabla de Stock de Insumos -->
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"
                                id="stockInsumosTable">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #0369a1, #0ea5e9);">
                                        <th
                                            style="padding: 1rem; text-align: left; color: white; font-weight: 600; width: 25%;">
                                            Insumo</th>
                                        <th
                                            style="padding: 1rem; text-align: center; color: white; font-weight: 600; width: 15%;">
                                            Unidad</th>
                                        <th
                                            style="padding: 1rem; text-align: center; color: white; font-weight: 600; width: 20%;">
                                            Stock Actual</th>
                                        <th
                                            style="padding: 1rem; text-align: center; color: white; font-weight: 600; width: 40%;">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="stockInsumosBody">
                                    <!-- Agua -->
                                    <tr style="background: #e0f2fe; border-bottom: 2px solid #7dd3fc;">
                                        <td style="padding: 0.8rem; font-weight: 600; color: #0369a1;">Agua</td>
                                        <td style="padding: 0.8rem; text-align: center;">m¬≥</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockAgua"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantAgua" placeholder="Cant." step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('Agua', 'm¬≥')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('Agua', 'm¬≥')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Sorbato de Potasio -->
                                    <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">Sorbato de
                                            Potasio</td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockSorbatoPotasio"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantSorbatoPotasio" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('SorbatoPotasio', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('SorbatoPotasio', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- √Åcido L√°ctico -->
                                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">√Åcido L√°ctico
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Lt</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockAcidoLactico"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantAcidoLactico" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('AcidoLactico', 'Lt')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('AcidoLactico', 'Lt')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- √Åcido C√≠trico -->
                                    <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">√Åcido C√≠trico
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockAcidoCitrico"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantAcidoCitrico" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('AcidoCitrico', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('AcidoCitrico', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Calcio -->
                                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">Calcio</td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockCalcio"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantCalcio" placeholder="Cant." step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('Calcio', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('Calcio', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- √Åcido Ac√©tico -->
                                    <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">√Åcido Ac√©tico
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Lt</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockAcidoAcetico"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantAcidoAcetico" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('AcidoAcetico', 'Lt')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('AcidoAcetico', 'Lt')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- √Åcido Asc√≥rbico -->
                                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">√Åcido Asc√≥rbico
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockAcidoAscorbico"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantAcidoAscorbico" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('AcidoAscorbico', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('AcidoAscorbico', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Benzoato de Potasio -->
                                    <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">Benzoato de
                                            Potasio</td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockBenzoatoPotasio"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantBenzoatoPotasio" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('BenzoatoPotasio', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('BenzoatoPotasio', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Sal Industrial -->
                                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 0.8rem; font-weight: 500; color: #1e293b;">Sal Industrial
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Kg</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockSalIndustrial"
                                                style="font-size: 1.2rem; font-weight: 700; color: #0369a1;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantSalIndustrial" placeholder="Cant."
                                                    step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('SalIndustrial', 'Kg')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('SalIndustrial', 'Kg')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Otros Insumos -->
                                    <tr style="background: #fef3c7; border-bottom: 2px solid #fbbf24;">
                                        <td style="padding: 0.8rem; font-weight: 600; color: #92400e;">Otros Insumos
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">Unidad</td>
                                        <td style="padding: 0.8rem; text-align: center;"><span id="stockOtros"
                                                style="font-size: 1.2rem; font-weight: 700; color: #92400e;">0</span>
                                        </td>
                                        <td style="padding: 0.8rem; text-align: center;">
                                            <div
                                                style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                                <input type="number" id="cantOtros" placeholder="Cant." step="0.01"
                                                    style="width: 80px; padding: 0.4rem; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                                                <button onclick="ingresarStock('Otros', 'Unidad')"
                                                    style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">+
                                                    Ingresar</button>
                                                <button onclick="sacarStock('Otros', 'Unidad')"
                                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500;">-
                                                    Sacar</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Historial de Movimientos -->
                        <div style="margin-top: 2rem;">
                            <h4 style="color: #64748b; font-size: 0.95rem; margin-bottom: 1rem;">Historial de
                                Movimientos (√∫ltimos 10)</h4>
                            <div id="historialMovimientos" style="max-height: 200px; overflow-y: auto;">
                                <p style="color: #94a3b8; text-align: center; padding: 1rem;">No hay movimientos
                                    registrados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Almac√©n de Aceitunas (original) -->
                <div id="almacenAceitunasContent" style="display: none;">
                    <div class="page-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" style="color: #3d4f31;">ü´í Almac√©n de Aceitunas</h1>
                            <p class="page-subtitle">Control de inventario y ubicaciones de stock</p>
                        </div>
                        <div style="display: flex; gap: 0.8rem;">
                            <button onclick="abrirReubicacionDesdeAlmacen()"
                                style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
                                üîÑ Reubicaci√≥n
                            </button>
                            <button onclick="volverAlmacenSeleccion()"
                                style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                ‚Üê Volver
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="almacen-header"
                            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="search-box" style="display: flex; gap: 0.5rem; flex: 1; min-width: 250px;">
                                <input type="text" id="searchCodigo" class="form-input"
                                    placeholder="Buscar lote o calibre..." style="flex: 1;">
                                <button class="btn-search" onclick="buscarEnAlmacen()"
                                    style="background: #3d4f31; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500;">üîç
                                    Buscar</button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="abrirModalNuevaFila()"
                                    style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    ‚ûï Nueva Fila
                                </button>
                            </div>
                        </div>

                        <!-- Contenedor din√°mico de filas -->
                        <div id="filasAlmacenContainer" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- Las filas se renderizan din√°micamente aqu√≠ -->
                            <div id="sinFilas" style="text-align: center; padding: 3rem; color: #94a3b8;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No hay filas en el almac√©n</p>
                                <p style="font-size: 0.9rem;">Haz clic en "Nueva Fila" para comenzar a organizar tu
                                    almac√©n</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reportes Section -->
            <div class="section-container" id="section-reportes">
                <div class="page-header">
                    <h1 class="page-title">Reportes de Compra</h1>
                    <p class="page-subtitle">An√°lisis y exportaci√≥n de datos de compras</p>
                </div>

                <div class="card">
                    <!-- Filtros de Reportes -->
                    <div
                        style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <div style="flex: 1; min-width: 150px;">
                            <label
                                style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 600;">Per√≠odo</label>
                            <select class="form-select" id="reportePeriodo" onchange="filtrarReportes()">
                                <option value="all">Todos</option>
                                <option value="today">Hoy</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mes</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px; display: none;" id="fechaInicioContainer">
                            <label
                                style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 600;">Desde</label>
                            <input type="date" class="form-input" id="reporteFechaInicio" onchange="filtrarReportes()">
                        </div>
                        <div style="flex: 1; min-width: 150px; display: none;" id="fechaFinContainer">
                            <label
                                style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 600;">Hasta</label>
                            <input type="date" class="form-input" id="reporteFechaFin" onchange="filtrarReportes()">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label
                                style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 600;">C√≥digo
                                de Lote</label>
                            <select class="form-select" id="reporteLote" onchange="filtrarReportes()">
                                <option value="">Todos los Lotes</option>
                                <!-- Se llenar√° din√°micamente -->
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label
                                style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 600;">Tipo
                                de Envase</label>
                            <select class="form-select" id="reporteTipoEnvase" onchange="filtrarReportes()">
                                <option value="">Todos</option>
                                <option value="margaritos">Margaritos</option>
                                <option value="chavitos">Chavitos</option>
                                <option value="bidones">Bidones de Exportaci√≥n</option>
                                <option value="tarzas">Tarzas</option>
                            </select>
                        </div>
                        <button class="btn-add" onclick="exportarReporteExcel()" style="height: 42px;">
                            Exportar Todo
                        </button>
                        <button class="btn-add" onclick="exportarLoteExcel()"
                            style="height: 42px; background: linear-gradient(135deg, #475569, #334155);">
                            Exportar Lote
                        </button>
                        <button id="btnSimularVenta" class="btn-add" onclick="toggleSimularVenta()"
                            style="height: 42px; background: linear-gradient(135deg, #059669, #10b981);">
                            üí∞ Simular Venta
                        </button>
                        <button class="btn-add" onclick="mostrarFormulas()"
                            style="height: 42px; background: linear-gradient(135deg, #6366f1, #8b5cf6);"
                            title="Ver F√≥rmulas">
                            üìñ F√≥rmulas
                        </button>
                    </div>

                    <!-- Panel de llenado r√°pido (visible solo en modo simulaci√≥n) -->
                    <div id="panelLlenadoRapido"
                        style="display: none; background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #10b981;">
                        <h4 style="color: #059669; margin: 0 0 0.8rem 0; font-size: 0.9rem;">‚ö° Llenado R√°pido de Precios
                            de Venta</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                            <!-- Opci√≥n: Llenar todos con un valor -->
                            <div style="flex: 1; min-width: 200px;">
                                <label
                                    style="display: block; font-size: 0.75rem; color: #065f46; margin-bottom: 0.3rem;">Llenar
                                    TODOS con:</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="precioLlenadoTodos" placeholder="0.00" step="0.01" min="0"
                                        style="flex: 1; padding: 0.5rem; border: 1px solid #10b981; border-radius: 6px; font-size: 0.85rem;">
                                    <button onclick="llenarTodosPrecios()"
                                        style="padding: 0.5rem 1rem; background: #059669; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                            <!-- Opci√≥n: Llenar por rango -->
                            <div style="flex: 1; min-width: 280px;">
                                <label
                                    style="display: block; font-size: 0.75rem; color: #065f46; margin-bottom: 0.3rem;">Llenar
                                    por RANGO (desde - hasta):</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="number" id="precioDesde" placeholder="Desde" step="0.01" min="0"
                                        style="width: 70px; padding: 0.5rem; border: 1px solid #10b981; border-radius: 6px; font-size: 0.85rem;">
                                    <span style="color: #059669;">‚Üí</span>
                                    <input type="number" id="precioHasta" placeholder="Hasta" step="0.01" min="0"
                                        style="width: 70px; padding: 0.5rem; border: 1px solid #10b981; border-radius: 6px; font-size: 0.85rem;">
                                    <button onclick="llenarPreciosPorRango()"
                                        style="padding: 0.5rem 1rem; background: #059669; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                            <!-- Bot√≥n limpiar -->
                            <button onclick="limpiarTodosPrecios()"
                                style="padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                üóëÔ∏è Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Resumen de totales - Simplificado -->
                    <div style="margin-bottom: 1.5rem;">
                        <!-- Fila 1: M√©tricas principales -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div
                                style="background: linear-gradient(135deg, #1e293b, #334155); padding: 1rem; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase;">Total
                                    Registros</div>
                                <div id="totalRegistros" style="font-size: 1.5rem; font-weight: 700; color: #fff;">0
                                </div>
                            </div>
                            <div
                                style="background: linear-gradient(135deg, #3d4f31, #5a7247); padding: 1rem; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #bbf7d0; text-transform: uppercase;">Total Kilos
                                </div>
                                <div id="totalKilosReporte" style="font-size: 1.5rem; font-weight: 700; color: #fff;">0
                                    Kg</div>
                            </div>
                            <div id="valorCalibresCard"
                                style="background: linear-gradient(135deg, #4a5a3d, #6b7d56); padding: 1rem; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #d9f99d; text-transform: uppercase;">Valor Total
                                    de los Calibres</div>
                                <div id="totalValorCalibres" style="font-size: 1.5rem; font-weight: 700; color: #fff;">
                                    S/0</div>
                            </div>
                        </div>

                        <!-- Campos ocultos para c√°lculos -->
                        <span id="costoCompra" style="display: none;">S/0</span>
                        <span id="costoPersonalTotal" style="display: none;">S/0</span>
                        <span id="costoVarones" style="display: none;">S/0</span>
                        <span id="costoMujeres" style="display: none;">S/0</span>
                        <span id="costoTransporteTotal" style="display: none;">S/0</span>
                        <span id="totalCostosOperativos" style="display: none;">S/0</span>
                        <input type="hidden" id="otrosGastosReporte" value="0">
                        <!-- Elementos ocultos para mantener compatibilidad -->
                        <span id="precioVentaSimulador" style="display: none;">0</span>
                        <span id="ingresoVentaSimulador" style="display: none;">S/0.00</span>
                        <span id="costosTotalesSimulador" style="display: none;">S/0.00</span>
                        <span id="gananciaSimulador" style="display: none;">S/0.00</span>
                        <span id="gananciaSimuladorCard" style="display: none;"></span>
                    </div>

                    <!-- Tabla de Reportes tipo Excel -->
                    <div style="overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 10px;">
                        <table id="reporteTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: #0f172a; color: white;">
                                    <th
                                        style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap;">
                                        Fecha</th>
                                    <th
                                        style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap;">
                                        Lote</th>
                                    <th
                                        style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap;">
                                        Vendedor</th>
                                    <th
                                        style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap;">
                                        Supervisor</th>
                                    <th
                                        style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Envase</th>
                                    <th
                                        style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Calibre</th>
                                    <th id="thCompraCol"
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Precio Compra</th>
                                    <th
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Bidones</th>
                                    <th
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Kg/Bid</th>
                                    <th
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Sobras</th>
                                    <th
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem; font-weight: 700;">
                                        Subtotal Kg</th>
                                    <th id="thValorCalibre"
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Valor Compra</th>
                                    <th id="thVentaCol"
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Precio Venta</th>
                                    <th id="thGastosOpCol"
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem;">
                                        Gastos Op.</th>
                                    <th id="thGananciaCol"
                                        style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #3d4f31; white-space: nowrap; font-size: 0.8rem; font-weight: 700;">
                                        Gan. Netas</th>
                                </tr>
                            </thead>
                            <tbody id="reporteTableBody">
                                <!-- Data will be rendered here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="noReportesMessage"
                        style="display: none; text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">--</div>
                        <p>No hay datos para mostrar con los filtros seleccionados</p>
                    </div>
                </div>
            </div>

            <!-- Record Hist√≥rico Section -->
            <div class="section-container" id="section-record">
                <div class="page-header">
                    <h1 class="page-title">üìä Record Hist√≥rico de Ventas</h1>
                    <p class="page-subtitle">An√°lisis estad√≠stico de ventas por mes y a√±o con m√©tricas de ganancias</p>
                </div>

                <!-- Filtro de A√±o -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label style="font-weight: 600; color: #1e293b;">Seleccionar A√±o:</label>
                            <select id="recordAnoSelect" class="form-select" onchange="renderRecordHistorico()"
                                style="min-width: 120px;">
                                <!-- Se llenar√° din√°micamente -->
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="exportarRecordPDF()"
                                style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                üìÑ Exportar PDF
                            </button>
                            <button onclick="exportarRecordExcel()"
                                style="background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                üìä Exportar Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resumen Anual -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card"
                        style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="recordTotalVentas">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Ventas Realizadas</div>
                    </div>
                    <div class="card"
                        style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="recordTotalKg">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Kg Totales Vendidos</div>
                    </div>
                    <div class="card"
                        style="background: linear-gradient(135deg, #16a34a, #22c55e); color: white; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="recordTotalIngresos">S/0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Ingresos Totales</div>
                    </div>
                    <div class="card"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="recordPromedioMes">S/0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Promedio Mensual</div>
                    </div>
                </div>

                <!-- Gr√°fico de Barras Mensual -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                        üìà Ventas por Mes
                        <span style="font-size: 0.8rem; color: #64748b; font-weight: 400;">(Kg vendidos)</span>
                    </h3>
                    <div id="recordGraficoBarras"
                        style="display: flex; align-items: flex-end; gap: 0.5rem; height: 280px; padding: 1rem 0; border-bottom: 2px solid #e2e8f0;">
                        <!-- Las barras del gr√°fico se generar√°n din√°micamente -->
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 0.8rem; font-size: 0.75rem; color: #64748b;">
                        <span>Ene</span><span>Feb</span><span>Mar</span><span>Abr</span><span>May</span><span>Jun</span>
                        <span>Jul</span><span>Ago</span><span>Sep</span><span>Oct</span><span>Nov</span><span>Dic</span>
                    </div>
                </div>

                <!-- Gr√°fico de L√≠nea de Ganancias -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                        üí∞ Ingresos por Mes
                        <span style="font-size: 0.8rem; color: #64748b; font-weight: 400;">(en Soles)</span>
                    </h3>
                    <div id="recordGraficoGanancias"
                        style="display: flex; align-items: flex-end; gap: 0.5rem; height: 220px; padding: 1rem 0; border-bottom: 2px solid #e2e8f0;">
                        <!-- Las barras de ganancias se generar√°n din√°micamente -->
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 0.8rem; font-size: 0.75rem; color: #64748b;">
                        <span>Ene</span><span>Feb</span><span>Mar</span><span>Abr</span><span>May</span><span>Jun</span>
                        <span>Jul</span><span>Ago</span><span>Sep</span><span>Oct</span><span>Nov</span><span>Dic</span>
                    </div>
                </div>

                <!-- Tabla de Resumen Mensual -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">üìã Resumen Mensual Detallado</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1e293b, #334155);">
                                    <th
                                        style="padding: 0.8rem; text-align: left; color: white; border-radius: 8px 0 0 0;">
                                        Mes</th>
                                    <th style="padding: 0.8rem; text-align: center; color: white;">N¬∞ Ventas</th>
                                    <th style="padding: 0.8rem; text-align: center; color: white;">Exportaci√≥n</th>
                                    <th style="padding: 0.8rem; text-align: center; color: white;">Nacional</th>
                                    <th style="padding: 0.8rem; text-align: right; color: white;">Kg Vendidos</th>
                                    <th style="padding: 0.8rem; text-align: right; color: white;">Ingresos</th>
                                    <th
                                        style="padding: 0.8rem; text-align: center; color: white; border-radius: 0 8px 0 0;">
                                        Tendencia</th>
                                </tr>
                            </thead>
                            <tbody id="recordTablaBody">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noRecordMessage" style="display: none; text-align: center; padding: 3rem; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>No hay ventas registradas para el a√±o seleccionado</p>
                    </div>
                </div>
            </div>

            <!-- Salida Modal -->
            <div class="modal-overlay" id="salidaModalOverlay">
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <h2>üì§ Salida de Almac√©n</h2>
                        <button class="btn-close" onclick="closeSalidaModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="salida-options">
                            <div class="salida-option" data-tipo="venta" onclick="selectSalidaTipo('venta')">
                                <div class="salida-option-icon">üí∞</div>
                                <div class="salida-option-title">Venta</div>
                                <div class="salida-option-desc">Nacional o Exportaci√≥n</div>
                            </div>
                            <div class="salida-option" data-tipo="prestamo" onclick="selectSalidaTipo('prestamo')">
                                <div class="salida-option-icon">üîÑ</div>
                                <div class="salida-option-title">Pr√©stamo Bidones</div>
                                <div class="salida-option-desc">Origen y destino</div>
                            </div>
                            <div class="salida-option" data-tipo="reubicacion"
                                onclick="selectSalidaTipo('reubicacion')">
                                <div class="salida-option-icon">ÔøΩ</div>
                                <div class="salida-option-title">Reubicaci√≥n</div>
                                <div class="salida-option-desc">Mover a otro cuadrante</div>
                            </div>
                        </div>

                        <!-- Venta Form -->
                        <div class="salida-form" id="ventaForm" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Tipo de Venta</h4>
                            <div class="venta-type-options">
                                <div class="venta-type-btn" data-venta="nacional" onclick="selectVentaTipo('nacional')">
                                    üáµüá™ Nacional
                                </div>
                                <div class="venta-type-btn" data-venta="exportacion"
                                    onclick="selectVentaTipo('exportacion')">
                                    üåç Exportaci√≥n
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Cliente</label>
                                    <input type="text" class="form-input" id="ventaCliente"
                                        placeholder="Nombre del cliente">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-input" id="ventaFecha">
                                </div>
                            </div>
                            <!-- Exportaci√≥n fields -->
                            <div id="exportacionFields" style="display: none; margin-top: 1rem;">
                                <div class="form-section"
                                    style="background: #eff6ff; padding: 1rem; border-radius: 10px;">
                                    <h5 style="color: #1d4ed8; margin-bottom: 0.8rem;">Datos de Exportaci√≥n</h5>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Empresa Exportadora (Origen)</label>
                                            <input type="text" class="form-input" id="empresaExportadora"
                                                placeholder="Nombre">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha Origen</label>
                                            <input type="date" class="form-input" id="fechaOrigen">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Empresa Importadora (Destino)</label>
                                            <input type="text" class="form-input" id="empresaImportadora"
                                                placeholder="Nombre">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha Destino</label>
                                            <input type="date" class="form-input" id="fechaDestino">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pr√©stamo Form -->
                        <div class="salida-form" id="prestamoForm" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Pr√©stamo de Bidones</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Origen</label>
                                    <input type="text" class="form-input" id="prestamoOrigen"
                                        placeholder="Lugar de origen">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Destino</label>
                                    <input type="text" class="form-input" id="prestamoDestino"
                                        placeholder="Lugar de destino">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Responsable</label>
                                    <input type="text" class="form-input" id="prestamoResponsable"
                                        placeholder="Nombre del responsable">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-input" id="prestamoFecha">
                                </div>
                            </div>
                        </div>

                        <!-- Reubicaci√≥n Form -->
                        <div class="salida-form" id="reubicacionForm" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Reubicaci√≥n de Bidones</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Cuadrante Origen</label>
                                    <select class="form-select" id="reubicacionOrigen">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Destino</label>
                                    <select class="form-select" id="reubicacionDestino">
                                        <option value="">Seleccionar...</option>
                                        <option value="ferreteria">üîß Ferreter√≠a</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cantidad de Bidones</label>
                                    <input type="number" class="form-input" id="reubicacionCantidad" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-input" id="reubicacionFecha">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel" onclick="closeSalidaModal()">Cancelar</button>
                        <button class="btn btn-save" onclick="guardarSalida()">Guardar Salida</button>
                    </div>
                </div>
            </div>

            <!-- Cuadrante Detail Modal -->
            <div class="modal-overlay" id="cuadranteModalOverlay">
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                        <h2 id="cuadranteModalTitle">Cuadrante A-1</h2>
                        <button class="btn-close" onclick="closeCuadranteModal()">√ó</button>
                    </div>
                    <div class="modal-body" id="cuadranteModalContent">
                        <!-- Content loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel" onclick="closeCuadranteModal()">Cerrar</button>
                    </div>
                </div>
            </div>

            <!-- Salida Section -->
            <div class="section-container" id="section-salida">
                <!-- Pantalla de Selecci√≥n de Tipo de Salida -->
                <div id="salidaSeleccion" style="display: block;">
                    <div class="page-header" style="text-align: center; margin-bottom: 2rem;">
                        <h1 class="page-title">Salida de Productos</h1>
                        <p class="page-subtitle">Seleccione el tipo de salida que desea registrar</p>
                    </div>

                    <div
                        style="display: flex; justify-content: center; gap: 2rem; padding: 1rem; min-height: 40vh; flex-wrap: wrap;">
                        <!-- Ventas -->
                        <div onclick="mostrarSalidaVentas()" style="background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #4ade80 100%); 
                                   border-radius: 24px; 
                                   padding: 3rem 3rem; 
                                   display: flex; 
                                   flex-direction: column; 
                                   justify-content: center; 
                                   align-items: center; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   box-shadow: 0 10px 40px rgba(22, 163, 74, 0.3);
                                   border: 3px solid transparent;
                                   max-width: 340px;
                                   width: 100%;"
                            onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 20px 60px rgba(22, 163, 74, 0.4)';"
                            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 40px rgba(22, 163, 74, 0.3)';">
                            <div style="font-size: 4rem; margin-bottom: 1.5rem;">üí∞</div>
                            <h2
                                style="color: white; font-size: 1.8rem; margin-bottom: 1rem; font-weight: 700; text-align: center;">
                                Ventas</h2>
                            <p
                                style="color: rgba(255,255,255,0.9); font-size: 1rem; text-align: center; max-width: 280px;">
                                Exportaci√≥n o Mercado Nacional
                            </p>
                            <div
                                style="margin-top: 1.5rem; background: rgba(255,255,255,0.2); padding: 0.8rem 2rem; border-radius: 30px; color: white; font-weight: 600;">
                                Registrar Venta ‚Üí
                            </div>
                        </div>

                        <!-- Pr√©stamos -->
                        <div onclick="mostrarSalidaPrestamos()" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%); 
                                   border-radius: 24px; 
                                   padding: 3rem 3rem; 
                                   display: flex; 
                                   flex-direction: column; 
                                   justify-content: center; 
                                   align-items: center; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3);
                                   border: 3px solid transparent;
                                   max-width: 340px;
                                   width: 100%;"
                            onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 20px 60px rgba(245, 158, 11, 0.4)';"
                            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 40px rgba(245, 158, 11, 0.3)';">
                            <div style="font-size: 4rem; margin-bottom: 1.5rem;">ü§ù</div>
                            <h2
                                style="color: white; font-size: 1.8rem; margin-bottom: 1rem; font-weight: 700; text-align: center;">
                                Pr√©stamos</h2>
                            <p
                                style="color: rgba(255,255,255,0.9); font-size: 1rem; text-align: center; max-width: 280px;">
                                Pr√©stamo temporal a bodegas
                            </p>
                            <div
                                style="margin-top: 1.5rem; background: rgba(255,255,255,0.2); padding: 0.8rem 2rem; border-radius: 30px; color: white; font-weight: 600;">
                                Registrar Pr√©stamo ‚Üí
                            </div>
                        </div>
                    </div>

                    <!-- Nota informativa sobre Reubicaci√≥n -->
                    <div
                        style="text-align: center; padding: 1rem; background: #f5f3ff; border-radius: 12px; margin-top: 1rem;">
                        <p style="color: #7c3aed; margin: 0; font-size: 0.9rem;">
                            üí° <strong>¬øBuscas Reubicaci√≥n?</strong> Ahora est√° en <strong>Almac√©n ‚Üí Almac√©n de
                                Aceitunas</strong>
                        </p>
                    </div>
                </div>

                <!-- Contenido de Ventas -->
                <div id="salidaVentasContent" style="display: none;">
                    <div class="page-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" style="color: #16a34a;">üí∞ Ventas</h1>
                            <p class="page-subtitle">Registro de ventas - Exportaci√≥n o Mercado Nacional</p>
                        </div>
                        <button onclick="volverSalidaSeleccion()"
                            style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            ‚Üê Volver
                        </button>
                    </div>

                    <div class="card">
                        <!-- Selecci√≥n de Tipo de Venta -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                            <div id="btnExportacion" onclick="seleccionarTipoVenta('exportacion')"
                                style="background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üåç</div>
                                <div style="font-weight: 600; color: #1e293b;">Exportaci√≥n</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Venta internacional</div>
                            </div>
                            <div id="btnMercadoNacional" onclick="seleccionarTipoVenta('nacional')"
                                style="background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üáµüá™</div>
                                <div style="font-weight: 600; color: #1e293b;">Mercado Nacional</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Venta en Per√∫</div>
                            </div>
                        </div>

                        <!-- Formulario de Venta -->
                        <div id="formVenta" style="display: none;">
                            <!-- Informaci√≥n B√°sica -->
                            <div
                                style="margin-bottom: 1.5rem; padding: 1.2rem; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                                <h4 style="color: #16a34a; margin-bottom: 1rem; font-size: 0.95rem;">Informaci√≥n de la
                                    Venta</h4>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Responsable *</label>
                                        <input type="text" class="form-input" id="ventaResponsable"
                                            placeholder="Nombre del responsable">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Fecha *</label>
                                        <input type="date" class="form-input" id="ventaFechaRegistro">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Lote *</label>
                                        <select class="form-select" id="ventaLote"
                                            onchange="cargarCalibresPorLote('venta')">
                                            <option value="">Seleccionar lote...</option>
                                            <!-- Se llenar√° din√°micamente -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Informaci√≥n del Lote (Ventas) -->
                            <div id="ventaInfoLote"
                                style="display: none; margin-bottom: 1.5rem; padding: 1.2rem; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px; border: 2px solid #10b981;">
                                <h4
                                    style="color: #059669; margin-bottom: 1rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üìã Informaci√≥n del Lote Seleccionado
                                </h4>
                                <div
                                    style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                    <div
                                        style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                            C√≥digo</div>
                                        <div id="ventaInfoCodigo" style="font-weight: 700; color: #1e293b;">-</div>
                                    </div>
                                    <div
                                        style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                            Vendedor</div>
                                        <div id="ventaInfoVendedor" style="font-weight: 600; color: #1e293b;">-</div>
                                    </div>
                                    <div
                                        style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                            Variedad</div>
                                        <div id="ventaInfoVariedad" style="font-weight: 600; color: #1e293b;">-</div>
                                    </div>
                                    <div
                                        style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                            Stock Total</div>
                                        <div id="ventaInfoStock"
                                            style="font-weight: 700; color: #059669; font-size: 1.1rem;">0 Kg</div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px;">
                                    <div
                                        style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">
                                        Calibres Disponibles</div>
                                    <div id="ventaInfoCalibres" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Detalle del Lote Completo para Venta -->
                            <div id="ventaDetalleLote"
                                style="display: none; margin-bottom: 1.5rem; padding: 1.2rem; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
                                <h4
                                    style="color: #16a34a; margin-bottom: 1rem; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span>üì¶ Detalle del Lote a Vender</span>
                                    <span id="ventaTotalKgLote"
                                        style="background: #16a34a; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem;">Total:
                                        0 Kg</span>
                                </h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                        <thead>
                                            <tr style="background: #dcfce7;">
                                                <th
                                                    style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #16a34a;">
                                                    Calibre</th>
                                                <th
                                                    style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                                    Bidones</th>
                                                <th
                                                    style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                                    Kg/Bid√≥n</th>
                                                <th
                                                    style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                                    Sobras (Kg)</th>
                                                <th
                                                    style="padding: 0.6rem; text-align: right; border-bottom: 2px solid #16a34a; font-weight: 700;">
                                                    Total Kg</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ventaCalibresTabla">
                                            <!-- Se llenar√° din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Destino Exportaci√≥n -->
                            <div id="destinoExportacion"
                                style="display: none; margin-bottom: 1.5rem; padding: 1.2rem; background: #eff6ff; border-radius: 12px; border: 1px solid #bfdbfe;">
                                <h4 style="color: #1d4ed8; margin-bottom: 1rem; font-size: 0.95rem;">üåç Destino de
                                    Exportaci√≥n</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Pa√≠s *</label>
                                        <select class="form-select" id="ventaPais">
                                            <option value="">Seleccionar pa√≠s...</option>
                                            <option value="Brasil">Brasil</option>
                                            <option value="Chile">Chile</option>
                                            <option value="Argentina">Argentina</option>
                                            <option value="Ecuador">Ecuador</option>
                                            <option value="Colombia">Colombia</option>
                                            <option value="Estados Unidos">Estados Unidos</option>
                                            <option value="Espa√±a">Espa√±a</option>
                                            <option value="Italia">Italia</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Cliente *</label>
                                        <input type="text" class="form-input" id="ventaClienteExport"
                                            placeholder="Nombre del cliente">
                                    </div>
                                </div>
                            </div>

                            <!-- Destino Nacional -->
                            <div id="destinoNacional"
                                style="display: none; margin-bottom: 1.5rem; padding: 1.2rem; background: #fef3c7; border-radius: 12px; border: 1px solid #fcd34d;">
                                <h4 style="color: #92400e; margin-bottom: 1rem; font-size: 0.95rem;">üáµüá™ Destino
                                    Nacional</h4>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Ciudad *</label>
                                        <input type="text" class="form-input" id="ventaCiudad" placeholder="Ej: Lima">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Distrito</label>
                                        <input type="text" class="form-input" id="ventaDistrito"
                                            placeholder="Ej: Miraflores">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Cliente *</label>
                                        <input type="text" class="form-input" id="ventaClienteNacional"
                                            placeholder="Nombre del cliente">
                                    </div>
                                </div>
                            </div>

                            <!-- Bot√≥n Guardar -->
                            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                                <button onclick="limpiarFormVenta()"
                                    style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 500; cursor: pointer;">
                                    Limpiar
                                </button>
                                <button onclick="guardarVenta()"
                                    style="background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border: none; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                    Guardar Venta
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Historial de Ventas -->
                    <div class="card" style="margin-top: 2rem;">
                        <h3
                            style="color: #16a34a; margin-bottom: 1rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìã Historial de Ventas
                            <span id="ventasCount"
                                style="background: #16a34a; color: white; padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h3>
                        <div id="historialVentasContainer" style="overflow-x: auto;">
                            <table id="historialVentasTable"
                                style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #16a34a;">
                                            Fecha</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #16a34a;">
                                            Lote</th>
                                        <th
                                            style="padding: 0.8rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                            Tipo</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #16a34a;">
                                            Cliente</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #16a34a;">
                                            Destino</th>
                                        <th
                                            style="padding: 0.8rem; text-align: right; border-bottom: 2px solid #16a34a;">
                                            Total Kg</th>
                                        <th
                                            style="padding: 0.8rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                            Calibres</th>
                                        <th
                                            style="padding: 0.8rem; text-align: center; border-bottom: 2px solid #16a34a;">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialVentasBody">
                                    <!-- Se llenar√° din√°micamente -->
                                </tbody>
                            </table>
                            <div id="noVentasMessage"
                                style="display: none; text-align: center; padding: 2rem; color: #94a3b8;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì≠</div>
                                <p>No hay ventas registradas a√∫n</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Pr√©stamos -->
                <div id="salidaPrestamosContent" style="display: none;">
                    <div class="page-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" style="color: #f59e0b;">ü§ù Pr√©stamos</h1>
                            <p class="page-subtitle">Registro de pr√©stamos temporales a bodegas</p>
                        </div>
                        <button onclick="volverSalidaSeleccion()"
                            style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            ‚Üê Volver
                        </button>
                    </div>

                    <div class="card">
                        <!-- Formulario de Pr√©stamo -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7, #fef9c3); border-radius: 12px; border: 2px solid #f59e0b;">
                            <h4
                                style="color: #b45309; margin-bottom: 1.2rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìã Informaci√≥n del Pr√©stamo
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Responsable *</label>
                                    <input type="text" class="form-input" id="prestamoResponsable"
                                        placeholder="Nombre del responsable">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha *</label>
                                    <input type="date" class="form-input" id="prestamoFecha">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lote *</label>
                                    <select class="form-select" id="prestamoLote" onchange="cargarCalibresPrestamo()">
                                        <option value="">Seleccionar lote...</option>
                                        <!-- Se llenar√° din√°micamente -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Destinatario -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.5rem; background: #fffbeb; border-radius: 12px; border: 1px solid #fcd34d;">
                            <h4
                                style="color: #b45309; margin-bottom: 1.2rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üè™ Informaci√≥n del Destinatario
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Nombre del Destinatario *</label>
                                    <input type="text" class="form-input" id="prestamoDestinatario"
                                        placeholder="Nombre de la persona o empresa">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nombre de Bodega *</label>
                                    <input type="text" class="form-input" id="prestamoBodega"
                                        placeholder="Nombre de la bodega destino">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Direcci√≥n (Opcional)</label>
                                    <input type="text" class="form-input" id="prestamoDireccion"
                                        placeholder="Direcci√≥n de la bodega">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tel√©fono de Contacto (Opcional)</label>
                                    <input type="text" class="form-input" id="prestamoTelefono"
                                        placeholder="Ej: 999-999-999">
                                </div>
                            </div>
                        </div>

                        <!-- Detalle del Pr√©stamo -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <h4
                                style="color: #1e293b; margin-bottom: 1.2rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üì¶ Detalle del Producto
                            </h4>

                            <!-- Tipo de Pr√©stamo -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div id="btnPrestamoLoteCompleto" onclick="seleccionarTipoPrestamo('lote')"
                                    style="background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.2rem; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                                    <div style="font-size: 1.8rem; margin-bottom: 0.5rem;">üì¶</div>
                                    <div style="font-weight: 600; color: #1e293b;">Lote Completo</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Prestar todo el lote seleccionado
                                    </div>
                                </div>
                                <div id="btnPrestamoCalibre" onclick="seleccionarTipoPrestamo('calibres')"
                                    style="background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.2rem; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                                    <div style="font-size: 1.8rem; margin-bottom: 0.5rem;">‚öñÔ∏è</div>
                                    <div style="font-weight: 600; color: #1e293b;">Calibres Espec√≠ficos</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Seleccionar calibres individuales
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Lote Completo -->
                            <div id="panelPrestamoLoteCompleto" style="display: none;">
                                <div
                                    style="background: linear-gradient(135deg, #fef3c7, #fef9c3); padding: 1rem; border-radius: 10px; border: 1px solid #fcd34d; margin-bottom: 1rem;">
                                    <div
                                        style="font-size: 0.8rem; color: #92400e; font-weight: 600; margin-bottom: 0.5rem;">
                                        üì¶ RESUMEN DEL LOTE</div>
                                    <div id="resumenLotePrestamo" style="color: #78350f;"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Bidones Totales *</label>
                                        <input type="number" class="form-input" id="prestamoBidonesLote" placeholder="0"
                                            oninput="calcularTotalPrestamoLote()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Kg por Bid√≥n *</label>
                                        <input type="number" class="form-input" id="prestamoKgBidonLote"
                                            placeholder="60" step="0.1" oninput="calcularTotalPrestamoLote()"
                                            value="60">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Kg</label>
                                        <input type="text" class="form-input" id="prestamoKgTotalLote" value="0 Kg"
                                            readonly style="background: #e2e8f0; font-weight: 600; color: #f59e0b;">
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Calibres Espec√≠ficos -->
                            <div id="panelPrestamoCalibre" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <div
                                        style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.8rem; font-weight: 600;">
                                        Seleccione los calibres a prestar:
                                    </div>
                                    <div id="listaCalibresPrestamo"
                                        style="display: grid; grid-template-columns: 1fr; gap: 0.8rem; max-height: 300px; overflow-y: auto; padding-right: 0.5rem;">
                                        <!-- Se llenar√° din√°micamente con checkboxes -->
                                    </div>
                                </div>
                                <div
                                    style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1rem; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 0.8rem; opacity: 0.9;">TOTAL SELECCIONADO</div>
                                    <div id="prestamoTotalCalibreSeleccionado"
                                        style="font-size: 1.3rem; font-weight: 700;">0 Kg</div>
                                </div>
                            </div>
                        </div>


                        <!-- Informaci√≥n Adicional -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
                            <h4
                                style="color: #166534; margin-bottom: 1.2rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìù Informaci√≥n Adicional
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Fecha de Devoluci√≥n Estimada</label>
                                    <input type="date" class="form-input" id="prestamoFechaDevolucion">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="prestamoEstado">
                                        <option value="pendiente">Pendiente de devoluci√≥n</option>
                                        <option value="parcial">Devoluci√≥n parcial</option>
                                        <option value="devuelto">Devuelto</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="form-label">Observaciones</label>
                                    <textarea class="form-input" id="prestamoObservaciones" rows="3"
                                        placeholder="Notas adicionales sobre el pr√©stamo..."
                                        style="resize: vertical;"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                            <button onclick="limpiarFormPrestamo()"
                                style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 500; cursor: pointer;">
                                Limpiar
                            </button>
                            <button onclick="guardarPrestamo()"
                                style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                Guardar Pr√©stamo
                            </button>
                        </div>

                        <!-- Historial de Pr√©stamos -->
                        <div style="margin-top: 2rem; border-top: 2px solid #e2e8f0; padding-top: 1.5rem;">
                            <h3
                                style="color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìã Historial de Pr√©stamos
                                <span id="prestamosCount"
                                    style="background: #f59e0b; color: white; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.8rem;">0</span>
                            </h3>
                            <table id="historialPrestamosTable"
                                style="width: 100%; border-collapse: collapse; display: none;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #fef3c7, #fef9c3);">
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #f59e0b;">
                                            Fecha</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #f59e0b;">
                                            Lote</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #f59e0b;">
                                            Destinatario</th>
                                        <th
                                            style="padding: 0.8rem; text-align: left; border-bottom: 2px solid #f59e0b;">
                                            Bodega</th>
                                        <th
                                            style="padding: 0.8rem; text-align: right; border-bottom: 2px solid #f59e0b;">
                                            Kg Total</th>
                                        <th
                                            style="padding: 0.8rem; text-align: center; border-bottom: 2px solid #f59e0b;">
                                            Estado</th>
                                        <th
                                            style="padding: 0.8rem; text-align: center; border-bottom: 2px solid #f59e0b;">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialPrestamosBody">
                                    <!-- Se llenar√° din√°micamente -->
                                </tbody>
                            </table>
                            <div id="noPrestamosMessage"
                                style="display: none; text-align: center; padding: 2rem; color: #94a3b8;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì≠</div>
                                <p>No hay pr√©stamos registrados a√∫n</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido de Reubicaci√≥n -->
                <div id="salidaReubicacionContent" style="display: none;">
                    <div class="page-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title" style="color: #7c3aed;">üîÑ Reubicaci√≥n</h1>
                            <p class="page-subtitle">Mover productos a otro destino interno</p>
                        </div>
                        <button onclick="volverDesdeReubicacion()"
                            style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                            ‚Üê Volver
                        </button>
                    </div>

                    <div class="card">
                        <!-- Formulario de Reubicaci√≥n -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.2rem; background: #f5f3ff; border-radius: 12px; border: 1px solid #c4b5fd;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem; font-size: 0.95rem;">Informaci√≥n de
                                Reubicaci√≥n</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Responsable *</label>
                                    <input type="text" class="form-input" id="reubicacionResponsable"
                                        placeholder="Nombre del responsable">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha *</label>
                                    <input type="date" class="form-input" id="reubicacionFecha">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lote *</label>
                                    <select class="form-select" id="reubicacionLote"
                                        onchange="cargarCalibresPorLote('reubicacion')">
                                        <option value="">Seleccionar lote...</option>
                                        <!-- Se llenar√° din√°micamente -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Destino *</label>
                                    <input type="text" class="form-input" id="reubicacionDestinoNuevo"
                                        placeholder="Ej: Almac√©n B, Cuadrante C-3">
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Informaci√≥n del Lote (Reubicaci√≥n) -->
                        <div id="reubicacionInfoLote"
                            style="display: none; margin-bottom: 1.5rem; padding: 1.2rem; background: linear-gradient(135deg, #f5f3ff, #ede9fe); border-radius: 12px; border: 2px solid #8b5cf6;">
                            <h4
                                style="color: #7c3aed; margin-bottom: 1rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìã Informaci√≥n del Lote Seleccionado
                            </h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div
                                    style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                    <div
                                        style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                        C√≥digo</div>
                                    <div id="reubicacionInfoCodigo" style="font-weight: 700; color: #1e293b;">-
                                    </div>
                                </div>
                                <div
                                    style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                    <div
                                        style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                        Vendedor</div>
                                    <div id="reubicacionInfoVendedor" style="font-weight: 600; color: #1e293b;">-
                                    </div>
                                </div>
                                <div
                                    style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                    <div
                                        style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                        Variedad</div>
                                    <div id="reubicacionInfoVariedad" style="font-weight: 600; color: #1e293b;">-
                                    </div>
                                </div>
                                <div
                                    style="background: white; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                    <div
                                        style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.3rem;">
                                        Stock Total</div>
                                    <div id="reubicacionInfoStock"
                                        style="font-weight: 700; color: #7c3aed; font-size: 1.1rem;">0 Kg</div>
                                </div>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 8px;">
                                <div
                                    style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">
                                    Calibres Disponibles</div>
                                <div id="reubicacionInfoCalibres" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                </div>
                            </div>
                        </div>

                        <!-- Calibre y Cantidad -->
                        <div
                            style="margin-bottom: 1.5rem; padding: 1.2rem; background: #ede9fe; border-radius: 12px; border: 1px solid #c4b5fd;">
                            <h4 style="color: #7c3aed; margin-bottom: 1rem; font-size: 0.95rem;">Calibre y Cantidad
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Calibre *</label>
                                    <select class="form-select" id="reubicacionCalibre">
                                        <option value="">Seleccionar...</option>
                                        <!-- Se llenar√° seg√∫n el lote -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">N¬∞ de Bidones *</label>
                                    <input type="number" class="form-input" id="reubicacionBidones" placeholder="0"
                                        oninput="calcularKgTotalReubicacion()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Kg por Bid√≥n *</label>
                                    <input type="number" class="form-input" id="reubicacionKgBidon" placeholder="0"
                                        step="0.1" oninput="calcularKgTotalReubicacion()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Kg Total</label>
                                    <input type="text" class="form-input" id="reubicacionKgTotal" readonly
                                        style="background: #ddd6fe; font-weight: 700; color: #7c3aed;" value="0 Kg">
                                </div>
                            </div>
                        </div>

                        <!-- Bot√≥n Guardar -->
                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                            <button onclick="limpiarFormReubicacion()"
                                style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 500; cursor: pointer;">
                                Limpiar
                            </button>
                            <button onclick="guardarReubicacion()"
                                style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; border: none; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                Guardar Reubicaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2>ü´í Nueva Entrada de Aceituna</h2>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>

            <div class="modal-body">
                <!-- Informaci√≥n General y Tipo de Envase - Unificados -->
                <div class="form-section">
                    <h3 class="form-section-title">Informaci√≥n General y Tipo de Envase</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">C√≥digo de Lote</label>
                            <input type="text" class="form-input" id="codigoLote" placeholder="Ej: LOTE-2024-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-input" id="fecha">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendedor</label>
                            <input type="text" class="form-input" id="vendedor" placeholder="Nombre del vendedor">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Supervisor</label>
                            <input type="text" class="form-input" id="supervisor" placeholder="Nombre del supervisor">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio</label>
                            <input type="number" class="form-input" id="precio" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lugar</label>
                            <input type="text" class="form-input" id="lugar" placeholder="Ubicaci√≥n">
                        </div>
                    </div>

                    <!-- Par√°metros de Calidad -->
                    <div
                        style="margin-top: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 0.85rem; color: #3d4f31; margin-bottom: 0.8rem; font-weight: 600;">
                            Par√°metros de Calidad</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Acidez (%)</label>
                                <input type="number" class="form-input" id="acidez" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grados de Sal (¬∞B√©)</label>
                                <input type="number" class="form-input" id="gradosSal" placeholder="0.0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">pH</label>
                                <input type="number" class="form-input" id="ph" placeholder="0.00" step="0.01" min="0"
                                    max="14">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agua (m¬≥)</label>
                                <input type="number" class="form-input" id="aguaCalidad" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de Envase -->
                    <div
                        style="margin-top: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 0.85rem; color: #3d4f31; margin-bottom: 0.8rem; font-weight: 600;">Tipo de
                            Envase</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Seleccionar Tipo de Envase</label>
                                <select class="form-select" id="tipoEnvase" onchange="toggleEnvaseFields()">
                                    <option value="">Seleccionar...</option>
                                    <option value="margaritos">Margaritos</option>
                                    <option value="chavitos">Chavitos</option>
                                    <option value="bidones">Bidones de Exportaci√≥n</option>
                                    <option value="tarzas">Tarzas</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cantidad Total (Kg)</label>
                                <input type="number" class="form-input" id="cantidad" placeholder="0" step="0.1"
                                    readonly>
                            </div>
                        </div>
                        <div class="envase-fields-container" id="envaseFieldsContainer" style="display: none;">
                            <div class="form-grid" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Cantidad de Envases</label>
                                    <input type="number" class="form-input" id="envase_cantidad" placeholder="0"
                                        oninput="calcularTotalKg()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Kilos por Envase</label>
                                    <input type="number" class="form-input" id="envase_kilos" placeholder="0" step="0.1"
                                        oninput="calcularTotalKg()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Puchos / Sobras (Kg)</label>
                                    <input type="number" class="form-input" id="envase_puchos" placeholder="0"
                                        step="0.1" oninput="calcularTotalKg()">
                                </div>
                            </div>
                            <div class="total-kg-display" style="margin-top: 1rem;">
                                <span>Total Calculado:</span>
                                <strong id="totalKgCalculado">0 Kg</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Transporte -->
                    <div
                        style="margin-top: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 0.85rem; color: #3d4f31; margin-bottom: 0.8rem; font-weight: 600;">
                            Transporte
                        </h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Conductor</label>
                                <select class="form-select" id="transporteConductor">
                                    <option value="">Seleccionar...</option>
                                    <option value="costa_verde">Empresa Costa Verde</option>
                                    <option value="mario">Mario</option>
                                    <option value="john">John</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Numero de Viajes</label>
                                <input type="number" class="form-input" id="transporteViajes" placeholder="0"
                                    oninput="calcularTotalTransporte()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Costo por Viaje (S/)</label>
                                <input type="number" class="form-input" id="transporteCostoViaje" placeholder="0.00"
                                    step="0.01" oninput="calcularTotalTransporte()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Transporte (S/)</label>
                                <input type="text" class="form-input" id="transporteTotal" placeholder="S/0.00" readonly
                                    style="background: #f0f9e8; font-weight: 600; color: #3d4f31;">
                            </div>
                        </div>
                    </div>

                    <!-- Personal de Calibraci√≥n -->
                    <div
                        style="margin-top: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 0.85rem; color: #3d4f31; margin-bottom: 0.8rem; font-weight: 600;">
                            Personal de Calibraci√≥n
                        </h4>

                        <!-- Varones -->
                        <div
                            style="margin-bottom: 1rem; padding: 0.8rem; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h5 style="font-size: 0.8rem; color: #3d4f31; margin-bottom: 0.6rem; font-weight: 600;">
                                Varones</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-input" id="varonesQty" placeholder="0" min="0"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora/Hombre (S/)</label>
                                    <input type="number" class="form-input" id="varonesHoraHombre" placeholder="0.00"
                                        step="0.01" oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Ingreso</label>
                                    <input type="time" class="form-input" id="varonesHoraIngreso"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Final</label>
                                    <input type="time" class="form-input" id="varonesHoraFinal"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Horas Trabajadas</label>
                                    <input type="text" class="form-input" id="varonesHorasTrabajadas" placeholder="0:00"
                                        readonly style="background: #f1f5f9;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Costo Total (S/)</label>
                                    <input type="text" class="form-input" id="varonesCostoTotal" placeholder="S/0.00"
                                        readonly style="background: #f0f9e8; font-weight: 600; color: #3d4f31;">
                                </div>
                            </div>
                        </div>

                        <!-- Mujeres -->
                        <div style="padding: 0.8rem; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h5 style="font-size: 0.8rem; color: #475569; margin-bottom: 0.6rem; font-weight: 600;">
                                Mujeres</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-input" id="mujeresQty" placeholder="0" min="0"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora/Hombre (S/)</label>
                                    <input type="number" class="form-input" id="mujeresHoraHombre" placeholder="0.00"
                                        step="0.01" oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Ingreso</label>
                                    <input type="time" class="form-input" id="mujeresHoraIngreso"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Final</label>
                                    <input type="time" class="form-input" id="mujeresHoraFinal"
                                        oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Horas Trabajadas</label>
                                    <input type="text" class="form-input" id="mujeresHorasTrabajadas" placeholder="0:00"
                                        readonly style="background: #f1f5f9;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Costo Total (S/)</label>
                                    <input type="text" class="form-input" id="mujeresCostoTotal" placeholder="S/0.00"
                                        readonly style="background: #f0f9e8; font-weight: 600; color: #3d4f31;">
                                </div>
                            </div>
                        </div>

                        <!-- Traspaleadores -->
                        <div
                            style="margin-top: 1rem; padding: 0.8rem; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h5 style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.6rem; font-weight: 600;">
                                Traspaleadores</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Cantidad</label>
                                    <input type="number" class="form-input" id="traspaleadoresQty" placeholder="0"
                                        min="0" oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Costo por D√≠a (S/)</label>
                                    <input type="number" class="form-input" id="traspaleadoresCostoDia"
                                        placeholder="0.00" step="0.01" oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">D√≠as Trabajados</label>
                                    <input type="number" class="form-input" id="traspaleadoresDias" placeholder="1"
                                        min="1" value="1" oninput="calcularCostoPersonal()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Costo Total (S/)</label>
                                    <input type="text" class="form-input" id="traspaleadoresCostoTotal"
                                        placeholder="S/0.00" readonly
                                        style="background: #f0f9e8; font-weight: 600; color: #3d4f31;">
                                </div>
                            </div>
                        </div>

                        <!-- Total Personal -->
                        <div
                            style="margin-top: 0.8rem; padding: 0.6rem; background: linear-gradient(135deg, #3d4f31, #1a1a1a); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #fff; font-weight: 500;">Total Personal de Calibraci√≥n:</span>
                            <span id="totalCostoPersonal"
                                style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">S/0.00</span>
                        </div>
                    </div>

                    <!-- Otros Gastos -->
                    <div
                        style="margin-top: 1.2rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <h4 style="font-size: 0.85rem; color: #3d4f31; font-weight: 600; margin: 0;">
                                Otros Gastos
                            </h4>
                            <button type="button" onclick="agregarOtroGasto()"
                                style="padding: 0.4rem 0.8rem; background: #3d4f31; color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                + Agregar Gasto
                            </button>
                        </div>
                        <div id="otrosGastosContainer">
                            <!-- Los gastos se agregar√°n aqu√≠ din√°micamente -->
                        </div>
                        <div id="noOtrosGastos"
                            style="color: #94a3b8; font-size: 0.8rem; text-align: center; padding: 0.5rem;">
                            No hay otros gastos agregados
                        </div>
                        <!-- Total Otros Gastos -->
                        <div id="totalOtrosGastosRow"
                            style="margin-top: 0.8rem; padding: 0.6rem; background: linear-gradient(135deg, #475569, #334155); border-radius: 8px; display: none; justify-content: space-between; align-items: center;">
                            <span style="color: #fff; font-weight: 500;">Total Otros Gastos:</span>
                            <span id="totalOtrosGastos"
                                style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">S/0.00</span>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-group" style="margin-top: 1.2rem;">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-input" id="observaciones"
                            placeholder="Ingrese observaciones adicionales..." rows="3"
                            style="resize: vertical; min-height: 80px;"></textarea>
                    </div>
                </div>

                <!-- Color Selection -->
                <div class="form-section">
                    <h3 class="form-section-title">Selecci√≥n de Color</h3>
                    <div class="color-selection">
                        <div class="color-option" data-color="verde" onclick="selectColor('verde')">
                            <div class="color-icon"></div>
                            <div class="color-name">Verde</div>
                        </div>
                        <div class="color-option" data-color="negra" onclick="selectColor('negra')">
                            <div class="color-icon"></div>
                            <div class="color-name">Negra</div>
                        </div>
                        <div class="color-option" data-color="mulata" onclick="selectColor('mulata')">
                            <div class="color-icon"></div>
                            <div class="color-name">Mulata</div>
                        </div>
                    </div>

                    <!-- Variety -->
                    <div class="variety-section" id="varietySection">
                        <h4 class="process-title">Seleccionar Variedad</h4>
                        <div class="variety-grid" id="varietyGrid"></div>
                    </div>

                    <!-- Verde Sal Options -->
                    <div class="process-section" id="verdeSalSection">
                        <h4 class="process-title">Verde Sal - Tipo de Proceso</h4>
                        <div class="process-options">
                            <button type="button" class="process-btn" data-process="entera"
                                onclick="selectProcess('entera')">Entera</button>
                            <button type="button" class="process-btn" data-process="rodaja"
                                onclick="selectProcess('rodaja')">Rodaja</button>
                            <button type="button" class="process-btn" data-process="deshuesada"
                                onclick="selectProcess('deshuesada')">Deshuesada</button>
                        </div>

                        <div class="subprocess-section" id="enteraOptions">
                            <h5 class="process-title">Tipo de Entera</h5>
                            <div class="process-options">
                                <button type="button" class="process-btn" data-subprocess="calibrado"
                                    onclick="selectSubProcess('calibrado')">Calibrado</button>
                                <button type="button" class="process-btn" data-subprocess="embazado"
                                    onclick="selectSubProcess('embazado')">Embazado</button>
                            </div>
                        </div>

                        <div class="subprocess-section" id="rodajaOptions">
                            <h5 class="process-title">Tipo de Rodaja</h5>
                            <div class="process-options">
                                <button type="button" class="process-btn" data-subprocess="embazado"
                                    onclick="selectSubProcess('embazado')">Embazado</button>
                                <button type="button" class="process-btn" data-subprocess="pulido"
                                    onclick="selectSubProcess('pulido')">Pulido</button>
                            </div>
                        </div>

                        <div class="subprocess-section" id="deshuesadaOptions">
                            <h5 class="process-title">Tipo de Deshuesada</h5>
                            <div class="process-options">
                                <button type="button" class="process-btn" data-subprocess="embazado"
                                    onclick="selectSubProcess('embazado')">Embazado</button>
                                <button type="button" class="process-btn" data-subprocess="pulido"
                                    onclick="selectSubProcess('pulido')">Pulido</button>
                            </div>
                        </div>
                    </div>

                    <!-- Calibration -->
                    <div class="calibration-section" id="calibrationSection">
                        <h4 class="calibration-title">Fecha y Destino de Calibraci√≥n</h4>

                        <div class="form-grid" style="margin-bottom: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Fecha de Calibraci√≥n</label>
                                <input type="date" class="form-input" id="fechaCalibracion">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Responsable de Calibraci√≥n</label>
                                <input type="text" class="form-input" id="responsableCalibracion"
                                    placeholder="Nombre del responsable">
                            </div>
                        </div>

                        <div class="destination-options">
                            <div class="destination-btn selected" data-dest="exportacion"
                                onclick="selectDestination('exportacion')">
                                <div class="dest-name">Bidones de Exportaci√≥n</div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Salmuera dentro de Calibraci√≥n -->
                        <div
                            style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <h5 style="font-size: 0.9rem; color: #3d4f31; margin-bottom: 1rem; font-weight: 600;">
                                Informaci√≥n de Salmuera (Insumos y Costos)</h5>

                            <!-- Tabla de insumos de salmuera -->
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: #e2e8f0;">
                                            <th
                                                style="padding: 0.6rem; text-align: left; color: #3d4f31; font-weight: 600; width: 35%;">
                                                Insumo</th>
                                            <th
                                                style="padding: 0.6rem; text-align: center; color: #3d4f31; font-weight: 600; width: 20%;">
                                                Cantidad</th>
                                            <th
                                                style="padding: 0.6rem; text-align: center; color: #3d4f31; font-weight: 600; width: 22%;">
                                                Precio/Unidad</th>
                                            <th
                                                style="padding: 0.6rem; text-align: right; color: #3d4f31; font-weight: 600; width: 23%;">
                                                Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Agua -->
                                        <tr style="background: #e0f2fe; border-bottom: 1px solid #7dd3fc;">
                                            <td style="padding: 0.5rem; color: #0369a1; font-weight: 600;">Agua <span
                                                    style="color: #0ea5e9;">(m¬≥)</span></td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="salmueraAgua"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="salmueraAguaPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="salmueraAguaSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f0f9ff; font-weight: 600; text-align: right; color: #0369a1;">
                                            </td>
                                        </tr>
                                        <!-- Sorbato de Potasio -->
                                        <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">Sorbato de
                                                Potasio <span style="color: #94a3b8;">(Kg)</span></td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="sorbatoPotasio"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="sorbatoPotasioPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="sorbatoPotasioSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- √Åcido L√°ctico -->
                                        <tr style="background: #fafafa; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">√Åcido L√°ctico
                                                <span style="color: #94a3b8;">(Lt)</span>
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoLactico"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoLacticoPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="acidoLacticoSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- √Åcido C√≠trico -->
                                        <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">√Åcido C√≠trico
                                                <span style="color: #94a3b8;">(Kg)</span>
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoCitrico"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoCitricoPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="acidoCitricoSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- Calcio -->
                                        <tr style="background: #fafafa; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">Calcio <span
                                                    style="color: #94a3b8;">(Kg)</span></td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="calcio" placeholder="0.00"
                                                    step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="calcioPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="calcioSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- √Åcido Ac√©tico -->
                                        <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">√Åcido Ac√©tico
                                                <span style="color: #94a3b8;">(Lt)</span>
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoAcetico"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoAceticoPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="acidoAceticoSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- √Åcido Asc√≥rbico -->
                                        <tr style="background: #fafafa; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">√Åcido
                                                Asc√≥rbico <span style="color: #94a3b8;">(Kg)</span></td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoAscorbico"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="acidoAscorbicoPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="acidoAscorbicoSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- Benzoato de Potasio -->
                                        <tr style="background: #fff; border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">Benzoato de
                                                Potasio <span style="color: #94a3b8;">(Kg)</span></td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="benzoatoPotasio"
                                                    placeholder="0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="benzoatoPotasioPrecio"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: center;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="text" class="form-input" id="benzoatoPotasioSubtotal"
                                                    placeholder="S/0.00" readonly
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; background: #f8fafc; font-weight: 600; text-align: right;">
                                            </td>
                                        </tr>
                                        <!-- Otros Insumos -->
                                        <tr style="background: #fafafa;">
                                            <td style="padding: 0.5rem; color: #64748b; font-weight: 500;">Otros Insumos
                                            </td>
                                            <td style="padding: 0.4rem;" colspan="2">
                                                <input type="text" class="form-input" id="salmueraOtros"
                                                    placeholder="Descripci√≥n del insumo..."
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%;">
                                            </td>
                                            <td style="padding: 0.4rem;">
                                                <input type="number" class="form-input" id="salmueraOtrosCosto"
                                                    placeholder="S/0.00" step="0.01" oninput="calcularCostoSalmuera()"
                                                    style="padding: 0.4rem; font-size: 0.85rem; width: 100%; text-align: right; font-weight: 600;">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Total Costo Salmuera -->
                            <div
                                style="margin-top: 0.8rem; padding: 0.6rem; background: linear-gradient(135deg, #0369a1, #0ea5e9); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #fff; font-weight: 500;">Total Costo Salmuera:</span>
                                <span id="totalCostoSalmuera"
                                    style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">S/0.00</span>
                            </div>
                        </div>

                        <div class="caliber-section" style="margin-top: 1rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h5 class="process-title" style="margin: 0;">Calibres del Lote</h5>
                            </div>

                            <!-- Herramientas de Calibres -->
                            <div
                                style="margin-bottom: 1rem; padding: 1rem; background: #f0f9e8; border-radius: 10px; border: 1px solid #c5d9b5;">
                                <div
                                    style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-bottom: 0.8rem;">
                                    <span style="font-size: 0.8rem; font-weight: 600; color: #3d4f31;">Llenado
                                        R√°pido:</span>
                                    <select id="llenadoDesde" class="form-select"
                                        style="padding: 0.4rem 0.6rem; font-size: 0.8rem; min-width: 100px;">
                                        <option value="70-90">70-90</option>
                                        <option value="90-110">90-110</option>
                                        <option value="110-130">110-130</option>
                                        <option value="130-150">130-150</option>
                                        <option value="150-180">150-180</option>
                                        <option value="180-200">180-200</option>
                                        <option value="200-240">200-240</option>
                                        <option value="240-280">240-280</option>
                                        <option value="280-320">280-320</option>
                                        <option value="320-360">320-360</option>
                                        <option value="360-400">360-400</option>
                                        <option value="400-500">400-500</option>
                                        <option value="500+">500+</option>
                                    </select>
                                    <span style="font-size: 0.8rem; color: #64748b;">hasta</span>
                                    <select id="llenadoHasta" class="form-select"
                                        style="padding: 0.4rem 0.6rem; font-size: 0.8rem; min-width: 100px;">
                                        <option value="70-90">70-90</option>
                                        <option value="90-110">90-110</option>
                                        <option value="110-130">110-130</option>
                                        <option value="130-150">130-150</option>
                                        <option value="150-180">150-180</option>
                                        <option value="180-200">180-200</option>
                                        <option value="200-240">200-240</option>
                                        <option value="240-280">240-280</option>
                                        <option value="280-320">280-320</option>
                                        <option value="320-360">320-360</option>
                                        <option value="360-400">360-400</option>
                                        <option value="400-500">400-500</option>
                                        <option value="500+" selected>500+</option>
                                    </select>
                                    <button type="button" onclick="llenadoRapidoCalibres()"
                                        style="padding: 0.4rem 0.8rem; background: #3d4f31; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                        Generar
                                    </button>
                                    <button type="button" onclick="limpiarTodosCalibres()"
                                        style="padding: 0.4rem 0.8rem; background: #64748b; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                                        Limpiar Todo
                                    </button>
                                </div>

                                <!-- Crear Calibre Personalizado -->
                                <div
                                    style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; padding-top: 0.8rem; border-top: 1px dashed #a3b899;">
                                    <span style="font-size: 0.8rem; font-weight: 600; color: #475569;">Calibre
                                        Personalizado:</span>
                                    <input type="text" id="calibrePersonalizado" class="form-input"
                                        placeholder="Ej: 1-10, 15-25"
                                        style="padding: 0.4rem 0.6rem; font-size: 0.8rem; width: 120px;">
                                    <button type="button" onclick="agregarCalibrePersonalizado()"
                                        style="padding: 0.4rem 0.8rem; background: #475569; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                        + Agregar
                                    </button>
                                </div>
                            </div>

                            <!-- Lista de calibres agregados -->
                            <div id="calibresLista" style="display: flex; flex-direction: column; gap: 1rem;"></div>

                            <!-- Bot√≥n Agregar Calibre (siempre al final) -->
                            <div id="btnAgregarCalibreContainer" style="margin-top: 1rem;">
                                <button type="button" class="btn-add" onclick="agregarCalibre()"
                                    style="width: 100%; padding: 0.8rem 1rem; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(135deg, #0f172a, #1e293b);">
                                    <span style="font-size: 1.2rem;">+</span> Agregar Nuevo Calibre
                                </button>
                            </div>

                            <!-- Total de todos los calibres -->
                            <div id="totalCalibresResumen"
                                style="display: none; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #3d4f31, #5a7247); border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #bbf7d0; font-weight: 600;">TOTAL TODOS LOS CALIBRES:</span>
                                    <strong id="totalTodosCalibres" style="color: #fff; font-size: 1.3rem;">0
                                        Kg</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-save" onclick="saveEntry()">Guardar Entrada</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-modal">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </div>
            <h3>¬øEliminar entrada?</h3>
            <p>Esta acci√≥n no se puede deshacer. La entrada ser√° eliminada permanentemente.</p>
            <div class="confirm-actions">
                <button class="btn-confirm-cancel" onclick="closeConfirm()">Cancelar</button>
                <button class="btn-confirm-delete" onclick="confirmDelete()">
                    <svg viewBox="0 0 24 24">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                    </svg>
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Close Form Confirmation Modal -->
    <div class="confirm-overlay" id="closeConfirmOverlay">
        <div class="confirm-modal" style="border-top: 4px solid #f59e0b;">
            <div class="confirm-icon" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <h3 style="color: #1e293b;">¬øEst√°s seguro que quieres cerrar?</h3>
            <p style="color: #64748b;">Los datos ingresados no se guardar√°n si cierras el formulario.</p>
            <div class="confirm-actions">
                <button class="btn-confirm-cancel" onclick="closeCloseConfirm()"
                    style="background: #e2e8f0; color: #475569;">No, volver</button>
                <button class="btn-confirm-delete" onclick="confirmCloseModal()"
                    style="background: linear-gradient(135deg, #3d4f31, #1a1a1a);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 16px; height: 16px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    S√≠, cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- View Detail Modal -->
    <div class="modal-overlay" id="viewOverlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Detalle de Entrada</h2>
                <button class="btn-close" onclick="closeViewModal()">√ó</button>
            </div>
            <div class="modal-body" id="viewContent">
                <!-- Content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeViewModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ingresar Insumo al Almac√©n -->
    <div class="modal-overlay" id="insumoModalOverlay" style="display: none;">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #0369a1, #0ea5e9); border-radius: 20px 20px 0 0;">
                <h2 style="color: white; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üì¶</span> Ingresar Insumo al Almac√©n
                </h2>
                <button class="btn-close" onclick="closeInsumoModal()" style="color: white;">√ó</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Informaci√≥n del Insumo -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #0369a1; margin-bottom: 1rem; font-size: 0.95rem;">Informaci√≥n del Insumo</h4>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Nombre del Insumo *</label>
                            <select class="form-select" id="insumoNombre" onchange="handleInsumoChange()">
                                <option value="">Seleccionar...</option>
                                <option value="Agua">Agua</option>
                                <option value="Sorbato de Potasio">Sorbato de Potasio</option>
                                <option value="√Åcido L√°ctico">√Åcido L√°ctico</option>
                                <option value="√Åcido C√≠trico">√Åcido C√≠trico</option>
                                <option value="Calcio">Calcio</option>
                                <option value="√Åcido Ac√©tico">√Åcido Ac√©tico</option>
                                <option value="√Åcido Asc√≥rbico">√Åcido Asc√≥rbico</option>
                                <option value="Benzoato de Potasio">Benzoato de Potasio</option>
                                <option value="Sal Industrial">Sal Industrial</option>
                                <option value="Otro">Otro (especificar)</option>
                            </select>
                        </div>
                        <div class="form-group" id="insumoOtroGroup" style="display: none;">
                            <label class="form-label">Especificar Nombre</label>
                            <input type="text" class="form-input" id="insumoOtroNombre" placeholder="Nombre del insumo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categor√≠a</label>
                            <select class="form-select" id="insumoCategoria">
                                <option value="salmuera">Insumos de Salmuera</option>
                                <option value="ferreteria">Ferreter√≠a</option>
                                <option value="embalaje">Embalaje</option>
                                <option value="limpieza">Limpieza</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unidad de Medida</label>
                            <select class="form-select" id="insumoUnidad">
                                <option value="Kg">Kilogramos (Kg)</option>
                                <option value="Lt">Litros (Lt)</option>
                                <option value="m3">Metros c√∫bicos (m¬≥)</option>
                                <option value="Unidad">Unidades</option>
                                <option value="Bolsa">Bolsas</option>
                                <option value="Caja">Cajas</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Cantidad y Precio -->
                <div
                    style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 10px; border: 1px solid #7dd3fc;">
                    <h4 style="color: #0369a1; margin-bottom: 1rem; font-size: 0.95rem;">Cantidad y Costo</h4>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Cantidad *</label>
                            <input type="number" class="form-input" id="insumoCantidad" placeholder="0.00" step="0.01"
                                oninput="calcularTotalInsumo()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio Unitario (S/) *</label>
                            <input type="number" class="form-input" id="insumoPrecioUnitario" placeholder="0.00"
                                step="0.01" oninput="calcularTotalInsumo()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total (S/)</label>
                            <input type="text" class="form-input" id="insumoTotal" placeholder="S/0.00" readonly
                                style="background: #e0f2fe; font-weight: 700; color: #0369a1;">
                        </div>
                    </div>
                </div>

                <!-- Proveedor y Fecha -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #64748b; margin-bottom: 1rem; font-size: 0.95rem;">Datos de Compra</h4>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Proveedor</label>
                            <input type="text" class="form-input" id="insumoProveedor"
                                placeholder="Nombre del proveedor">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Ingreso *</label>
                            <input type="date" class="form-input" id="insumoFecha">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">N√∫mero de Factura/Boleta</label>
                            <input type="text" class="form-input" id="insumoFactura" placeholder="Ej: F001-00001234">
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-input" id="insumoObservaciones" rows="2" placeholder="Notas adicionales..."
                        style="resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-cancel" onclick="closeInsumoModal()"
                    style="padding: 0.7rem 1.5rem; border-radius: 10px; border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer;">Cancelar</button>
                <button class="btn btn-save" onclick="saveInsumo()"
                    style="padding: 0.7rem 1.5rem; border-radius: 10px; border: none; background: linear-gradient(135deg, #0369a1, #0ea5e9); color: white; font-weight: 600; cursor: pointer;">Guardar
                    Insumo</button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }

        // Obtener rol del usuario actual
        const currentUserRole = sessionStorage.getItem('userRole') || 'trabajador';
        const currentUserName = sessionStorage.getItem('userName') || 'Usuario';

        // Funci√≥n para verificar si el usuario tiene acceso a funciones de admin
        function esAdmin() {
            return currentUserRole === 'admin';
        }

        // Funci√≥n para verificar si puede ver precios
        function puedeVerPrecios() {
            return currentUserRole === 'admin';
        }

        // Funci√≥n para verificar si puede ver reportes
        function puedeVerReportes() {
            return currentUserRole === 'admin';
        }

        // Varieties by color
        const varietiesByColor = {
            verde: ['Manzanilla', 'Ascolana', 'Soda', 'Sal'],
            negra: ['Empeltre', 'Sevillana'],
            mulata: ['Rosada', 'Verde']
        };

        // ===== FUNCI√ìN MODAL DE INFORMACI√ìN =====
        function mostrarModalInfo(titulo, contenidoHTML, icono = 'üìã') {
            // Eliminar modal previo si existe
            var modalPrevio = document.getElementById('modalInfoGeneral');
            if (modalPrevio) modalPrevio.remove();

            var html = '<div id="modalInfoGeneral" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 550px; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">' + icono + '</span><h3 style="margin: 0; font-size: 1.1rem;">' + titulo + '</h3></div>';
            html += '<button onclick="cerrarModalInfo()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>';
            html += '</div>';
            html += '<div class="modal-scroll" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">';
            html += contenidoHTML;
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">';
            html += '<button onclick="cerrarModalInfo()" style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cerrar</button>';
            html += '</div></div></div>';

            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalInfo() {
            var modal = document.getElementById('modalInfoGeneral');
            if (modal) modal.remove();
        }

        // State
        let entries = JSON.parse(localStorage.getItem('aceitunaEntries')) || [];
        let selectedColor = '';
        let selectedVariety = '';
        let selectedProcess = '';
        let selectedSubProcess = '';
        let selectedDestination = '';
        let selectedCaliber = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            renderEntries();
            document.getElementById('fecha').valueAsDate = new Date();

            // Set user info
            const userName = sessionStorage.getItem('userName') || 'Usuario';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

            // Actualizar badge de rol
            const roleBadge = document.querySelector('.user-role');
            if (roleBadge) {
                if (currentUserRole === 'admin') {
                    roleBadge.textContent = 'Admin';
                    roleBadge.style.background = '#0f172a';
                } else if (currentUserRole === 'ing_yeny') {
                    roleBadge.textContent = 'Ing. Yeny';
                    roleBadge.style.background = '#7c3aed';
                } else {
                    roleBadge.textContent = 'Trabajador';
                    roleBadge.style.background = '#3b82f6';
                }
            }

            // Aplicar restricciones de rol
            aplicarRestriccionesRol();

            // Initialize cuadrantes
            initCuadrantes();

            // Initialize title bar with username and time
            updateTitleBar();
        });

        // Funci√≥n para aplicar restricciones seg√∫n el rol
        function aplicarRestriccionesRol() {
            // Ocultar elementos de precio si no es admin
            if (!puedeVerPrecios()) {
                // Ocultar campo de precio en el formulario
                const precioGroup = document.getElementById('precio')?.closest('.form-group');
                if (precioGroup) precioGroup.style.display = 'none';

                // Ocultar filtros de precio
                document.querySelectorAll('.filter-select').forEach(select => {
                    if (select.innerHTML.includes('Precio')) {
                        select.style.display = 'none';
                    }
                });

                // Ocultar columnas de precio en tarjetas
                document.querySelectorAll('.entry-field').forEach(field => {
                    const label = field.querySelector('.entry-field-label');
                    if (label && label.textContent.includes('Precio')) {
                        field.style.display = 'none';
                    }
                });

                // Ocultar totales de inversi√≥n en reportes
                const totalInversionCard = document.querySelector('[id="totalInversion"]')?.closest('div')?.closest('div');
                if (totalInversionCard) totalInversionCard.style.display = 'none';
            }

            // Ocultar secci√≥n de reportes si no puede verlos
            if (!puedeVerReportes()) {
                const reportesNav = document.querySelector('[data-section="reportes"]');
                if (reportesNav) reportesNav.style.display = 'none';
            }
        }

        // ========== ALMAC√âN FUNCTIONS ==========
        let almacenData = JSON.parse(localStorage.getItem('almacenData')) || {};
        let selectedSalidaTipo = '';
        let selectedVentaTipo = '';

        function initCuadrantes() {
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const cols = [1, 2, 3, 4, 5];

            rows.forEach(row => {
                const rowContainer = document.getElementById('row-' + row);
                if (!rowContainer) return;

                rowContainer.innerHTML = '';
                cols.forEach(col => {
                    const cuadranteId = row + '-' + col;
                    const data = almacenData[cuadranteId] || null;
                    const isOccupied = data !== null;

                    const cell = document.createElement('div');
                    cell.className = 'cuadrante-cell ' + (isOccupied ? 'occupied' : 'empty');
                    cell.onclick = () => openCuadranteModal(cuadranteId);

                    let content = '<div class="cuadrante-id">' + cuadranteId + '</div>';
                    if (isOccupied) {
                        content += '<div class="cuadrante-info">';
                        if (data.tipo) content += '<span class="tag ' + data.tipo + '">' + (data.tipo === 'fibra' ? 'Fibra' : 'Bid√≥n') + '</span>';
                        if (data.color) content += '<span class="tag ' + data.color + '">' + capitalizeFirst(data.color) + '</span>';
                        if (data.calibre) content += '<div style="margin-top:0.3rem;font-size:0.7rem;">Calibre: ' + data.calibre + '</div>';
                        if (data.codigo) content += '<div style="margin-top:0.2rem;font-size:0.65rem;color:#3b82f6;">ID: ' + data.codigo + '</div>';
                        content += '</div>';
                    } else {
                        content += '<div class="cuadrante-info" style="color:#94a3b8;">Vac√≠o</div>';
                    }

                    cell.innerHTML = content;
                    rowContainer.appendChild(cell);
                });
            });

            // Populate reubicaci√≥n selects
            populateCuadranteSelects();
        }

        function populateCuadranteSelects() {
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const cols = [1, 2, 3, 4, 5];

            const origenSelect = document.getElementById('reubicacionOrigen');
            const destinoSelect = document.getElementById('reubicacionDestino');

            if (origenSelect) {
                origenSelect.innerHTML = '<option value="">Seleccionar...</option>';
                rows.forEach(row => {
                    cols.forEach(col => {
                        const cuadranteId = row + '-' + col;
                        origenSelect.innerHTML += '<option value="' + cuadranteId + '">' + cuadranteId + '</option>';
                    });
                });
            }

            if (destinoSelect) {
                destinoSelect.innerHTML = '<option value="">Seleccionar...</option><option value="ferreteria">üîß Ferreter√≠a</option>';
                rows.forEach(row => {
                    cols.forEach(col => {
                        const cuadranteId = row + '-' + col;
                        destinoSelect.innerHTML += '<option value="' + cuadranteId + '">' + cuadranteId + '</option>';
                    });
                });
            }
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function buscarPorCodigo() {
            const codigo = document.getElementById('searchCodigo').value.trim().toLowerCase();
            if (!codigo) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese un c√≥digo para buscar</p>', '‚ö†Ô∏è');
                return;
            }

            // Search in cuadrantes
            for (const [cuadranteId, data] of Object.entries(almacenData)) {
                if (data && data.codigo && data.codigo.toLowerCase().includes(codigo)) {
                    openCuadranteModal(cuadranteId);
                    return;
                }
            }

            mostrarModalInfo('Sin Resultados', '<p style="text-align: center; color: #64748b; padding: 1rem;">No se encontr√≥ ning√∫n elemento con el c√≥digo: <strong>' + codigo + '</strong></p>', 'üîç');
        }

        function openCuadranteModal(cuadranteId) {
            const data = almacenData[cuadranteId] || null;

            document.getElementById('cuadranteModalTitle').textContent = 'Cuadrante ' + cuadranteId;

            let content = '';
            if (data) {
                content = '<div style="display: grid; gap: 1rem;">' +
                    '<div style="background: #f0fdf4; padding: 1rem; border-radius: 10px; border: 1px solid #16a34a;">' +
                    '<div style="font-size: 0.75rem; color: #16a34a; text-transform: uppercase;">Estado</div>' +
                    '<div style="font-weight: 600; color: #16a34a;">Ocupado</div>' +
                    '</div>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
                    '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px;">' +
                    '<div style="font-size: 0.75rem; color: #64748b;">Tipo</div>' +
                    '<div style="font-weight: 600;">' + (data.tipo === 'fibra' ? 'Fibra' : 'Bid√≥n') + '</div>' +
                    '</div>' +
                    '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px;">' +
                    '<div style="font-size: 0.75rem; color: #64748b;">Color</div>' +
                    '<div style="font-weight: 600;">' + capitalizeFirst(data.color || '-') + '</div>' +
                    '</div>' +
                    '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px;">' +
                    '<div style="font-size: 0.75rem; color: #64748b;">Calibre</div>' +
                    '<div style="font-weight: 600;">' + (data.calibre || '-') + '</div>' +
                    '</div>' +
                    '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px;">' +
                    '<div style="font-size: 0.75rem; color: #64748b;">C√≥digo/QR</div>' +
                    '<div style="font-weight: 600; color: #3b82f6;">' + (data.codigo || '-') + '</div>' +
                    '</div>' +
                    '</div>' +
                    (data.cantidad ? '<div style="background: #eff6ff; padding: 1rem; border-radius: 10px;">' +
                        '<div style="font-size: 0.75rem; color: #1d4ed8;">Cantidad: ' + data.cantidad + ' unidades</div>' +
                        '</div>' : '') +
                    '</div>';
            } else {
                content = '<div style="text-align: center; padding: 2rem;">' +
                    '<div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üì¶</div>' +
                    '<p style="color: #64748b;">Este cuadrante est√° vac√≠o</p>' +
                    '</div>';
            }

            document.getElementById('cuadranteModalContent').innerHTML = content;
            document.getElementById('cuadranteModalOverlay').classList.add('active');
        }

        function closeCuadranteModal() {
            document.getElementById('cuadranteModalOverlay').classList.remove('active');
        }

        function openSalidaModal() {
            selectedSalidaTipo = '';
            selectedVentaTipo = '';
            document.querySelectorAll('.salida-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.salida-form').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.venta-type-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById('exportacionFields').style.display = 'none';
            document.getElementById('salidaModalOverlay').classList.add('active');
        }

        function closeSalidaModal() {
            document.getElementById('salidaModalOverlay').classList.remove('active');
        }

        function selectSalidaTipo(tipo) {
            selectedSalidaTipo = tipo;
            document.querySelectorAll('.salida-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.tipo === tipo);
            });

            document.querySelectorAll('.salida-form').forEach(el => el.style.display = 'none');

            if (tipo === 'venta') {
                document.getElementById('ventaForm').style.display = 'block';
            } else if (tipo === 'prestamo') {
                document.getElementById('prestamoForm').style.display = 'block';
            } else if (tipo === 'reubicacion') {
                document.getElementById('reubicacionForm').style.display = 'block';
            }
        }

        function selectVentaTipo(tipo) {
            selectedVentaTipo = tipo;
            document.querySelectorAll('.venta-type-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.venta === tipo);
            });

            document.getElementById('exportacionFields').style.display = tipo === 'exportacion' ? 'block' : 'none';
        }

        function guardarSalida() {
            if (!selectedSalidaTipo) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione un tipo de salida</p>', '‚ö†Ô∏è');
                return;
            }

            // Save logic here
            mostrarModalInfo('√âxito', '<p style="text-align: center; color: #16a34a;">Salida registrada correctamente</p>', '‚úÖ');
            closeSalidaModal();
        }

        // ========== SALIDA SECTION FUNCTIONS ==========
        let tipoVentaSeleccionado = '';
        let salidasData = JSON.parse(localStorage.getItem('salidasData')) || [];

        function mostrarSalidaVentas() {
            document.getElementById('salidaSeleccion').style.display = 'none';
            document.getElementById('salidaVentasContent').style.display = 'block';
            document.getElementById('salidaReubicacionContent').style.display = 'none';
            // Set fecha to today
            document.getElementById('ventaFechaRegistro').value = new Date().toISOString().split('T')[0];
            cargarLotesParaVenta();
            // Renderizar historial de ventas
            renderHistorialVentas();
        }

        function mostrarSalidaReubicacion() {
            document.getElementById('salidaSeleccion').style.display = 'none';
            document.getElementById('salidaVentasContent').style.display = 'none';
            document.getElementById('salidaReubicacionContent').style.display = 'block';
            // Set fecha to today
            document.getElementById('reubicacionFecha').value = new Date().toISOString().split('T')[0];
            // Cargar lotes disponibles
            cargarLotesParaReubicacion();
        }

        function volverSalidaSeleccion() {
            document.getElementById('salidaSeleccion').style.display = 'block';
            document.getElementById('salidaVentasContent').style.display = 'none';
            document.getElementById('salidaReubicacionContent').style.display = 'none';
            document.getElementById('salidaPrestamosContent').style.display = 'none';
            tipoVentaSeleccionado = '';
        }

        // ========== PR√âSTAMOS FUNCTIONS ==========
        let prestamosData = JSON.parse(localStorage.getItem('prestamosData')) || [];

        function mostrarSalidaPrestamos() {
            document.getElementById('salidaSeleccion').style.display = 'none';
            document.getElementById('salidaVentasContent').style.display = 'none';
            document.getElementById('salidaReubicacionContent').style.display = 'none';
            document.getElementById('salidaPrestamosContent').style.display = 'block';
            // Set fecha to today
            document.getElementById('prestamoFecha').value = new Date().toISOString().split('T')[0];
            cargarLotesParaPrestamo();
            renderHistorialPrestamos();
        }

        function cargarLotesParaPrestamo() {
            const select = document.getElementById('prestamoLote');
            select.innerHTML = '<option value="">Seleccionar lote...</option>';

            entries.forEach(entry => {
                if (entry.codigoLote) {
                    const totalKg = entry.calibres && entry.calibres.length > 0
                        ? entry.calibres.reduce((sum, c) => sum + (parseFloat(c.subtotal) || 0), 0)
                        : 0;
                    select.innerHTML += '<option value="' + entry.id + '">' + entry.codigoLote + ' - ' + (entry.vendedor || 'Sin vendedor') + ' (' + totalKg.toFixed(1) + ' Kg)</option>';
                }
            });
        }

        let tipoPrestamo = ''; // 'lote' o 'calibres'
        let calibresPrestamoSeleccionados = [];

        function cargarCalibresPrestamo() {
            const loteId = document.getElementById('prestamoLote').value;

            // Resetear paneles
            document.getElementById('panelPrestamoLoteCompleto').style.display = 'none';
            document.getElementById('panelPrestamoCalibre').style.display = 'none';
            document.getElementById('btnPrestamoLoteCompleto').style.background = '#f1f5f9';
            document.getElementById('btnPrestamoLoteCompleto').style.borderColor = '#e2e8f0';
            document.getElementById('btnPrestamoCalibre').style.background = '#f1f5f9';
            document.getElementById('btnPrestamoCalibre').style.borderColor = '#e2e8f0';
            tipoPrestamo = '';
            calibresPrestamoSeleccionados = [];

            if (!loteId) {
                document.getElementById('resumenLotePrestamo').innerHTML = '<span style="color: #94a3b8;">Seleccione un lote primero</span>';
                document.getElementById('listaCalibresPrestamo').innerHTML = '<span style="color: #94a3b8;">Seleccione un lote primero</span>';
                return;
            }

            const entry = entries.find(e => e.id == loteId);
            if (entry && entry.calibres && entry.calibres.length > 0) {
                // Calcular totales
                let totalKg = 0;
                let calibresInfo = [];
                entry.calibres.forEach(c => {
                    totalKg += parseFloat(c.subtotal) || 0;
                    calibresInfo.push(c.calibre + ': ' + (c.subtotal || 0) + ' Kg');
                });

                // Actualizar resumen del lote
                document.getElementById('resumenLotePrestamo').innerHTML =
                    '<div><strong>Lote:</strong> ' + entry.codigoLote + '</div>' +
                    '<div><strong>Total disponible:</strong> ' + totalKg.toFixed(1) + ' Kg</div>' +
                    '<div><strong>Calibres:</strong> ' + entry.calibres.length + ' (' + calibresInfo.join(', ') + ')</div>';

                // Generar lista de calibres con checkboxes y campos editables
                let html = '';
                entry.calibres.forEach((c, index) => {
                    html += '<div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">';
                    html += '<input type="checkbox" id="chkCalibre_' + index + '" onchange="actualizarTotalCalibresPrestamo()" style="width: 20px; height: 20px; cursor: pointer;">';
                    html += '<div style="flex: 1;">';
                    html += '<div style="font-weight: 600; color: #1e293b;">' + c.calibre + '</div>';
                    html += '<div style="font-size: 0.8rem; color: #64748b;">Disponible: ' + (c.subtotal || 0) + ' Kg</div>';
                    html += '</div>';
                    html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                    html += '<input type="number" id="bidonCalibre_' + index + '" placeholder="Bidones" style="width: 80px; padding: 0.4rem; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center;" oninput="actualizarTotalCalibresPrestamo()" disabled>';
                    html += '<span style="color: #64748b;">√ó</span>';
                    html += '<input type="number" id="kgBidonCalibre_' + index + '" value="60" placeholder="Kg/Bid√≥n" step="0.1" style="width: 70px; padding: 0.4rem; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center;" oninput="actualizarTotalCalibresPrestamo()" disabled>';
                    html += '<span style="color: #64748b; font-size: 0.85rem;">Kg</span>';
                    html += '<input type="hidden" id="calibreNombre_' + index + '" value="' + c.calibre + '">';
                    html += '</div></div>';
                });
                document.getElementById('listaCalibresPrestamo').innerHTML = html;

                // Habilitar/deshabilitar campos seg√∫n checkbox
                document.querySelectorAll('[id^="chkCalibre_"]').forEach((chk, i) => {
                    chk.addEventListener('change', function () {
                        document.getElementById('bidonCalibre_' + i).disabled = !this.checked;
                        document.getElementById('kgBidonCalibre_' + i).disabled = !this.checked;
                        if (!this.checked) {
                            document.getElementById('bidonCalibre_' + i).value = '';
                        }
                    });
                });
            } else {
                document.getElementById('resumenLotePrestamo').innerHTML = '<span style="color: #dc2626;">Este lote no tiene calibres registrados</span>';
                document.getElementById('listaCalibresPrestamo').innerHTML = '<span style="color: #dc2626;">Este lote no tiene calibres registrados</span>';
            }
        }

        function seleccionarTipoPrestamo(tipo) {
            tipoPrestamo = tipo;

            // Visual update
            document.getElementById('btnPrestamoLoteCompleto').style.background = tipo === 'lote' ? '#f59e0b' : '#f1f5f9';
            document.getElementById('btnPrestamoLoteCompleto').style.borderColor = tipo === 'lote' ? '#f59e0b' : '#e2e8f0';
            document.getElementById('btnPrestamoLoteCompleto').style.color = tipo === 'lote' ? 'white' : '#1e293b';
            document.getElementById('btnPrestamoCalibre').style.background = tipo === 'calibres' ? '#7c3aed' : '#f1f5f9';
            document.getElementById('btnPrestamoCalibre').style.borderColor = tipo === 'calibres' ? '#7c3aed' : '#e2e8f0';
            document.getElementById('btnPrestamoCalibre').style.color = tipo === 'calibres' ? 'white' : '#1e293b';

            // Show/hide panels
            document.getElementById('panelPrestamoLoteCompleto').style.display = tipo === 'lote' ? 'block' : 'none';
            document.getElementById('panelPrestamoCalibre').style.display = tipo === 'calibres' ? 'block' : 'none';
        }

        function calcularTotalPrestamoLote() {
            const bidones = parseFloat(document.getElementById('prestamoBidonesLote').value) || 0;
            const kgBidon = parseFloat(document.getElementById('prestamoKgBidonLote').value) || 0;
            const total = bidones * kgBidon;
            document.getElementById('prestamoKgTotalLote').value = total.toFixed(1) + ' Kg';
        }

        function actualizarTotalCalibresPrestamo() {
            let totalKg = 0;
            calibresPrestamoSeleccionados = [];

            document.querySelectorAll('[id^="chkCalibre_"]').forEach((chk, i) => {
                if (chk.checked) {
                    const bidones = parseFloat(document.getElementById('bidonCalibre_' + i).value) || 0;
                    const kgBidon = parseFloat(document.getElementById('kgBidonCalibre_' + i).value) || 60;
                    const nombre = document.getElementById('calibreNombre_' + i).value;
                    const subtotal = bidones * kgBidon;
                    totalKg += subtotal;

                    if (bidones > 0) {
                        calibresPrestamoSeleccionados.push({
                            calibre: nombre,
                            bidones: bidones,
                            kgBidon: kgBidon,
                            kgTotal: subtotal
                        });
                    }
                }
            });

            document.getElementById('prestamoTotalCalibreSeleccionado').textContent = totalKg.toFixed(1) + ' Kg';
        }


        function guardarPrestamo() {
            const responsable = document.getElementById('prestamoResponsable').value.trim();
            const fecha = document.getElementById('prestamoFecha').value;
            const loteId = document.getElementById('prestamoLote').value;
            const destinatario = document.getElementById('prestamoDestinatario').value.trim();
            const bodega = document.getElementById('prestamoBodega').value.trim();

            // Validaciones b√°sicas
            if (!responsable) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el responsable</p>', '‚ö†Ô∏è'); return; }
            if (!fecha) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese la fecha</p>', '‚ö†Ô∏è'); return; }
            if (!loteId) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione un lote</p>', '‚ö†Ô∏è'); return; }
            if (!destinatario) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el nombre del destinatario</p>', '‚ö†Ô∏è'); return; }
            if (!bodega) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el nombre de la bodega</p>', '‚ö†Ô∏è'); return; }
            if (!tipoPrestamo) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione el tipo de pr√©stamo (Lote Completo o Calibres Espec√≠ficos)</p>', '‚ö†Ô∏è'); return; }

            const entry = entries.find(e => e.id == loteId);
            const codigoLote = entry ? entry.codigoLote : loteId;

            let bidones = 0;
            let kgBidon = 60;
            let kgTotal = 0;
            let calibresDetalle = [];
            let calibreTexto = '';

            if (tipoPrestamo === 'lote') {
                bidones = parseFloat(document.getElementById('prestamoBidonesLote').value) || 0;
                kgBidon = parseFloat(document.getElementById('prestamoKgBidonLote').value) || 60;
                kgTotal = bidones * kgBidon;
                calibreTexto = 'LOTE COMPLETO';

                if (bidones <= 0) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el n√∫mero de bidones</p>', '‚ö†Ô∏è'); return; }
            } else if (tipoPrestamo === 'calibres') {
                if (calibresPrestamoSeleccionados.length === 0) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione al menos un calibre y especifique los bidones</p>', '‚ö†Ô∏è'); return; }

                calibresDetalle = calibresPrestamoSeleccionados;
                kgTotal = calibresDetalle.reduce((sum, c) => sum + c.kgTotal, 0);
                bidones = calibresDetalle.reduce((sum, c) => sum + c.bidones, 0);
                calibreTexto = calibresDetalle.map(c => c.calibre + ' (' + c.bidones + ' bid)').join(', ');
            }

            const prestamo = {
                id: Date.now(),
                tipo: 'prestamo',
                modoPrestamo: tipoPrestamo, // 'lote' o 'calibres'
                responsable: responsable,
                fecha: fecha,
                loteId: loteId,
                codigoLote: codigoLote,
                destinatario: destinatario,
                bodega: bodega,
                direccion: document.getElementById('prestamoDireccion').value.trim(),
                telefono: document.getElementById('prestamoTelefono').value.trim(),
                calibres: calibresDetalle,
                calibreTexto: calibreTexto,
                bidones: bidones,
                kgBidon: kgBidon,
                kgTotal: kgTotal,
                fechaDevolucion: document.getElementById('prestamoFechaDevolucion').value,
                estado: document.getElementById('prestamoEstado').value,
                observaciones: document.getElementById('prestamoObservaciones').value.trim(),
                fechaRegistro: new Date().toISOString()
            };

            prestamosData.push(prestamo);
            localStorage.setItem('prestamosData', JSON.stringify(prestamosData));

            var msgPrestamo = '<div style="text-align: center;"><div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>';
            msgPrestamo += '<div style="font-weight: 700; color: #16a34a; margin-bottom: 1rem;">Pr√©stamo Registrado</div></div>';
            msgPrestamo += '<div style="background: #fef3c7; border-radius: 8px; padding: 1rem;">';
            msgPrestamo += '<div><span style="color: #92400e; font-size: 0.75rem;">DESTINATARIO</span><div style="font-weight: 600;">' + destinatario + '</div></div>';
            msgPrestamo += '<div style="margin-top: 0.5rem;"><span style="color: #92400e; font-size: 0.75rem;">BODEGA</span><div style="font-weight: 600;">' + bodega + '</div></div>';
            msgPrestamo += '<div style="margin-top: 0.5rem;"><span style="color: #92400e; font-size: 0.75rem;">LOTE</span><div style="font-weight: 600;">' + codigoLote + '</div></div>';
            msgPrestamo += '<div style="margin-top: 0.5rem;"><span style="color: #92400e; font-size: 0.75rem;">DETALLE</span><div style="font-weight: 600;">' + calibreTexto + '</div></div>';
            msgPrestamo += '<div style="margin-top: 0.5rem;"><span style="color: #92400e; font-size: 0.75rem;">TOTAL</span><div style="font-weight: 600; color: #f59e0b;">' + kgTotal.toFixed(1) + ' Kg (' + bidones + ' bidones)</div></div>';
            msgPrestamo += '</div>';
            mostrarModalInfo('Pr√©stamo Registrado', msgPrestamo, 'ü§ù');

            limpiarFormPrestamo();
            renderHistorialPrestamos();
        }

        function limpiarFormPrestamo() {
            document.getElementById('prestamoResponsable').value = '';
            document.getElementById('prestamoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('prestamoLote').value = '';
            document.getElementById('prestamoDestinatario').value = '';
            document.getElementById('prestamoBodega').value = '';
            document.getElementById('prestamoDireccion').value = '';
            document.getElementById('prestamoTelefono').value = '';
            document.getElementById('prestamoFechaDevolucion').value = '';
            document.getElementById('prestamoEstado').value = 'pendiente';
            document.getElementById('prestamoObservaciones').value = '';

            // Resetear paneles
            tipoPrestamo = '';
            calibresPrestamoSeleccionados = [];
            document.getElementById('panelPrestamoLoteCompleto').style.display = 'none';
            document.getElementById('panelPrestamoCalibre').style.display = 'none';
            document.getElementById('btnPrestamoLoteCompleto').style.background = '#f1f5f9';
            document.getElementById('btnPrestamoLoteCompleto').style.borderColor = '#e2e8f0';
            document.getElementById('btnPrestamoLoteCompleto').style.color = '#1e293b';
            document.getElementById('btnPrestamoCalibre').style.background = '#f1f5f9';
            document.getElementById('btnPrestamoCalibre').style.borderColor = '#e2e8f0';
            document.getElementById('btnPrestamoCalibre').style.color = '#1e293b';
            document.getElementById('prestamoBidonesLote').value = '';
            document.getElementById('prestamoKgBidonLote').value = '60';
            document.getElementById('prestamoKgTotalLote').value = '0 Kg';
            document.getElementById('listaCalibresPrestamo').innerHTML = '';
            document.getElementById('prestamoTotalCalibreSeleccionado').textContent = '0 Kg';
            document.getElementById('resumenLotePrestamo').innerHTML = '';
        }

        function renderHistorialPrestamos() {
            const container = document.getElementById('historialPrestamosBody');
            const noPrestamosMsg = document.getElementById('noPrestamosMessage');
            const prestamosCount = document.getElementById('prestamosCount');
            const table = document.getElementById('historialPrestamosTable');

            prestamosCount.textContent = prestamosData.length;

            if (prestamosData.length === 0) {
                table.style.display = 'none';
                noPrestamosMsg.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noPrestamosMsg.style.display = 'none';

            // Ordenar por fecha m√°s reciente
            const prestamosOrdenados = [...prestamosData].sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));

            let html = '';
            prestamosOrdenados.forEach(p => {
                const estadoColor = p.estado === 'devuelto' ? '#16a34a' : (p.estado === 'parcial' ? '#f59e0b' : '#ef4444');
                const estadoTexto = p.estado === 'devuelto' ? 'Devuelto' : (p.estado === 'parcial' ? 'Parcial' : 'Pendiente');

                html += '<tr style="border-bottom: 1px solid #e2e8f0;">';
                html += '<td style="padding: 0.8rem;">' + formatDate(p.fecha) + '</td>';
                html += '<td style="padding: 0.8rem; font-weight: 600;">' + (p.codigoLote || '-') + '</td>';
                html += '<td style="padding: 0.8rem;">' + (p.destinatario || '-') + '</td>';
                html += '<td style="padding: 0.8rem;">' + (p.bodega || '-') + '</td>';
                html += '<td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #f59e0b;">' + (p.kgTotal || 0).toFixed(1) + ' Kg</td>';
                html += '<td style="padding: 0.8rem; text-align: center;"><span style="background: ' + estadoColor + '; color: white; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem;">' + estadoTexto + '</span></td>';
                html += '<td style="padding: 0.8rem; text-align: center;">';
                html += '<button onclick="verDetallePrestamo(' + p.id + ')" style="background: #3b82f6; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 5px; font-size: 0.75rem; cursor: pointer; margin-right: 0.3rem;">üëÅÔ∏è</button>';
                html += '<button onclick="eliminarPrestamo(' + p.id + ')" style="background: #ef4444; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 5px; font-size: 0.75rem; cursor: pointer;">üóëÔ∏è</button>';
                html += '</td>';
                html += '</tr>';
            });

            container.innerHTML = html;
        }

        function verDetallePrestamo(id) {
            const prestamo = prestamosData.find(p => p.id === id);
            if (!prestamo) {
                mostrarModalInfo('Error', '<p style="text-align: center; color: #dc2626;">Pr√©stamo no encontrado</p>', '‚ùå');
                return;
            }

            const estadoColor = prestamo.estado === 'devuelto' ? '#16a34a' : (prestamo.estado === 'parcial' ? '#f59e0b' : '#ef4444');
            const estadoTexto = prestamo.estado === 'devuelto' ? 'Devuelto' : (prestamo.estado === 'parcial' ? 'Devoluci√≥n Parcial' : 'Pendiente de Devoluci√≥n');
            const tipoPrestamoTexto = prestamo.modoPrestamo === 'lote' ? 'üì¶ Lote Completo' : '‚öñÔ∏è Calibres Espec√≠ficos';

            let contenido = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Lote</div><div style="font-weight: 600; color: #1e293b;">' + (prestamo.codigoLote || '-') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Fecha</div><div style="color: #1e293b;">' + formatDate(prestamo.fecha) + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Responsable</div><div style="color: #1e293b;">' + (prestamo.responsable || '-') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Tipo</div><div style="color: #1e293b;">' + tipoPrestamoTexto + '</div></div>';
            contenido += '</div>';

            // Mostrar calibres si es pr√©stamo por calibres
            if (prestamo.calibres && prestamo.calibres.length > 0) {
                contenido += '<div style="background: #f8fafc; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">';
                contenido += '<div style="font-size: 0.8rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">üì¶ CALIBRES PRESTADOS</div>';
                prestamo.calibres.forEach(c => {
                    contenido += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #e2e8f0;">';
                    contenido += '<span style="font-weight: 500;">' + c.calibre + '</span>';
                    contenido += '<span style="color: #f59e0b; font-weight: 600;">' + c.bidones + ' bid √ó ' + c.kgBidon + ' Kg = ' + c.kgTotal.toFixed(1) + ' Kg</span>';
                    contenido += '</div>';
                });
                contenido += '</div>';
            } else if (prestamo.calibreTexto) {
                contenido += '<div style="background: #f8fafc; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">';
                contenido += '<div style="font-size: 0.8rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">üì¶ DETALLE</div>';
                contenido += '<div style="font-weight: 500;">' + prestamo.calibreTexto + '</div>';
                contenido += '</div>';
            }

            contenido += '<div style="background: #fef3c7; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">';
            contenido += '<div style="font-size: 0.8rem; color: #92400e; font-weight: 600; margin-bottom: 0.5rem;">üè™ DESTINATARIO</div>';
            contenido += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">';
            contenido += '<div><strong>Nombre:</strong> ' + (prestamo.destinatario || '-') + '</div>';
            contenido += '<div><strong>Bodega:</strong> ' + (prestamo.bodega || '-') + '</div>';
            if (prestamo.direccion) contenido += '<div style="grid-column: span 2;"><strong>Direcci√≥n:</strong> ' + prestamo.direccion + '</div>';
            if (prestamo.telefono) contenido += '<div><strong>Tel√©fono:</strong> ' + prestamo.telefono + '</div>';
            contenido += '</div></div>';

            contenido += '<div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1rem; border-radius: 10px; text-align: center; margin-bottom: 1rem;">';
            contenido += '<div style="font-size: 0.8rem; opacity: 0.9;">TOTAL PRESTADO</div>';
            contenido += '<div style="font-size: 1.3rem; font-weight: 700;">' + (prestamo.bidones || 0) + ' bidones = ' + (prestamo.kgTotal || 0).toFixed(1) + ' Kg</div>';
            contenido += '</div>';

            contenido += '<div style="text-align: center;"><span style="background: ' + estadoColor + '; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 600;">' + estadoTexto + '</span></div>';

            if (prestamo.observaciones) {
                contenido += '<div style="margin-top: 1rem; padding: 0.8rem; background: #f8fafc; border-radius: 8px;"><strong>Observaciones:</strong> ' + prestamo.observaciones + '</div>';
            }

            mostrarModalInfo('Detalle de Pr√©stamo', contenido, 'ü§ù');
        }

        var prestamoIdParaEliminar = null;

        function eliminarPrestamo(id) {
            prestamoIdParaEliminar = id;
            var html = '<div id="modalConfirmarEliminarPrestamo" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üóëÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Eliminar Pr√©stamo</h3></div>';
            html += '<button onclick="cerrarModalEliminarPrestamo()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem; text-align: center;">';
            html += '<p style="color: #1e293b; margin-bottom: 0.5rem;">¬øEst√°s seguro de eliminar este pr√©stamo?</p>';
            html += '<p style="color: #dc2626; font-size: 0.85rem;">Esta acci√≥n no se puede deshacer.</p>';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalEliminarPrestamo()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarEliminarPrestamo()" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Eliminar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalEliminarPrestamo() {
            var modal = document.getElementById('modalConfirmarEliminarPrestamo');
            if (modal) modal.remove();
            prestamoIdParaEliminar = null;
        }

        function confirmarEliminarPrestamo() {
            if (prestamoIdParaEliminar !== null) {
                var index = prestamosData.findIndex(function (p) { return p.id === prestamoIdParaEliminar; });
                if (index !== -1) {
                    prestamosData.splice(index, 1);
                    localStorage.setItem('prestamosData', JSON.stringify(prestamosData));
                    renderHistorialPrestamos();
                    cerrarModalEliminarPrestamo();
                    mostrarModalInfo('√âxito', '<p style="text-align: center; color: #16a34a;">Pr√©stamo eliminado correctamente</p>', '‚úÖ');
                }
            }
        }


        function seleccionarTipoVenta(tipo) {
            tipoVentaSeleccionado = tipo;

            // Visual update
            document.getElementById('btnExportacion').style.background = tipo === 'exportacion' ? '#16a34a' : '#f1f5f9';
            document.getElementById('btnExportacion').style.color = tipo === 'exportacion' ? 'white' : '#1e293b';
            document.getElementById('btnExportacion').style.borderColor = tipo === 'exportacion' ? '#16a34a' : '#e2e8f0';

            document.getElementById('btnMercadoNacional').style.background = tipo === 'nacional' ? '#f59e0b' : '#f1f5f9';
            document.getElementById('btnMercadoNacional').style.color = tipo === 'nacional' ? 'white' : '#1e293b';
            document.getElementById('btnMercadoNacional').style.borderColor = tipo === 'nacional' ? '#f59e0b' : '#e2e8f0';

            // Show form
            document.getElementById('formVenta').style.display = 'block';

            // Show/hide destino sections
            document.getElementById('destinoExportacion').style.display = tipo === 'exportacion' ? 'block' : 'none';
            document.getElementById('destinoNacional').style.display = tipo === 'nacional' ? 'block' : 'none';
        }

        function cargarLotesParaVenta() {
            const select = document.getElementById('ventaLote');
            select.innerHTML = '<option value="">Seleccionar lote...</option>';

            entries.forEach(entry => {
                if (entry.codigoLote) {
                    const totalKg = entry.calibres && entry.calibres.length > 0
                        ? entry.calibres.reduce((sum, c) => sum + (parseFloat(c.subtotal) || 0), 0).toFixed(1) + ' Kg'
                        : 'Sin calibres';
                    select.innerHTML += `<option value="${entry.id}">${entry.codigoLote} - ${formatDate(entry.fecha)} (${totalKg})</option>`;
                }
            });

            // Ocultar panel de info
            document.getElementById('ventaInfoLote').style.display = 'none';
        }

        function cargarLotesParaReubicacion() {
            const select = document.getElementById('reubicacionLote');
            select.innerHTML = '<option value="">Seleccionar lote...</option>';

            entries.forEach(entry => {
                if (entry.codigoLote) {
                    const totalKg = entry.calibres && entry.calibres.length > 0
                        ? entry.calibres.reduce((sum, c) => sum + (parseFloat(c.subtotal) || 0), 0).toFixed(1) + ' Kg'
                        : 'Sin calibres';
                    select.innerHTML += `<option value="${entry.id}">${entry.codigoLote} - ${formatDate(entry.fecha)} (${totalKg})</option>`;
                }
            });

            // Ocultar panel de info y limpiar calibre
            document.getElementById('reubicacionInfoLote').style.display = 'none';
            document.getElementById('reubicacionCalibre').innerHTML = '<option value="">Seleccionar...</option>';
        }

        function cargarCalibresPorLote(tipo) {
            let loteId, infoPanel, infoCodigo, infoVendedor, infoVariedad, infoStock, infoCalibres;

            if (tipo === 'venta') {
                loteId = document.getElementById('ventaLote').value;
                infoPanel = document.getElementById('ventaInfoLote');
                infoCodigo = document.getElementById('ventaInfoCodigo');
                infoVendedor = document.getElementById('ventaInfoVendedor');
                infoVariedad = document.getElementById('ventaInfoVariedad');
                infoStock = document.getElementById('ventaInfoStock');
                infoCalibres = document.getElementById('ventaInfoCalibres');
            } else if (tipo === 'reubicacion') {
                loteId = document.getElementById('reubicacionLote').value;
                infoPanel = document.getElementById('reubicacionInfoLote');
                infoCodigo = document.getElementById('reubicacionInfoCodigo');
                infoVendedor = document.getElementById('reubicacionInfoVendedor');
                infoVariedad = document.getElementById('reubicacionInfoVariedad');
                infoStock = document.getElementById('reubicacionInfoStock');
                infoCalibres = document.getElementById('reubicacionInfoCalibres');
                // Limpiar selector de calibre para reubicaci√≥n
                document.getElementById('reubicacionCalibre').innerHTML = '<option value="">Seleccionar...</option>';
            } else {
                return;
            }

            // Si no hay lote seleccionado, ocultar paneles
            if (!loteId) {
                infoPanel.style.display = 'none';
                if (tipo === 'venta') {
                    document.getElementById('ventaDetalleLote').style.display = 'none';
                }
                return;
            }

            // Buscar la entrada del lote
            const entry = entries.find(e => e.id == loteId);
            if (!entry) {
                infoPanel.style.display = 'none';
                if (tipo === 'venta') {
                    document.getElementById('ventaDetalleLote').style.display = 'none';
                }
                return;
            }

            // Calcular stock total
            let stockTotal = 0;
            if (entry.calibres && entry.calibres.length > 0) {
                stockTotal = entry.calibres.reduce((sum, c) => sum + (parseFloat(c.subtotal) || 0), 0);
            }

            // Actualizar informaci√≥n del panel
            infoCodigo.textContent = entry.codigoLote || '-';
            infoVendedor.textContent = entry.vendedor || '-';
            infoVariedad.textContent = entry.variedad || '-';
            infoStock.textContent = stockTotal.toFixed(1) + ' Kg';

            // Generar tags de calibres disponibles
            let calibresHTML = '';
            if (entry.calibres && entry.calibres.length > 0) {
                entry.calibres.forEach(calibre => {
                    const bgColor = tipo === 'venta' ? '#dcfce7' : '#ddd6fe';
                    const textColor = tipo === 'venta' ? '#16a34a' : '#7c3aed';
                    calibresHTML += `
                        <div style="background: ${bgColor}; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem;">
                            <span style="font-weight: 600; color: ${textColor};">${calibre.calibre}</span>
                            <span style="color: #64748b; margin-left: 0.3rem;">${calibre.subtotal || 0} Kg</span>
                        </div>
                    `;
                    // Para reubicaci√≥n, agregar al selector
                    if (tipo === 'reubicacion') {
                        document.getElementById('reubicacionCalibre').innerHTML += `<option value="${calibre.calibre}">${calibre.calibre} (${calibre.subtotal || 0} Kg disponibles)</option>`;
                    }
                });
            } else {
                calibresHTML = '<span style="color: #94a3b8; font-style: italic;">Sin calibres registrados</span>';
            }
            infoCalibres.innerHTML = calibresHTML;

            // Mostrar panel de info
            infoPanel.style.display = 'block';

            // Para ventas, tambi√©n mostrar la tabla de detalle del lote
            if (tipo === 'venta') {
                mostrarDetalleLoteVenta(entry);
            }
        }

        // Mostrar tabla con todos los calibres del lote para la venta
        function mostrarDetalleLoteVenta(entry) {
            const tabla = document.getElementById('ventaCalibresTabla');
            const detallePanel = document.getElementById('ventaDetalleLote');
            const totalLabel = document.getElementById('ventaTotalKgLote');

            let html = '';
            let totalKg = 0;

            if (entry.calibres && entry.calibres.length > 0) {
                entry.calibres.forEach(calibre => {
                    const subtotal = parseFloat(calibre.subtotal) || 0;
                    totalKg += subtotal;
                    html += `
                        <tr style="border-bottom: 1px solid #bbf7d0;">
                            <td style="padding: 0.6rem; font-weight: 600; color: #16a34a;">${calibre.calibre}</td>
                            <td style="padding: 0.6rem; text-align: center;">${calibre.bidones || 0}</td>
                            <td style="padding: 0.6rem; text-align: center;">${calibre.kilosPorBidon || 0} Kg</td>
                            <td style="padding: 0.6rem; text-align: center;">${calibre.sobras || 0} Kg</td>
                            <td style="padding: 0.6rem; text-align: right; font-weight: 700; color: #16a34a;">${subtotal.toFixed(1)} Kg</td>
                        </tr>
                    `;
                });
            } else {
                html = '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #94a3b8;">Sin calibres registrados</td></tr>';
            }

            tabla.innerHTML = html;
            totalLabel.textContent = 'Total: ' + totalKg.toFixed(1) + ' Kg';
            detallePanel.style.display = 'block';
        }

        function calcularKgTotalVenta() {
            const bidones = parseFloat(document.getElementById('ventaBidones').value) || 0;
            const kgBidon = parseFloat(document.getElementById('ventaKgBidon').value) || 0;
            const total = bidones * kgBidon;
            document.getElementById('ventaKgTotal').value = total.toFixed(1) + ' Kg';
        }

        function calcularKgTotalReubicacion() {
            const bidones = parseFloat(document.getElementById('reubicacionBidones').value) || 0;
            const kgBidon = parseFloat(document.getElementById('reubicacionKgBidon').value) || 0;
            const total = bidones * kgBidon;
            document.getElementById('reubicacionKgTotal').value = total.toFixed(1) + ' Kg';
        }

        function limpiarFormVenta() {
            document.getElementById('ventaResponsable').value = '';
            document.getElementById('ventaFechaRegistro').value = new Date().toISOString().split('T')[0];
            document.getElementById('ventaLote').value = '';
            document.getElementById('ventaPais').value = '';
            document.getElementById('ventaClienteExport').value = '';
            document.getElementById('ventaCiudad').value = '';
            document.getElementById('ventaDistrito').value = '';
            document.getElementById('ventaClienteNacional').value = '';
            // Ocultar paneles de info del lote
            document.getElementById('ventaInfoLote').style.display = 'none';
            document.getElementById('ventaDetalleLote').style.display = 'none';
            document.getElementById('ventaCalibresTabla').innerHTML = '';
        }

        function limpiarFormReubicacion() {
            document.getElementById('reubicacionResponsable').value = '';
            document.getElementById('reubicacionFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('reubicacionLote').value = '';
            document.getElementById('reubicacionDestinoNuevo').value = '';
            document.getElementById('reubicacionCalibre').innerHTML = '<option value="">Seleccionar...</option>';
            document.getElementById('reubicacionBidones').value = '';
            document.getElementById('reubicacionKgBidon').value = '';
            document.getElementById('reubicacionKgTotal').value = '0 Kg';
            // Ocultar panel de info del lote
            document.getElementById('reubicacionInfoLote').style.display = 'none';
        }

        function guardarVenta() {
            const responsable = document.getElementById('ventaResponsable').value.trim();
            const fecha = document.getElementById('ventaFechaRegistro').value;
            const loteId = document.getElementById('ventaLote').value;

            // Validations
            if (!tipoVentaSeleccionado) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione el tipo de venta (Exportaci√≥n o Mercado Nacional)</p>', '‚ö†Ô∏è');
                return;
            }
            if (!responsable) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el responsable</p>', '‚ö†Ô∏è'); return; }
            if (!fecha) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese la fecha</p>', '‚ö†Ô∏è'); return; }
            if (!loteId) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione el lote</p>', '‚ö†Ô∏è'); return; }

            // Obtener informaci√≥n del lote
            const entry = entries.find(e => e.id == loteId);
            if (!entry) { mostrarModalInfo('Error', '<p style="text-align: center; color: #dc2626;">No se encontr√≥ la informaci√≥n del lote</p>', '‚ùå'); return; }
            if (!entry.calibres || entry.calibres.length === 0) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">El lote no tiene calibres registrados</p>', '‚ö†Ô∏è'); return; }

            let destino = {};
            if (tipoVentaSeleccionado === 'exportacion') {
                const pais = document.getElementById('ventaPais').value;
                const cliente = document.getElementById('ventaClienteExport').value.trim();
                if (!pais) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione el pa√≠s de destino</p>', '‚ö†Ô∏è'); return; }
                if (!cliente) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el nombre del cliente</p>', '‚ö†Ô∏è'); return; }
                destino = { pais: pais, cliente: cliente };
            } else {
                const ciudad = document.getElementById('ventaCiudad').value.trim();
                const cliente = document.getElementById('ventaClienteNacional').value.trim();
                if (!ciudad) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese la ciudad de destino</p>', '‚ö†Ô∏è'); return; }
                if (!cliente) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el nombre del cliente</p>', '‚ö†Ô∏è'); return; }
                destino = {
                    ciudad: ciudad,
                    distrito: document.getElementById('ventaDistrito').value.trim(),
                    cliente: cliente
                };
            }

            // Calcular totales del lote
            let totalBidones = 0;
            let totalKg = 0;
            entry.calibres.forEach(c => {
                totalBidones += parseInt(c.bidones) || 0;
                totalKg += parseFloat(c.subtotal) || 0;
            });

            const venta = {
                id: Date.now(),
                tipo: 'venta',
                tipoVenta: tipoVentaSeleccionado,
                responsable: responsable,
                fecha: fecha,
                loteId: loteId,
                codigoLote: entry.codigoLote || loteId,
                vendedor: entry.vendedor || '-',
                variedad: entry.variedad || '-',
                calibres: entry.calibres, // Guardar todos los calibres
                totalBidones: totalBidones,
                kgTotal: totalKg,
                destino: destino,
                fechaRegistro: new Date().toISOString()
            };

            salidasData.push(venta);
            localStorage.setItem('salidasData', JSON.stringify(salidasData));

            var contenidoExito = '<div style="text-align: center; margin-bottom: 1rem;">';
            contenidoExito += '<div style="font-size: 3rem; margin-bottom: 0.5rem;">‚úÖ</div>';
            contenidoExito += '<div style="font-size: 1.2rem; font-weight: 700; color: #16a34a;">Venta Registrada Exitosamente</div>';
            contenidoExito += '</div>';
            contenidoExito += '<div style="background: #f8fafc; border-radius: 10px; padding: 1rem;">';
            contenidoExito += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">TIPO</span><div style="font-weight: 600;">' + (tipoVentaSeleccionado === 'exportacion' ? 'üåç Exportaci√≥n' : 'üè† Mercado Nacional') + '</div></div>';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">LOTE</span><div style="font-weight: 600;">' + entry.codigoLote + '</div></div>';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">CALIBRES</span><div style="font-weight: 600;">' + entry.calibres.length + '</div></div>';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">TOTAL BIDONES</span><div style="font-weight: 600;">' + totalBidones + '</div></div>';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">TOTAL KG</span><div style="font-weight: 600; color: #16a34a;">' + totalKg.toFixed(1) + ' Kg</div></div>';
            contenidoExito += '<div><span style="color: #64748b; font-size: 0.75rem;">DESTINO</span><div style="font-weight: 600;">' + (tipoVentaSeleccionado === 'exportacion' ? destino.pais : destino.ciudad) + '</div></div>';
            contenidoExito += '<div style="grid-column: span 2;"><span style="color: #64748b; font-size: 0.75rem;">CLIENTE</span><div style="font-weight: 600;">' + destino.cliente + '</div></div>';
            contenidoExito += '</div></div>';
            mostrarModalInfo('Venta Registrada', contenidoExito, 'üìã');

            limpiarFormVenta();
            tipoVentaSeleccionado = '';
            document.getElementById('btnExportacion').style.background = '#f1f5f9';
            document.getElementById('btnExportacion').style.color = '#1e293b';
            document.getElementById('btnMercadoNacional').style.background = '#f1f5f9';
            document.getElementById('btnMercadoNacional').style.color = '#1e293b';
            document.getElementById('formVenta').style.display = 'none';
            document.getElementById('destinoExportacion').style.display = 'none';
            document.getElementById('destinoNacional').style.display = 'none';

            // Actualizar historial de ventas
            renderHistorialVentas();
        }

        function guardarReubicacion() {
            const responsable = document.getElementById('reubicacionResponsable').value.trim();
            const fecha = document.getElementById('reubicacionFecha').value;
            const loteId = document.getElementById('reubicacionLote').value;
            const destino = document.getElementById('reubicacionDestinoNuevo').value.trim();
            const calibre = document.getElementById('reubicacionCalibre').value;
            const bidones = parseFloat(document.getElementById('reubicacionBidones').value) || 0;
            const kgBidon = parseFloat(document.getElementById('reubicacionKgBidon').value) || 0;

            // Validations
            if (!responsable) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el responsable</p>', '‚ö†Ô∏è'); return; }
            if (!fecha) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese la fecha</p>', '‚ö†Ô∏è'); return; }
            if (!loteId) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione un lote</p>', '‚ö†Ô∏è'); return; }
            if (!destino) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el destino</p>', '‚ö†Ô∏è'); return; }
            if (!calibre) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione el calibre</p>', '‚ö†Ô∏è'); return; }
            if (bidones <= 0) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese el n√∫mero de bidones</p>', '‚ö†Ô∏è'); return; }
            if (kgBidon <= 0) { mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese los kg por bid√≥n</p>', '‚ö†Ô∏è'); return; }

            // Obtener info del lote para el registro
            const entry = entries.find(e => e.id == loteId);
            const codigoLote = entry ? entry.codigoLote : loteId;

            const reubicacion = {
                id: Date.now(),
                tipo: 'reubicacion',
                responsable: responsable,
                fecha: fecha,
                loteId: loteId,
                codigoLote: codigoLote,
                destino: destino,
                calibre: calibre,
                bidones: bidones,
                kgBidon: kgBidon,
                kgTotal: bidones * kgBidon,
                fechaRegistro: new Date().toISOString()
            };

            salidasData.push(reubicacion);
            localStorage.setItem('salidasData', JSON.stringify(salidasData));

            var msgReub = '<div style="text-align: center;"><div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>';
            msgReub += '<div style="font-weight: 700; color: #16a34a; margin-bottom: 1rem;">Reubicaci√≥n Registrada</div></div>';
            msgReub += '<div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">';
            msgReub += '<div><span style="color: #64748b; font-size: 0.75rem;">DESTINO</span><div style="font-weight: 600;">' + destino + '</div></div>';
            msgReub += '<div style="margin-top: 0.5rem;"><span style="color: #64748b; font-size: 0.75rem;">CALIBRE</span><div style="font-weight: 600;">' + calibre + '</div></div>';
            msgReub += '<div style="margin-top: 0.5rem;"><span style="color: #64748b; font-size: 0.75rem;">TOTAL</span><div style="font-weight: 600; color: #16a34a;">' + (bidones * kgBidon).toFixed(1) + ' Kg</div></div>';
            msgReub += '</div>';
            mostrarModalInfo('Reubicaci√≥n', msgReub, 'üì¶');

            limpiarFormReubicacion();

            // Volver al almac√©n si vinimos de ah√≠
            if (window.reubicacionOrigenAlmacen) {
                volverDesdeReubicacion();
            }
        }

        // ========== HISTORIAL DE VENTAS FUNCTIONS ==========
        function renderHistorialVentas() {
            const container = document.getElementById('historialVentasBody');
            const noVentasMsg = document.getElementById('noVentasMessage');
            const ventasCount = document.getElementById('ventasCount');
            const table = document.getElementById('historialVentasTable');

            // Filtrar solo ventas (no reubicaciones)
            const ventas = salidasData.filter(s => s.tipo === 'venta');

            ventasCount.textContent = ventas.length;

            if (ventas.length === 0) {
                table.style.display = 'none';
                noVentasMsg.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noVentasMsg.style.display = 'none';

            // Ordenar por fecha m√°s reciente
            ventas.sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));

            let html = '';
            ventas.forEach(venta => {
                const fechaFormatted = formatDate(venta.fecha);
                const tipoLabel = venta.tipoVenta === 'exportacion'
                    ? '<span style="background: #dbeafe; color: #1d4ed8; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">üåç Exportaci√≥n</span>'
                    : '<span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">üáµüá™ Nacional</span>';

                const cliente = venta.destino?.cliente || '-';
                const destino = venta.tipoVenta === 'exportacion'
                    ? venta.destino?.pais || '-'
                    : venta.destino?.ciudad || '-';

                // Generar resumen de calibres
                let calibresResumen = '-';
                if (venta.calibres && venta.calibres.length > 0) {
                    calibresResumen = venta.calibres.map(c => c.calibre).join(', ');
                    if (calibresResumen.length > 30) {
                        calibresResumen = calibresResumen.substring(0, 27) + '...';
                    }
                }

                html += `
                    <tr style="border-bottom: 1px solid #e2e8f0; transition: background 0.2s;" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='white'">
                        <td style="padding: 0.8rem; color: #64748b;">${fechaFormatted}</td>
                        <td style="padding: 0.8rem; font-weight: 600; color: #1e293b;">${venta.codigoLote || venta.loteId}</td>
                        <td style="padding: 0.8rem; text-align: center;">${tipoLabel}</td>
                        <td style="padding: 0.8rem;">${cliente}</td>
                        <td style="padding: 0.8rem;">${destino}</td>
                        <td style="padding: 0.8rem; text-align: right; font-weight: 700; color: #16a34a;">${(venta.kgTotal || 0).toFixed(1)} Kg</td>
                        <td style="padding: 0.8rem; text-align: center; font-size: 0.8rem; color: #64748b;" title="${calibresResumen}">${venta.calibres?.length || 0} calibres</td>
                        <td style="padding: 0.8rem; text-align: center;">
                            <button onclick="verDetalleVenta(${venta.id})" 
                                style="background: #e0f2fe; border: none; padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; margin-right: 0.3rem;" 
                                title="Ver detalle">üëÅÔ∏è</button>
                            <button onclick="editarVenta(${venta.id})" 
                                style="background: #fef3c7; border: none; padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; margin-right: 0.3rem;" 
                                title="Editar">‚úèÔ∏è</button>
                            <button onclick="eliminarVenta(${venta.id})" 
                                style="background: #fee2e2; border: none; padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: #dc2626;" 
                                title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
        }

        function verDetalleVenta(id) {
            const venta = salidasData.find(s => s.id === id);
            if (!venta) {
                mostrarModalInfo('Error', '<p style="color: #dc2626;">Venta no encontrada</p>', '‚ùå');
                return;
            }

            let calibresHTML = '';
            if (venta.calibres && venta.calibres.length > 0) {
                calibresHTML = '<div style="margin-top: 1rem;">';
                venta.calibres.forEach(c => {
                    calibresHTML += '<div style="background: #f8fafc; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #3d4f31;">';
                    calibresHTML += '<div style="font-weight: 600; color: #1e293b;">' + (c.calibre || '-') + '</div>';
                    calibresHTML += '<div style="font-size: 0.85rem; color: #64748b;">' + (c.bidones || 0) + ' bidones √ó ' + (c.kilosPorBidon || 0) + ' Kg + ' + (c.sobras || 0) + ' Kg sobras = <strong style="color: #16a34a;">' + (c.subtotal || 0) + ' Kg</strong></div>';
                    calibresHTML += '</div>';
                });
                calibresHTML += '</div>';
            }

            const destinoInfo = venta.tipoVenta === 'exportacion'
                ? 'Pa√≠s: ' + (venta.destino?.pais || '-')
                : 'Ciudad: ' + (venta.destino?.ciudad || '-') + ', Distrito: ' + (venta.destino?.distrito || '-');

            let contenido = '';
            contenido += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Lote</div><div style="font-weight: 600; color: #1e293b;">' + (venta.codigoLote || '-') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Fecha</div><div style="color: #1e293b;">' + formatDate(venta.fecha) + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Tipo</div><div style="color: #1e293b;">' + (venta.tipoVenta === 'exportacion' ? 'üåç Exportaci√≥n' : 'üè† Mercado Nacional') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Responsable</div><div style="color: #1e293b;">' + (venta.responsable || '-') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Cliente</div><div style="color: #1e293b;">' + (venta.destino?.cliente || '-') + '</div></div>';
            contenido += '<div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">Destino</div><div style="color: #1e293b;">' + destinoInfo + '</div></div>';
            contenido += '</div>';

            contenido += '<div style="border-top: 1px solid #e2e8f0; padding-top: 1rem;">';
            contenido += '<div style="font-size: 0.8rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">CALIBRES:</div>';
            contenido += calibresHTML;
            contenido += '</div>';

            contenido += '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1rem; border-radius: 10px; margin-top: 1rem; text-align: center;">';
            contenido += '<div style="font-size: 0.8rem; opacity: 0.9;">TOTAL</div>';
            contenido += '<div style="font-size: 1.3rem; font-weight: 700;">' + (venta.totalBidones || 0) + ' bidones = ' + (venta.kgTotal || 0).toFixed(1) + ' Kg</div>';
            contenido += '</div>';

            mostrarModalInfo('Detalle de Venta', contenido, 'üìã');
        }

        function editarVenta(id) {
            const venta = salidasData.find(s => s.id === id);
            if (!venta) {
                mostrarModalInfo('Error', '<p style="text-align: center; color: #dc2626;">Venta no encontrada</p>', '‚ùå');
                return;
            }

            // Crear modal de edici√≥n
            const modalHtml = `
                <div id="editarVentaModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 16px 16px 0 0;">
                            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">‚úèÔ∏è Editar Venta</h2>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.85rem;">Lote: ${venta.codigoLote}</p>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">TIPO DE VENTA</label>
                                <select id="editVentaTipo" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                                    <option value="exportacion" ${venta.tipoVenta === 'exportacion' ? 'selected' : ''}>Exportaci√≥n</option>
                                    <option value="nacional" ${venta.tipoVenta === 'nacional' ? 'selected' : ''}>Mercado Nacional</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">CLIENTE</label>
                                <input type="text" id="editVentaCliente" value="${venta.destino?.cliente || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <div id="editDestinoExport" style="${venta.tipoVenta === 'exportacion' ? '' : 'display: none;'} margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">PA√çS DESTINO</label>
                                <input type="text" id="editVentaPais" value="${venta.destino?.pais || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <div id="editDestinoNacional" style="${venta.tipoVenta === 'nacional' ? '' : 'display: none;'}">
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">CIUDAD</label>
                                    <input type="text" id="editVentaCiudad" value="${venta.destino?.ciudad || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">DISTRITO</label>
                                    <input type="text" id="editVentaDistrito" value="${venta.destino?.distrito || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">RESPONSABLE</label>
                                <input type="text" id="editVentaResponsable" value="${venta.responsable || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600;">FECHA</label>
                                <input type="date" id="editVentaFecha" value="${venta.fecha || ''}" style="width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button onclick="cerrarEditarVenta()" style="flex: 1; padding: 0.8rem; border: 1px solid #e2e8f0; background: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    Cancelar
                                </button>
                                <button onclick="guardarEdicionVenta(${venta.id})" style="flex: 1; padding: 0.8rem; border: none; background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    üíæ Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Agregar evento para cambiar tipo de venta
            document.getElementById('editVentaTipo').addEventListener('change', function () {
                const tipo = this.value;
                document.getElementById('editDestinoExport').style.display = tipo === 'exportacion' ? 'block' : 'none';
                document.getElementById('editDestinoNacional').style.display = tipo === 'nacional' ? 'block' : 'none';
            });
        }

        function cerrarEditarVenta() {
            const modal = document.getElementById('editarVentaModal');
            if (modal) modal.remove();
        }

        function guardarEdicionVenta(id) {
            const index = salidasData.findIndex(s => s.id === id);
            if (index === -1) {
                mostrarModalInfo('Error', '<p style="text-align: center; color: #dc2626;">Venta no encontrada</p>', '‚ùå');
                return;
            }

            const tipoVenta = document.getElementById('editVentaTipo').value;
            const cliente = document.getElementById('editVentaCliente').value.trim();
            const responsable = document.getElementById('editVentaResponsable').value.trim();
            const fecha = document.getElementById('editVentaFecha').value;

            // Actualizar datos
            salidasData[index].tipoVenta = tipoVenta;
            salidasData[index].responsable = responsable;
            salidasData[index].fecha = fecha;

            if (!salidasData[index].destino) {
                salidasData[index].destino = {};
            }

            salidasData[index].destino.cliente = cliente;

            if (tipoVenta === 'exportacion') {
                salidasData[index].destino.pais = document.getElementById('editVentaPais').value.trim();
            } else {
                salidasData[index].destino.ciudad = document.getElementById('editVentaCiudad').value.trim();
                salidasData[index].destino.distrito = document.getElementById('editVentaDistrito').value.trim();
            }

            // Guardar en localStorage
            localStorage.setItem('salidasData', JSON.stringify(salidasData));

            // Cerrar modal y actualizar tabla
            cerrarEditarVenta();
            renderHistorialVentas();

            mostrarModalInfo('√âxito', '<p style="text-align: center; color: #16a34a;">‚úÖ Venta actualizada correctamente</p>', '‚úÖ');
        }

        var ventaIdParaEliminar = null;

        function eliminarVenta(id) {
            ventaIdParaEliminar = id;
            var html = '<div id="modalConfirmarEliminarVenta" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üóëÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Eliminar Venta</h3></div>';
            html += '<button onclick="cerrarModalEliminarVenta()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem; text-align: center;">';
            html += '<p style="color: #1e293b; margin-bottom: 0.5rem;">¬øEst√°s seguro de eliminar esta venta?</p>';
            html += '<p style="color: #dc2626; font-size: 0.85rem;">Esta acci√≥n no se puede deshacer.</p>';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalEliminarVenta()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarEliminarVenta()" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Eliminar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalEliminarVenta() {
            var modal = document.getElementById('modalConfirmarEliminarVenta');
            if (modal) modal.remove();
            ventaIdParaEliminar = null;
        }

        function confirmarEliminarVenta() {
            if (ventaIdParaEliminar !== null) {
                var index = salidasData.findIndex(function (s) { return s.id === ventaIdParaEliminar; });
                if (index !== -1) {
                    salidasData.splice(index, 1);
                    localStorage.setItem('salidasData', JSON.stringify(salidasData));
                    renderHistorialVentas();
                    cerrarModalEliminarVenta();
                    mostrarModalInfo('√âxito', '<p style="text-align: center; color: #16a34a;">Venta eliminada correctamente</p>', '‚úÖ');
                }
            }
        }

        // ========== RECORD HIST√ìRICO FUNCTIONS ==========
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Inicializar el selector de a√±os
        function initRecordAnos() {
            const select = document.getElementById('recordAnoSelect');
            if (!select) return;

            // Obtener a√±os √∫nicos de las ventas
            const ventas = salidasData.filter(s => s.tipo === 'venta');
            const anos = new Set();
            const currentYear = new Date().getFullYear();
            anos.add(currentYear); // Siempre incluir el a√±o actual

            ventas.forEach(v => {
                const fecha = new Date(v.fecha);
                if (!isNaN(fecha)) {
                    anos.add(fecha.getFullYear());
                }
            });

            // Ordenar a√±os descendente
            const anosOrdenados = Array.from(anos).sort((a, b) => b - a);

            select.innerHTML = '';
            anosOrdenados.forEach(ano => {
                select.innerHTML += `<option value="${ano}">${ano}</option>`;
            });
        }

        // Calcular datos de ventas por mes para un a√±o
        function calcularDatosMensuales(ano) {
            const ventas = salidasData.filter(s => s.tipo === 'venta');
            const datosMensuales = Array(12).fill(null).map(() => ({
                ventas: 0,
                exportacion: 0,
                nacional: 0,
                kgVendidos: 0,
                ingresos: 0
            }));

            ventas.forEach(venta => {
                const fecha = new Date(venta.fecha);
                if (isNaN(fecha) || fecha.getFullYear() !== parseInt(ano)) return;

                const mes = fecha.getMonth();
                datosMensuales[mes].ventas++;
                datosMensuales[mes].kgVendidos += parseFloat(venta.kgTotal) || 0;

                if (venta.tipoVenta === 'exportacion') {
                    datosMensuales[mes].exportacion++;
                } else {
                    datosMensuales[mes].nacional++;
                }

                // Calcular ingresos (usamos un precio estimado por Kg si no est√° definido)
                // Por ahora usamos el kgTotal * un precio base estimado
                // En el futuro podr√≠as agregar el precio de venta a cada venta
                const precioEstimadoPorKg = 8; // Soles por Kg (ajustable)
                datosMensuales[mes].ingresos += (parseFloat(venta.kgTotal) || 0) * precioEstimadoPorKg;
            });

            return datosMensuales;
        }

        // Renderizar todo el record hist√≥rico
        function renderRecordHistorico() {
            const anoSelect = document.getElementById('recordAnoSelect');
            if (!anoSelect) return;

            const ano = anoSelect.value || new Date().getFullYear();
            const datos = calcularDatosMensuales(ano);

            // Calcular totales anuales
            let totalVentas = 0;
            let totalKg = 0;
            let totalIngresos = 0;
            let mesesConVentas = 0;

            datos.forEach(mes => {
                totalVentas += mes.ventas;
                totalKg += mes.kgVendidos;
                totalIngresos += mes.ingresos;
                if (mes.ventas > 0) mesesConVentas++;
            });

            const promedioMes = mesesConVentas > 0 ? totalIngresos / mesesConVentas : 0;

            // Actualizar tarjetas de resumen
            document.getElementById('recordTotalVentas').textContent = totalVentas;
            document.getElementById('recordTotalKg').textContent = Math.round(totalKg).toLocaleString();
            document.getElementById('recordTotalIngresos').textContent = 'S/' + totalIngresos.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('recordPromedioMes').textContent = 'S/' + promedioMes.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Renderizar gr√°ficos
            renderGraficoBarras(datos);
            renderGraficoGanancias(datos);

            // Renderizar tabla
            renderTablaRecord(datos);
        }

        // Renderizar gr√°fico de barras de Kg vendidos
        function renderGraficoBarras(datos) {
            const container = document.getElementById('recordGraficoBarras');
            if (!container) return;

            const maxKg = Math.max(...datos.map(d => d.kgVendidos), 1);
            const colores = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4',
                '#6366f1', '#a855f7', '#f43f5e', '#eab308', '#22c55e', '#14b8a6'
            ];

            let html = '';
            const alturaMax = 220; // p√≠xeles m√°ximos de altura
            datos.forEach((mes, i) => {
                const alturaPx = maxKg > 0 ? Math.round((mes.kgVendidos / maxKg) * alturaMax) : 0;
                const color = colores[i];
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%;">
                        <div style="font-size: 0.7rem; color: #1e293b; font-weight: 700; margin-bottom: 4px;">${mes.kgVendidos > 0 ? Math.round(mes.kgVendidos) : ''}</div>
                        <div style="
                            width: 80%; 
                            height: ${Math.max(alturaPx, 8)}px; 
                            background: linear-gradient(180deg, ${color}, ${color}aa);
                            border-radius: 6px 6px 0 0;
                            transition: all 0.3s ease;
                            cursor: pointer;
                            box-shadow: 0 2px 8px ${color}40;
                        " title="${MESES[i]}: ${Math.round(mes.kgVendidos)} Kg"
                        onmouseover="this.style.transform='scaleY(1.05)'; this.style.boxShadow='0 4px 16px ${color}60'"
                        onmouseout="this.style.transform='scaleY(1)'; this.style.boxShadow='0 2px 8px ${color}40'"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Renderizar gr√°fico de ingresos
        function renderGraficoGanancias(datos) {
            const container = document.getElementById('recordGraficoGanancias');
            if (!container) return;

            const maxIngresos = Math.max(...datos.map(d => d.ingresos), 1);

            const alturaMax = 160; // p√≠xeles m√°ximos
            let html = '';
            datos.forEach((mes, i) => {
                const alturaPx = maxIngresos > 0 ? Math.round((mes.ingresos / maxIngresos) * alturaMax) : 0;
                const gradiente = mes.ingresos > 0
                    ? 'linear-gradient(180deg, #16a34a, #22c55e)'
                    : 'linear-gradient(180deg, #e2e8f0, #f1f5f9)';
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%;">
                        <div style="font-size: 0.65rem; color: #16a34a; font-weight: 700; margin-bottom: 4px;">${mes.ingresos > 0 ? 'S/' + Math.round(mes.ingresos) : ''}</div>
                        <div style="
                            width: 80%; 
                            height: ${Math.max(alturaPx, 8)}px; 
                            background: ${gradiente};
                            border-radius: 6px 6px 0 0;
                            transition: all 0.3s ease;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
                        " title="${MESES[i]}: S/${Math.round(mes.ingresos)}"
                        onmouseover="this.style.transform='scaleY(1.05)'"
                        onmouseout="this.style.transform='scaleY(1)'"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Renderizar tabla de resumen mensual
        function renderTablaRecord(datos) {
            const tbody = document.getElementById('recordTablaBody');
            const noMessage = document.getElementById('noRecordMessage');

            if (!tbody) return;

            const totalVentas = datos.reduce((sum, m) => sum + m.ventas, 0);

            if (totalVentas === 0) {
                tbody.innerHTML = '';
                noMessage.style.display = 'block';
                return;
            }

            noMessage.style.display = 'none';

            let html = '';
            let prevKg = 0;

            datos.forEach((mes, i) => {
                const tendencia = mes.kgVendidos > prevKg ? 'üìà' : (mes.kgVendidos < prevKg ? 'üìâ' : '‚ûñ');
                const bgColor = i % 2 === 0 ? '#ffffff' : '#f8fafc';

                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 0.8rem; font-weight: 600; color: #1e293b;">${MESES[i]}</td>
                        <td style="padding: 0.8rem; text-align: center;">
                            <span style="background: ${mes.ventas > 0 ? '#dbeafe' : '#f1f5f9'}; color: ${mes.ventas > 0 ? '#1d4ed8' : '#94a3b8'}; padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: 600;">${mes.ventas}</span>
                        </td>
                        <td style="padding: 0.8rem; text-align: center;">
                            <span style="background: #eff6ff; color: #3b82f6; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">${mes.exportacion}</span>
                        </td>
                        <td style="padding: 0.8rem; text-align: center;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">${mes.nacional}</span>
                        </td>
                        <td style="padding: 0.8rem; text-align: right; font-weight: 600; color: #7c3aed;">${Math.round(mes.kgVendidos).toLocaleString()} Kg</td>
                        <td style="padding: 0.8rem; text-align: right; font-weight: 700; color: #16a34a;">S/${mes.ingresos.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                        <td style="padding: 0.8rem; text-align: center; font-size: 1.2rem;">${mes.ventas > 0 ? tendencia : '‚Äî'}</td>
                    </tr>
                `;

                if (mes.ventas > 0) prevKg = mes.kgVendidos;
            });

            // Fila de totales
            const totalKg = datos.reduce((sum, m) => sum + m.kgVendidos, 0);
            const totalIngresos = datos.reduce((sum, m) => sum + m.ingresos, 0);
            const totalExport = datos.reduce((sum, m) => sum + m.exportacion, 0);
            const totalNacional = datos.reduce((sum, m) => sum + m.nacional, 0);

            html += `
                <tr style="background: linear-gradient(135deg, #1e293b, #334155); color: white; font-weight: 700;">
                    <td style="padding: 1rem; border-radius: 0 0 0 8px;">TOTAL ANUAL</td>
                    <td style="padding: 1rem; text-align: center;">${totalVentas}</td>
                    <td style="padding: 1rem; text-align: center;">${totalExport}</td>
                    <td style="padding: 1rem; text-align: center;">${totalNacional}</td>
                    <td style="padding: 1rem; text-align: right;">${Math.round(totalKg).toLocaleString()} Kg</td>
                    <td style="padding: 1rem; text-align: right; color: #4ade80;">S/${totalIngresos.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                    <td style="padding: 1rem; text-align: center; border-radius: 0 0 8px 0;">üèÜ</td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        // Exportar a PDF (funcionalidad b√°sica)
        function exportarRecordPDF() {
            mostrarModalInfo('Exportar PDF', '<p style="text-align: center; color: #64748b;">üìÑ Funci√≥n de exportar a PDF - En desarrollo.</p><p style="text-align: center; color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem;">Por ahora puedes usar Ctrl+P para imprimir la p√°gina.</p>', 'üìÑ');
        }

        // Exportar a Excel
        function exportarRecordExcel() {
            const ano = document.getElementById('recordAnoSelect').value;
            const datos = calcularDatosMensuales(ano);

            let csv = 'Mes,Ventas,Exportaci√≥n,Nacional,Kg Vendidos,Ingresos (S/)\n';

            datos.forEach((mes, i) => {
                csv += `${MESES[i]},${mes.ventas},${mes.exportacion},${mes.nacional},${mes.kgVendidos.toFixed(1)},${mes.ingresos.toFixed(2)}\n`;
            });

            // Totales
            const totalVentas = datos.reduce((sum, m) => sum + m.ventas, 0);
            const totalKg = datos.reduce((sum, m) => sum + m.kgVendidos, 0);
            const totalIngresos = datos.reduce((sum, m) => sum + m.ingresos, 0);
            const totalExport = datos.reduce((sum, m) => sum + m.exportacion, 0);
            const totalNacional = datos.reduce((sum, m) => sum + m.nacional, 0);

            csv += `TOTAL,${totalVentas},${totalExport},${totalNacional},${totalKg.toFixed(1)},${totalIngresos.toFixed(2)}\n`;

            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `record_historico_${ano}.csv`;
            link.click();

            mostrarModalInfo('√âxito', '<p style="text-align: center; color: #16a34a;">‚úÖ Archivo exportado: record_historico_' + ano + '.csv</p>', 'üìÑ');
        }

        function openFerreteriaModal() {
            mostrarModalInfo('Ferreter√≠a', '<p style="text-align: center; color: #64748b;">üîß M√≥dulo de Ferreter√≠a - En desarrollo</p>', 'üîß');
        }

        // Abrir secci√≥n de Reubicaci√≥n desde Almac√©n de Aceitunas
        function abrirReubicacionDesdeAlmacen() {
            // Ocultar el contenido de almac√©n de aceitunas
            document.getElementById('almacenAceitunasContent').style.display = 'none';

            // Mostrar la secci√≥n de reubicaci√≥n
            document.getElementById('salidaReubicacionContent').style.display = 'block';

            // Indicar que venimos del almac√©n
            window.reubicacionOrigenAlmacen = true;

            // Configurar fecha de hoy
            document.getElementById('reubicacionFecha').value = new Date().toISOString().split('T')[0];

            // Cargar lotes disponibles
            cargarLotesParaReubicacion();
        }

        // Funci√≥n para volver al almac√©n desde reubicaci√≥n
        function volverDesdeReubicacion() {
            if (window.reubicacionOrigenAlmacen) {
                // Volver al almac√©n de aceitunas
                document.getElementById('salidaReubicacionContent').style.display = 'none';
                document.getElementById('almacenAceitunasContent').style.display = 'block';
                window.reubicacionOrigenAlmacen = false;
            } else {
                // Comportamiento normal: volver a selecci√≥n de salida
                volverSalidaSeleccion();
            }
        }

        // ========== ALMAC√âN NAVIGATION FUNCTIONS ==========
        // Stock de insumos (persistido en localStorage)
        let stockInsumos = JSON.parse(localStorage.getItem('stockInsumos')) || {
            Agua: 0,
            SorbatoPotasio: 0,
            AcidoLactico: 0,
            AcidoCitrico: 0,
            Calcio: 0,
            AcidoAcetico: 0,
            AcidoAscorbico: 0,
            BenzoatoPotasio: 0,
            SalIndustrial: 0,
            Otros: 0
        };

        let movimientosInsumos = JSON.parse(localStorage.getItem('movimientosInsumos')) || [];

        function mostrarAlmacenInsumos() {
            document.getElementById('almacenSeleccion').style.display = 'none';
            document.getElementById('almacenInsumosContent').style.display = 'block';
            document.getElementById('almacenAceitunasContent').style.display = 'none';
            cargarStockInsumos();
            actualizarHistorial();
        }

        function mostrarAlmacenAceitunas() {
            document.getElementById('almacenSeleccion').style.display = 'none';
            document.getElementById('almacenInsumosContent').style.display = 'none';
            document.getElementById('almacenAceitunasContent').style.display = 'block';
            initCuadrantes();
        }

        function volverAlmacenSeleccion() {
            document.getElementById('almacenSeleccion').style.display = 'block';
            document.getElementById('almacenInsumosContent').style.display = 'none';
            document.getElementById('almacenAceitunasContent').style.display = 'none';
        }

        function cargarStockInsumos() {
            // Cargar valores de stock en la UI
            document.getElementById('stockAgua').textContent = stockInsumos.Agua.toFixed(2);
            document.getElementById('stockSorbatoPotasio').textContent = stockInsumos.SorbatoPotasio.toFixed(2);
            document.getElementById('stockAcidoLactico').textContent = stockInsumos.AcidoLactico.toFixed(2);
            document.getElementById('stockAcidoCitrico').textContent = stockInsumos.AcidoCitrico.toFixed(2);
            document.getElementById('stockCalcio').textContent = stockInsumos.Calcio.toFixed(2);
            document.getElementById('stockAcidoAcetico').textContent = stockInsumos.AcidoAcetico.toFixed(2);
            document.getElementById('stockAcidoAscorbico').textContent = stockInsumos.AcidoAscorbico.toFixed(2);
            document.getElementById('stockBenzoatoPotasio').textContent = stockInsumos.BenzoatoPotasio.toFixed(2);
            document.getElementById('stockSalIndustrial').textContent = stockInsumos.SalIndustrial.toFixed(2);
            document.getElementById('stockOtros').textContent = stockInsumos.Otros.toFixed(2);
        }

        function ingresarStock(insumo, unidad) {
            const inputId = 'cant' + insumo;
            const cantidad = parseFloat(document.getElementById(inputId).value) || 0;

            if (cantidad <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese una cantidad v√°lida mayor a 0</p>', '‚ö†Ô∏è');
                return;
            }

            stockInsumos[insumo] += cantidad;
            localStorage.setItem('stockInsumos', JSON.stringify(stockInsumos));

            // Registrar movimiento
            guardarMovimiento('ingreso', insumo, cantidad, unidad);

            // Limpiar input y actualizar UI
            document.getElementById(inputId).value = '';
            cargarStockInsumos();
            actualizarHistorial();

            // Feedback visual
            const stockElement = document.getElementById('stock' + insumo);
            stockElement.style.animation = 'none';
            stockElement.offsetHeight; // Trigger reflow
            stockElement.style.animation = 'pulse 0.3s ease';
        }

        function sacarStock(insumo, unidad) {
            const inputId = 'cant' + insumo;
            const cantidad = parseFloat(document.getElementById(inputId).value) || 0;

            if (cantidad <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese una cantidad v√°lida mayor a 0</p>', '‚ö†Ô∏è');
                return;
            }

            if (stockInsumos[insumo] < cantidad) {
                mostrarModalInfo('Stock Insuficiente', '<p style="text-align: center; color: #dc2626;">No hay suficiente stock de ' + getNombreInsumo(insumo) + '</p><p style="text-align: center; font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">Stock actual: ' + stockInsumos[insumo].toFixed(2) + ' ' + unidad + '</p>', '‚ùå');
                return;
            }

            stockInsumos[insumo] -= cantidad;
            localStorage.setItem('stockInsumos', JSON.stringify(stockInsumos));

            // Registrar movimiento
            guardarMovimiento('salida', insumo, cantidad, unidad);

            // Limpiar input y actualizar UI
            document.getElementById(inputId).value = '';
            cargarStockInsumos();
            actualizarHistorial();
        }

        function guardarMovimiento(tipo, insumo, cantidad, unidad) {
            const movimiento = {
                id: Date.now(),
                tipo: tipo,
                insumo: getNombreInsumo(insumo),
                cantidad: cantidad,
                unidad: unidad,
                fecha: new Date().toISOString(),
                usuario: currentUserName
            };

            movimientosInsumos.unshift(movimiento);
            // Guardar solo los √∫ltimos 50 movimientos
            if (movimientosInsumos.length > 50) {
                movimientosInsumos = movimientosInsumos.slice(0, 50);
            }
            localStorage.setItem('movimientosInsumos', JSON.stringify(movimientosInsumos));
        }

        function getNombreInsumo(key) {
            const nombres = {
                'Agua': 'Agua',
                'SorbatoPotasio': 'Sorbato de Potasio',
                'AcidoLactico': '√Åcido L√°ctico',
                'AcidoCitrico': '√Åcido C√≠trico',
                'Calcio': 'Calcio',
                'AcidoAcetico': '√Åcido Ac√©tico',
                'AcidoAscorbico': '√Åcido Asc√≥rbico',
                'BenzoatoPotasio': 'Benzoato de Potasio',
                'SalIndustrial': 'Sal Industrial',
                'Otros': 'Otros Insumos'
            };
            return nombres[key] || key;
        }

        function actualizarHistorial() {
            const container = document.getElementById('historialMovimientos');

            if (movimientosInsumos.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 1rem;">No hay movimientos registrados</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';

            movimientosInsumos.slice(0, 10).forEach(mov => {
                const isIngreso = mov.tipo === 'ingreso';
                const bgColor = isIngreso ? '#f0fdf4' : '#fef2f2';
                const borderColor = isIngreso ? '#16a34a' : '#dc2626';
                const icon = isIngreso ? '‚Üë' : '‚Üì';
                const color = isIngreso ? '#16a34a' : '#dc2626';
                const fecha = new Date(mov.fecha);
                const fechaStr = fecha.toLocaleDateString('es-PE') + ' ' + fecha.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });

                html += `
                    <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 0.6rem 1rem; border-radius: 0 6px 6px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: ${color}; font-weight: 700;">${icon}</span>
                            <strong style="color: #1e293b;">${mov.insumo}</strong>
                            <span style="color: ${color}; font-weight: 600;">${isIngreso ? '+' : '-'}${mov.cantidad} ${mov.unidad}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #64748b;">
                            ${fechaStr} - ${mov.usuario}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }



        // ========== INSUMOS FUNCTIONS ==========
        let insumosData = JSON.parse(localStorage.getItem('insumosAlmacen')) || [];

        function openInsumoModal() {
            resetInsumoForm();
            // Set fecha to today
            document.getElementById('insumoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('insumoModalOverlay').style.display = 'flex';
        }

        function closeInsumoModal() {
            document.getElementById('insumoModalOverlay').style.display = 'none';
            resetInsumoForm();
        }

        function handleInsumoChange() {
            const insumoSelect = document.getElementById('insumoNombre');
            const otroGroup = document.getElementById('insumoOtroGroup');
            const unidadSelect = document.getElementById('insumoUnidad');

            if (insumoSelect.value === 'Otro') {
                otroGroup.style.display = 'block';
            } else {
                otroGroup.style.display = 'none';
            }

            // Auto-set unidad based on insumo
            if (insumoSelect.value === 'Agua') {
                unidadSelect.value = 'm3';
            } else if (['√Åcido L√°ctico', '√Åcido Ac√©tico'].includes(insumoSelect.value)) {
                unidadSelect.value = 'Lt';
            } else if (['Sorbato de Potasio', '√Åcido C√≠trico', 'Calcio', '√Åcido Asc√≥rbico', 'Benzoato de Potasio', 'Sal Industrial'].includes(insumoSelect.value)) {
                unidadSelect.value = 'Kg';
            }
        }

        function calcularTotalInsumo() {
            const cantidad = parseFloat(document.getElementById('insumoCantidad').value) || 0;
            const precioUnitario = parseFloat(document.getElementById('insumoPrecioUnitario').value) || 0;
            const total = cantidad * precioUnitario;
            document.getElementById('insumoTotal').value = 'S/' + total.toFixed(2);
        }

        function saveInsumo() {
            const nombreSelect = document.getElementById('insumoNombre').value;
            const nombreOtro = document.getElementById('insumoOtroNombre').value;
            const cantidad = parseFloat(document.getElementById('insumoCantidad').value) || 0;
            const precioUnitario = parseFloat(document.getElementById('insumoPrecioUnitario').value) || 0;
            const fecha = document.getElementById('insumoFecha').value;

            // Validation
            if (!nombreSelect) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione un insumo</p>', '‚ö†Ô∏è');
                return;
            }
            if (nombreSelect === 'Otro' && !nombreOtro.trim()) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Especifique el nombre del insumo</p>', '‚ö†Ô∏è');
                return;
            }
            if (cantidad <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese una cantidad v√°lida</p>', '‚ö†Ô∏è');
                return;
            }
            if (precioUnitario <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese un precio unitario v√°lido</p>', '‚ö†Ô∏è');
                return;
            }
            if (!fecha) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese la fecha de ingreso</p>', '‚ö†Ô∏è');
                return;
            }

            const insumo = {
                id: Date.now(),
                nombre: nombreSelect === 'Otro' ? nombreOtro.trim() : nombreSelect,
                categoria: document.getElementById('insumoCategoria').value,
                unidad: document.getElementById('insumoUnidad').value,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                total: cantidad * precioUnitario,
                proveedor: document.getElementById('insumoProveedor').value.trim(),
                fecha: fecha,
                factura: document.getElementById('insumoFactura').value.trim(),
                observaciones: document.getElementById('insumoObservaciones').value.trim(),
                fechaRegistro: new Date().toISOString()
            };

            insumosData.push(insumo);
            localStorage.setItem('insumosAlmacen', JSON.stringify(insumosData));

            var msgInsumo = '<div style="text-align: center;"><div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>';
            msgInsumo += '<div style="font-weight: 700; color: #16a34a; margin-bottom: 1rem;">Insumo Registrado</div></div>';
            msgInsumo += '<div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">';
            msgInsumo += '<div style="font-weight: 600;">' + insumo.nombre + '</div>';
            msgInsumo += '<div style="color: #64748b;">' + insumo.cantidad + ' ' + insumo.unidad + '</div>';
            msgInsumo += '<div style="color: #16a34a; font-weight: 600; margin-top: 0.5rem;">Total: S/' + insumo.total.toFixed(2) + '</div>';
            msgInsumo += '</div>';
            mostrarModalInfo('Insumo Registrado', msgInsumo, 'üì¶');

            renderInsumosTable();
            closeInsumoModal();
        }

        function resetInsumoForm() {
            document.getElementById('insumoNombre').value = '';
            document.getElementById('insumoOtroNombre').value = '';
            document.getElementById('insumoCategoria').value = 'salmuera';
            document.getElementById('insumoUnidad').value = 'Kg';
            document.getElementById('insumoCantidad').value = '';
            document.getElementById('insumoPrecioUnitario').value = '';
            document.getElementById('insumoTotal').value = 'S/0.00';
            document.getElementById('insumoProveedor').value = '';
            document.getElementById('insumoFecha').value = '';
            document.getElementById('insumoFactura').value = '';
            document.getElementById('insumoObservaciones').value = '';
            document.getElementById('insumoOtroGroup').style.display = 'none';
        }


        // Logout
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        // Calculate total Kg from envase (cantidad √ó kilos) + puchos
        function calcularTotalKg() {
            const cantidad = parseFloat(document.getElementById('envase_cantidad').value) || 0;
            const kilos = parseFloat(document.getElementById('envase_kilos').value) || 0;
            const puchos = parseFloat(document.getElementById('envase_puchos').value) || 0;
            const total = (cantidad * kilos) + puchos;

            document.getElementById('cantidad').value = total.toFixed(1);
            document.getElementById('totalKgCalculado').textContent = total.toFixed(1) + ' Kg';
        }

        // Calculate total transport cost
        function calcularTotalTransporte() {
            const viajes = parseFloat(document.getElementById('transporteViajes').value) || 0;
            const costoViaje = parseFloat(document.getElementById('transporteCostoViaje').value) || 0;

            const total = viajes * costoViaje;

            document.getElementById('transporteTotal').value = 'S/' + total.toFixed(2);
        }

        // Calcular costo del personal de calibraci√≥n
        function calcularCostoPersonal() {
            // Funci√≥n auxiliar para calcular horas entre dos tiempos
            const calcularHoras = (horaIngreso, horaFinal) => {
                if (!horaIngreso || !horaFinal) return 0;
                const [h1, m1] = horaIngreso.split(':').map(Number);
                const [h2, m2] = horaFinal.split(':').map(Number);
                let minutos = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (minutos < 0) minutos += 24 * 60; // Si cruza medianoche
                return minutos / 60; // Retorna horas decimales
            };

            // Funci√≥n auxiliar para formatear horas
            const formatearHoras = (horasDecimales) => {
                const horas = Math.floor(horasDecimales);
                const minutos = Math.round((horasDecimales - horas) * 60);
                return `${horas}:${minutos.toString().padStart(2, '0')}`;
            };

            // Calcular Varones
            const varonesQty = parseFloat(document.getElementById('varonesQty').value) || 0;
            const varonesHoraHombre = parseFloat(document.getElementById('varonesHoraHombre').value) || 0;
            const varonesHoraIngreso = document.getElementById('varonesHoraIngreso').value;
            const varonesHoraFinal = document.getElementById('varonesHoraFinal').value;
            const varonesHorasTrabajadas = calcularHoras(varonesHoraIngreso, varonesHoraFinal);
            const varonesCosto = varonesQty * varonesHoraHombre * varonesHorasTrabajadas;

            document.getElementById('varonesHorasTrabajadas').value = formatearHoras(varonesHorasTrabajadas);
            document.getElementById('varonesCostoTotal').value = 'S/' + varonesCosto.toFixed(2);

            // Calcular Mujeres
            const mujeresQty = parseFloat(document.getElementById('mujeresQty').value) || 0;
            const mujeresHoraHombre = parseFloat(document.getElementById('mujeresHoraHombre').value) || 0;
            const mujeresHoraIngreso = document.getElementById('mujeresHoraIngreso').value;
            const mujeresHoraFinal = document.getElementById('mujeresHoraFinal').value;
            const mujeresHorasTrabajadas = calcularHoras(mujeresHoraIngreso, mujeresHoraFinal);
            const mujeresCosto = mujeresQty * mujeresHoraHombre * mujeresHorasTrabajadas;

            document.getElementById('mujeresHorasTrabajadas').value = formatearHoras(mujeresHorasTrabajadas);
            document.getElementById('mujeresCostoTotal').value = 'S/' + mujeresCosto.toFixed(2);

            // Calcular Traspaleadores
            const traspaleadoresQty = parseFloat(document.getElementById('traspaleadoresQty').value) || 0;
            const traspaleadoresCostoDia = parseFloat(document.getElementById('traspaleadoresCostoDia').value) || 0;
            const traspaleadoresDias = parseFloat(document.getElementById('traspaleadoresDias').value) || 1;
            const traspaleadoresCosto = traspaleadoresQty * traspaleadoresCostoDia * traspaleadoresDias;

            document.getElementById('traspaleadoresCostoTotal').value = 'S/' + traspaleadoresCosto.toFixed(2);

            // Total Personal (Varones + Mujeres + Traspaleadores)
            const totalPersonal = varonesCosto + mujeresCosto + traspaleadoresCosto;
            document.getElementById('totalCostoPersonal').textContent = 'S/' + totalPersonal.toFixed(2);
        }

        // Contador para IDs √∫nicos de otros gastos
        let otrosGastosCounter = 0;

        // Agregar un nuevo gasto
        function agregarOtroGasto() {
            const container = document.getElementById('otrosGastosContainer');
            const noMessage = document.getElementById('noOtrosGastos');
            const totalRow = document.getElementById('totalOtrosGastosRow');

            otrosGastosCounter++;
            const gastoId = 'otroGasto_' + otrosGastosCounter;

            const gastoHTML = `
                <div id="${gastoId}" class="otro-gasto-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <input type="text" placeholder="Descripci√≥n del gasto" 
                        style="flex: 2; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem;">
                    <div style="display: flex; align-items: center; gap: 0.3rem;">
                        <span style="color: #3d4f31; font-weight: 600;">S/</span>
                        <input type="number" placeholder="0.00" step="0.01" min="0" 
                            style="width: 90px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; font-weight: 600;"
                            oninput="calcularTotalOtrosGastos()">
                    </div>
                    <button type="button" onclick="eliminarOtroGasto('${gastoId}')"
                        style="padding: 0.4rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
                        ‚úï
                    </button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', gastoHTML);
            noMessage.style.display = 'none';
            totalRow.style.display = 'flex';
            calcularTotalOtrosGastos();
        }

        // Eliminar un gasto
        function eliminarOtroGasto(gastoId) {
            const elemento = document.getElementById(gastoId);
            if (elemento) {
                elemento.remove();
                calcularTotalOtrosGastos();

                const container = document.getElementById('otrosGastosContainer');
                if (container.children.length === 0) {
                    document.getElementById('noOtrosGastos').style.display = 'block';
                    document.getElementById('totalOtrosGastosRow').style.display = 'none';
                }
            }
        }

        // Calcular total de otros gastos
        function calcularTotalOtrosGastos() {
            const container = document.getElementById('otrosGastosContainer');
            const inputs = container.querySelectorAll('input[type="number"]');
            let total = 0;

            inputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            document.getElementById('totalOtrosGastos').textContent = 'S/' + total.toFixed(2);
            return total;
        }

        // Obtener datos de otros gastos para guardar
        function getOtrosGastosData() {
            const container = document.getElementById('otrosGastosContainer');
            const items = container.querySelectorAll('.otro-gasto-item');
            const gastos = [];

            items.forEach(item => {
                const descripcion = item.querySelector('input[type="text"]').value;
                const monto = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                if (descripcion || monto > 0) {
                    gastos.push({ descripcion, monto });
                }
            });

            return gastos;
        }

        // Calcular costo total de salmuera
        function calcularCostoSalmuera() {
            let total = 0;

            // Agua
            const aguaCant = parseFloat(document.getElementById('salmueraAgua')?.value) || 0;
            const aguaPrecio = parseFloat(document.getElementById('salmueraAguaPrecio')?.value) || 0;
            const aguaSubtotal = aguaCant * aguaPrecio;
            const aguaSubtotalEl = document.getElementById('salmueraAguaSubtotal');
            if (aguaSubtotalEl) aguaSubtotalEl.value = 'S/' + aguaSubtotal.toFixed(2);
            total += aguaSubtotal;

            // Sorbato de Potasio
            const sorbatoCant = parseFloat(document.getElementById('sorbatoPotasio')?.value) || 0;
            const sorbatoPrecio = parseFloat(document.getElementById('sorbatoPotasioPrecio')?.value) || 0;
            const sorbatoSubtotal = sorbatoCant * sorbatoPrecio;
            const sorbatoSubtotalEl = document.getElementById('sorbatoPotasioSubtotal');
            if (sorbatoSubtotalEl) sorbatoSubtotalEl.value = 'S/' + sorbatoSubtotal.toFixed(2);
            total += sorbatoSubtotal;

            // √Åcido L√°ctico
            const lacticoCant = parseFloat(document.getElementById('acidoLactico')?.value) || 0;
            const lacticoPrecio = parseFloat(document.getElementById('acidoLacticoPrecio')?.value) || 0;
            const lacticoSubtotal = lacticoCant * lacticoPrecio;
            const lacticoSubtotalEl = document.getElementById('acidoLacticoSubtotal');
            if (lacticoSubtotalEl) lacticoSubtotalEl.value = 'S/' + lacticoSubtotal.toFixed(2);
            total += lacticoSubtotal;

            // √Åcido C√≠trico
            const citricoCant = parseFloat(document.getElementById('acidoCitrico')?.value) || 0;
            const citricoPrecio = parseFloat(document.getElementById('acidoCitricoPrecio')?.value) || 0;
            const citricoSubtotal = citricoCant * citricoPrecio;
            const citricoSubtotalEl = document.getElementById('acidoCitricoSubtotal');
            if (citricoSubtotalEl) citricoSubtotalEl.value = 'S/' + citricoSubtotal.toFixed(2);
            total += citricoSubtotal;

            // Calcio
            const calcioCant = parseFloat(document.getElementById('calcio')?.value) || 0;
            const calcioPrecio = parseFloat(document.getElementById('calcioPrecio')?.value) || 0;
            const calcioSubtotal = calcioCant * calcioPrecio;
            const calcioSubtotalEl = document.getElementById('calcioSubtotal');
            if (calcioSubtotalEl) calcioSubtotalEl.value = 'S/' + calcioSubtotal.toFixed(2);
            total += calcioSubtotal;

            // √Åcido Ac√©tico
            const aceticoCant = parseFloat(document.getElementById('acidoAcetico')?.value) || 0;
            const aceticoPrecio = parseFloat(document.getElementById('acidoAceticoPrecio')?.value) || 0;
            const aceticoSubtotal = aceticoCant * aceticoPrecio;
            const aceticoSubtotalEl = document.getElementById('acidoAceticoSubtotal');
            if (aceticoSubtotalEl) aceticoSubtotalEl.value = 'S/' + aceticoSubtotal.toFixed(2);
            total += aceticoSubtotal;

            // √Åcido Asc√≥rbico
            const ascorbicoCant = parseFloat(document.getElementById('acidoAscorbico')?.value) || 0;
            const ascorbicoPrecio = parseFloat(document.getElementById('acidoAscorbicoPrecio')?.value) || 0;
            const ascorbicoSubtotal = ascorbicoCant * ascorbicoPrecio;
            const ascorbicoSubtotalEl = document.getElementById('acidoAscorbicoSubtotal');
            if (ascorbicoSubtotalEl) ascorbicoSubtotalEl.value = 'S/' + ascorbicoSubtotal.toFixed(2);
            total += ascorbicoSubtotal;

            // Benzoato de Potasio
            const benzoatoCant = parseFloat(document.getElementById('benzoatoPotasio')?.value) || 0;
            const benzoatoPrecio = parseFloat(document.getElementById('benzoatoPotasioPrecio')?.value) || 0;
            const benzoatoSubtotal = benzoatoCant * benzoatoPrecio;
            const benzoatoSubtotalEl = document.getElementById('benzoatoPotasioSubtotal');
            if (benzoatoSubtotalEl) benzoatoSubtotalEl.value = 'S/' + benzoatoSubtotal.toFixed(2);
            total += benzoatoSubtotal;

            // Otros costos
            const otrosCosto = parseFloat(document.getElementById('salmueraOtrosCosto')?.value) || 0;
            total += otrosCosto;

            // Actualizar total
            document.getElementById('totalCostoSalmuera').textContent = 'S/' + total.toFixed(2);
            return total;
        }

        // Toggle envase fields visibility
        function toggleEnvaseFields() {
            const tipoEnvase = document.getElementById('tipoEnvase').value;
            const container = document.getElementById('envaseFieldsContainer');

            if (tipoEnvase) {
                container.style.display = 'block';

                // Si es Bidones de Exportaci√≥n, actualizar los calibres existentes
                if (tipoEnvase === 'bidones') {
                    calibresLote.forEach(calibre => {
                        const kilosInput = document.getElementById('calibre_kilos_' + calibre.id);
                        if (kilosInput && !kilosInput.value) {
                            // Solo rellenar si est√° vac√≠o
                            kilosInput.value = '60';
                            kilosInput.placeholder = '60';
                        }
                    });
                    actualizarTotalCalibres();
                }
            } else {
                container.style.display = 'none';
                document.getElementById('envase_cantidad').value = '';
                document.getElementById('envase_kilos').value = '';
                document.getElementById('envase_puchos').value = '';
                calcularTotalKg();
            }
        }

        // Lista de calibres est√°ndar (ordenados)
        const CALIBRES_ESTANDAR = [
            '70-90', '90-110', '110-130', '130-150', '150-180', '180-200',
            '200-240', '240-280', '280-320', '320-360', '360-400', '400-500', '500+'
        ];

        // Lista de calibres personalizados (se agregan din√°micamente)
        let calibresPersonalizados = [];

        // Array para almacenar los calibres del lote
        let calibresLote = [];
        let calibreIdCounter = 0;

        // Agregar nuevo calibre al lote
        function agregarCalibre(calibrePreseleccionado = '') {
            calibreIdCounter++;
            const calibreId = calibreIdCounter;

            // Obtener todos los calibres disponibles
            const todosCalibres = [...CALIBRES_ESTANDAR, ...calibresPersonalizados];

            // Determinar si es Bidones de Exportaci√≥n para prellenar 60kg
            const tipoEnvase = document.getElementById('tipoEnvase').value;
            const esBidones = tipoEnvase === 'bidones' || selectedDestination === 'exportacion';
            const kilosPorDefecto = esBidones ? '60' : '';

            // Campo de precio solo visible para admin
            const precioCampoHTML = puedeVerPrecios() ? `
                <div class="form-group">
                    <label class="form-label">Precio S/Kg</label>
                    <input type="number" class="form-input" id="calibre_precio_${calibreId}" placeholder="0.00" step="0.01" oninput="actualizarTotalCalibres()">
                </div>
            ` : '';

            const valorTotalHTML = puedeVerPrecios() ? `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e2e8f0;">
                    <span style="color: #64748b; font-size: 0.85rem;">Valor Total:</span>
                    <strong id="calibre_valor_${calibreId}" style="color: #16a34a; font-size: 1rem;">S/0.00</strong>
                </div>
            ` : '';

            const calibreHTML = `
                <div class="calibre-item" id="calibre-${calibreId}" style="padding: 1rem; background: #fff; border: 2px solid #e2e8f0; border-radius: 10px; position: relative;">
                    <button type="button" onclick="eliminarCalibre(${calibreId})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 1rem; line-height: 1;">√ó</button>
                    
                    <div class="form-grid" style="margin-bottom: 0.8rem;">
                        <div class="form-group">
                            <label class="form-label">Calibre</label>
                            <select class="form-select" id="calibre_select_${calibreId}" onchange="actualizarTotalCalibres()">
                                <option value="">Seleccionar...</option>
                                ${todosCalibres.map(c => `<option value="${c}"${c === calibrePreseleccionado ? ' selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        ${precioCampoHTML}
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Cant. Bidones</label>
                            <input type="number" class="form-input" id="calibre_bidones_${calibreId}" placeholder="0" oninput="actualizarTotalCalibres()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kg por Bidon${esBidones ? ' (60kg)' : ''}</label>
                            <input type="number" class="form-input" id="calibre_kilos_${calibreId}" placeholder="${esBidones ? '60' : '0'}" value="${kilosPorDefecto}" step="0.1" oninput="actualizarTotalCalibres()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sobras (Kg)</label>
                            <input type="number" class="form-input" id="calibre_sobras_${calibreId}" placeholder="0" step="0.1" oninput="actualizarTotalCalibres()">
                        </div>
                    </div>
                    
                    <div style="margin-top: 0.5rem; text-align: right; font-size: 0.9rem;">
                        <span style="color: #64748b;">Subtotal:</span>
                        <strong id="calibre_subtotal_${calibreId}" style="color: #3d4f31;">0 Kg</strong>
                    </div>
                    ${valorTotalHTML}
                </div>
            `;

            document.getElementById('calibresLista').insertAdjacentHTML('beforeend', calibreHTML);
            calibresLote.push({ id: calibreId });
            actualizarTotalCalibres();
        }

        // Llenado r√°pido de calibres
        function llenadoRapidoCalibres() {
            const desde = document.getElementById('llenadoDesde').value;
            const hasta = document.getElementById('llenadoHasta').value;

            const todosCalibres = [...CALIBRES_ESTANDAR, ...calibresPersonalizados];
            const startIdx = todosCalibres.indexOf(desde);
            const endIdx = todosCalibres.indexOf(hasta);

            if (startIdx === -1 || endIdx === -1) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Seleccione calibres v√°lidos</p>', '‚ö†Ô∏è');
                return;
            }

            if (startIdx > endIdx) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">El calibre inicial debe ser menor o igual al final</p>', '‚ö†Ô∏è');
                return;
            }

            // Limpiar calibres existentes
            limpiarTodosCalibres();

            // Agregar calibres en el rango
            for (let i = startIdx; i <= endIdx; i++) {
                agregarCalibre(todosCalibres[i]);
            }
        }

        // Limpiar todos los calibres
        function limpiarTodosCalibres() {
            document.getElementById('calibresLista').innerHTML = '';
            calibresLote = [];
            calibreIdCounter = 0;
            actualizarTotalCalibres();
        }

        // Agregar calibre personalizado a la lista
        function agregarCalibrePersonalizado() {
            const input = document.getElementById('calibrePersonalizado');
            const valor = input.value.trim();

            if (!valor) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Ingrese un valor para el calibre personalizado</p>', '‚ö†Ô∏è');
                return;
            }

            // Verificar si ya existe
            if (CALIBRES_ESTANDAR.includes(valor) || calibresPersonalizados.includes(valor)) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Este calibre ya existe</p>', '‚ö†Ô∏è');
                return;
            }

            // Agregar a la lista de personalizados
            calibresPersonalizados.push(valor);

            // Agregar un calibre con este valor preseleccionado
            agregarCalibre(valor);

            // Limpiar input
            input.value = '';

            // Actualizar los selectores de llenado r√°pido
            actualizarSelectoresLlenado();
        }

        // Actualizar los selectores de llenado r√°pido con calibres personalizados
        function actualizarSelectoresLlenado() {
            const todosCalibres = [...CALIBRES_ESTANDAR, ...calibresPersonalizados];
            const desdeSelect = document.getElementById('llenadoDesde');
            const hastaSelect = document.getElementById('llenadoHasta');

            const desdeValor = desdeSelect.value;
            const hastaValor = hastaSelect.value;

            const opciones = todosCalibres.map(c => `<option value="${c}">${c}</option>`).join('');

            desdeSelect.innerHTML = opciones;
            hastaSelect.innerHTML = opciones;

            // Restaurar selecci√≥n o poner por defecto
            if (todosCalibres.includes(desdeValor)) {
                desdeSelect.value = desdeValor;
            }
            if (todosCalibres.includes(hastaValor)) {
                hastaSelect.value = hastaValor;
            } else {
                hastaSelect.value = todosCalibres[todosCalibres.length - 1];
            }
        }

        // Eliminar calibre del lote
        function eliminarCalibre(calibreId) {
            const elemento = document.getElementById('calibre-' + calibreId);
            if (elemento) {
                elemento.remove();
                calibresLote = calibresLote.filter(c => c.id !== calibreId);
                actualizarTotalCalibres();
            }
        }

        // Calcular y actualizar totales de todos los calibres
        function actualizarTotalCalibres() {
            let totalGeneral = 0;
            let valorTotalGeneral = 0;

            calibresLote.forEach(calibre => {
                const bidones = parseFloat(document.getElementById('calibre_bidones_' + calibre.id)?.value) || 0;
                const kilos = parseFloat(document.getElementById('calibre_kilos_' + calibre.id)?.value) || 0;
                const sobras = parseFloat(document.getElementById('calibre_sobras_' + calibre.id)?.value) || 0;
                const precio = parseFloat(document.getElementById('calibre_precio_' + calibre.id)?.value) || 0;

                const subtotal = (bidones * kilos) + sobras;
                const valorTotal = subtotal * precio;

                const subtotalEl = document.getElementById('calibre_subtotal_' + calibre.id);
                if (subtotalEl) {
                    subtotalEl.textContent = subtotal.toFixed(1) + ' Kg';
                }

                // Actualizar valor total del calibre (solo si existe el elemento)
                const valorEl = document.getElementById('calibre_valor_' + calibre.id);
                if (valorEl) {
                    valorEl.textContent = 'S/' + valorTotal.toFixed(2);
                }

                totalGeneral += subtotal;
                valorTotalGeneral += valorTotal;
            });

            const resumenEl = document.getElementById('totalCalibresResumen');
            if (calibresLote.length > 0) {
                resumenEl.style.display = 'block';
                document.getElementById('totalTodosCalibres').textContent = totalGeneral.toFixed(1) + ' Kg';
            } else {
                resumenEl.style.display = 'none';
            }
        }

        // Obtener todos los calibres como array
        function obtenerCalibresData() {
            const calibresData = [];
            calibresLote.forEach(calibre => {
                const select = document.getElementById('calibre_select_' + calibre.id);
                const bidones = document.getElementById('calibre_bidones_' + calibre.id);
                const kilos = document.getElementById('calibre_kilos_' + calibre.id);
                const sobras = document.getElementById('calibre_sobras_' + calibre.id);
                const precio = document.getElementById('calibre_precio_' + calibre.id);

                if (select && select.value) {
                    const bidonesVal = parseFloat(bidones?.value) || 0;
                    const kilosVal = parseFloat(kilos?.value) || 0;
                    const sobrasVal = parseFloat(sobras?.value) || 0;
                    const precioVal = parseFloat(precio?.value) || 0;
                    const subtotal = (bidonesVal * kilosVal) + sobrasVal;
                    const valorTotal = subtotal * precioVal;

                    calibresData.push({
                        calibre: select.value,
                        bidones: bidonesVal,
                        kilosPorBidon: kilosVal,
                        sobras: sobrasVal,
                        subtotal: subtotal,
                        precio: precioVal,
                        valorTotal: valorTotal
                    });
                }
            });
            return calibresData;
        }

        // Cargar calibres existentes en el formulario
        function cargarCalibres(calibresArray) {
            document.getElementById('calibresLista').innerHTML = '';
            calibresLote = [];
            calibreIdCounter = 0;

            if (calibresArray && calibresArray.length > 0) {
                calibresArray.forEach(calibreData => {
                    // Si el calibre no existe en est√°ndar ni personalizado, agregarlo
                    const calibreValor = calibreData.calibre || '';
                    if (calibreValor && !CALIBRES_ESTANDAR.includes(calibreValor) && !calibresPersonalizados.includes(calibreValor)) {
                        calibresPersonalizados.push(calibreValor);
                    }

                    agregarCalibre(calibreValor);
                    const lastId = calibreIdCounter;

                    document.getElementById('calibre_bidones_' + lastId).value = calibreData.bidones || '';
                    document.getElementById('calibre_kilos_' + lastId).value = calibreData.kilosPorBidon || '';
                    document.getElementById('calibre_sobras_' + lastId).value = calibreData.sobras || '';

                    // Cargar precio si existe el campo (solo admin)
                    const precioField = document.getElementById('calibre_precio_' + lastId);
                    if (precioField && calibreData.precio) {
                        precioField.value = calibreData.precio;
                    }
                });
                actualizarTotalCalibres();
                actualizarSelectoresLlenado();
            }
        }

        // Section navigation
        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });
            document.querySelectorAll('.section-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById('section-' + section).classList.add('active');
        }

        // Modal functions
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            resetForm();
        }

        function closeModal() {
            // Mostrar confirmaci√≥n antes de cerrar
            document.getElementById('closeConfirmOverlay').classList.add('active');
        }

        function closeCloseConfirm() {
            document.getElementById('closeConfirmOverlay').classList.remove('active');
        }

        function confirmCloseModal() {
            document.getElementById('closeConfirmOverlay').classList.remove('active');
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Cerrar modal directamente (sin confirmaci√≥n) - usado despu√©s de guardar
        function closeModalDirect() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function resetForm() {
            selectedColor = '';
            selectedVariety = '';
            selectedProcess = '';
            selectedSubProcess = '';
            selectedDestination = '';
            selectedCaliber = '';
            editingEntryId = null; // Reset editing state

            document.querySelectorAll('.color-option, .variety-option, .process-btn, .destination-btn, .caliber-option').forEach(el => {
                el.classList.remove('selected');
            });

            document.getElementById('varietySection').classList.remove('active');
            document.getElementById('verdeSalSection').classList.remove('active');
            document.getElementById('calibrationSection').classList.remove('active');
            document.querySelectorAll('.subprocess-section').forEach(el => el.classList.remove('active'));

            // Reset campos b√°sicos
            document.getElementById('codigoLote').value = '';
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('vendedor').value = '';
            document.getElementById('supervisor').value = '';
            document.getElementById('precio').value = '';
            document.getElementById('lugar').value = '';
            document.getElementById('cantidad').value = '';

            // Reset par√°metros de calidad
            document.getElementById('acidez').value = '';
            document.getElementById('gradosSal').value = '';
            document.getElementById('ph').value = '';
            document.getElementById('aguaCalidad').value = '';

            // Reset observaciones
            document.getElementById('observaciones').value = '';

            // Reset informaci√≥n de salmuera (cantidades y precios)
            document.getElementById('salmueraAgua').value = '';
            document.getElementById('salmueraAguaPrecio').value = '';
            document.getElementById('salmueraAguaSubtotal').value = '';
            document.getElementById('sorbatoPotasio').value = '';
            document.getElementById('sorbatoPotasioPrecio').value = '';
            document.getElementById('sorbatoPotasioSubtotal').value = '';
            document.getElementById('acidoLactico').value = '';
            document.getElementById('acidoLacticoPrecio').value = '';
            document.getElementById('acidoLacticoSubtotal').value = '';
            document.getElementById('acidoCitrico').value = '';
            document.getElementById('acidoCitricoPrecio').value = '';
            document.getElementById('acidoCitricoSubtotal').value = '';
            document.getElementById('calcio').value = '';
            document.getElementById('calcioPrecio').value = '';
            document.getElementById('calcioSubtotal').value = '';
            document.getElementById('acidoAcetico').value = '';
            document.getElementById('acidoAceticoPrecio').value = '';
            document.getElementById('acidoAceticoSubtotal').value = '';
            document.getElementById('acidoAscorbico').value = '';
            document.getElementById('acidoAscorbicoPrecio').value = '';
            document.getElementById('acidoAscorbicoSubtotal').value = '';
            document.getElementById('benzoatoPotasio').value = '';
            document.getElementById('benzoatoPotasioPrecio').value = '';
            document.getElementById('benzoatoPotasioSubtotal').value = '';
            document.getElementById('salmueraOtros').value = '';
            document.getElementById('salmueraOtrosCosto').value = '';
            document.getElementById('totalCostoSalmuera').textContent = 'S/0.00';

            document.getElementById('fechaCalibracion').value = '';
            document.getElementById('responsableCalibracion').value = '';

            // Reset envase dropdown
            document.getElementById('tipoEnvase').value = '';
            document.getElementById('envase_cantidad').value = '';
            document.getElementById('envase_kilos').value = '';
            document.getElementById('envase_puchos').value = '';
            document.getElementById('envaseFieldsContainer').style.display = 'none';
            document.getElementById('totalKgCalculado').textContent = '0 Kg';

            // Reset transporte
            document.getElementById('transporteConductor').value = '';
            document.getElementById('transporteViajes').value = '';
            document.getElementById('transporteCostoViaje').value = '';
            document.getElementById('transporteTotal').value = '';

            // Reset calibres m√∫ltiples
            document.getElementById('calibresLista').innerHTML = '';
            calibresLote = [];
            calibreIdCounter = 0;
            calibresPersonalizados = []; // Limpiar calibres personalizados
            document.getElementById('totalCalibresResumen').style.display = 'none';
            document.getElementById('totalTodosCalibres').textContent = '0 Kg';

            // Limpiar input de calibre personalizado
            const inputPersonalizado = document.getElementById('calibrePersonalizado');
            if (inputPersonalizado) inputPersonalizado.value = '';

            // Resetear selectores de llenado r√°pido
            actualizarSelectoresLlenado();

            // Reset secci√≥n de proceso negro
            const negraSection = document.getElementById('negraProcessSection');
            if (negraSection) {
                negraSection.classList.remove('active');
                negraSection.querySelectorAll('.process-btn').forEach(btn => btn.classList.remove('selected'));
            }

            // Reset Personal de Calibraci√≥n - Varones
            document.getElementById('varonesQty').value = '';
            document.getElementById('varonesHoraHombre').value = '';
            document.getElementById('varonesHoraIngreso').value = '';
            document.getElementById('varonesHoraFinal').value = '';
            document.getElementById('varonesHorasTrabajadas').value = '';
            document.getElementById('varonesCostoTotal').value = '';

            // Reset Personal de Calibraci√≥n - Mujeres
            document.getElementById('mujeresQty').value = '';
            document.getElementById('mujeresHoraHombre').value = '';
            document.getElementById('mujeresHoraIngreso').value = '';
            document.getElementById('mujeresHoraFinal').value = '';
            document.getElementById('mujeresHorasTrabajadas').value = '';
            document.getElementById('mujeresCostoTotal').value = '';

            // Reset Traspaleadores
            document.getElementById('traspaleadoresQty').value = '';
            document.getElementById('traspaleadoresCostoDia').value = '';
            document.getElementById('traspaleadoresDias').value = '1';
            document.getElementById('traspaleadoresCostoTotal').value = '';

            // Reset Total Personal
            document.getElementById('totalCostoPersonal').textContent = 'S/0.00';

            // Reset Otros Gastos
            document.getElementById('otrosGastosContainer').innerHTML = '';
            document.getElementById('noOtrosGastos').style.display = 'block';
            document.getElementById('totalOtrosGastosRow').style.display = 'none';
            document.getElementById('totalOtrosGastos').textContent = 'S/0.00';
            otrosGastosCounter = 0;
        }

        // Color selection
        function selectColor(color) {
            selectedColor = color;
            selectedVariety = '';

            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.color === color);
            });

            const varietySection = document.getElementById('varietySection');
            varietySection.classList.add('active');

            const varietyGrid = document.getElementById('varietyGrid');
            const varieties = varietiesByColor[color] || [];
            varietyGrid.innerHTML = varieties.map(v => `
                <div class="variety-option" data-variety="${v.toLowerCase()}" onclick="selectVariety('${v.toLowerCase()}')">
                    ${v}
                </div>
            `).join('');

            document.getElementById('verdeSalSection').classList.remove('active');

            // Ocultar secci√≥n de proceso negra si existe
            const negraSection = document.getElementById('negraProcessSection');
            if (negraSection) {
                negraSection.classList.remove('active');
            }

            // Ocultar secci√≥n de calibraci√≥n
            document.getElementById('calibrationSection').classList.remove('active');
        }

        // Variety selection
        function selectVariety(variety) {
            selectedVariety = variety;

            document.querySelectorAll('.variety-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.variety === variety);
            });

            // Si es Verde y variedad Sal, ir directo a calibraci√≥n (sin proceso)
            if (selectedColor === 'verde' && variety === 'sal') {
                selectedProcess = '';
                selectedSubProcess = '';
                document.getElementById('verdeSalSection').classList.remove('active');
                const negraSection = document.getElementById('negraProcessSection');
                if (negraSection) negraSection.classList.remove('active');
                document.getElementById('calibrationSection').classList.add('active');
                return;
            }

            // Si es Mulata, ir directo a calibraci√≥n (no tiene proceso)
            if (selectedColor === 'mulata') {
                selectedProcess = '';
                selectedSubProcess = '';
                document.getElementById('verdeSalSection').classList.remove('active');
                const negraSection = document.getElementById('negraProcessSection');
                if (negraSection) negraSection.classList.remove('active');
                document.getElementById('calibrationSection').classList.add('active');
                return;
            }

            // Si es Negra, mostrar opciones de proceso para negra
            if (selectedColor === 'negra') {
                mostrarProcesoNegra();
                return;
            }

            // Para Verde (no Sal), mostrar secci√≥n de proceso verde
            if (selectedColor === 'verde') {
                document.getElementById('verdeSalSection').classList.add('active');
                // Ocultar secci√≥n negra si existe
                const negraSection = document.getElementById('negraProcessSection');
                if (negraSection) negraSection.classList.remove('active');
            }
        }

        // Mostrar opciones de proceso para Negra
        function mostrarProcesoNegra() {
            let negraSection = document.getElementById('negraProcessSection');

            // Crear la secci√≥n si no existe
            if (!negraSection) {
                const html = `
                    <div class="process-section" id="negraProcessSection">
                        <h4 class="process-title">Tipo de Proceso - ${capitalize(selectedVariety)}</h4>
                        <div class="process-options">
                            <button type="button" class="process-btn" data-negra-process="entera" onclick="selectNegraProcess('entera')">Entera</button>
                            <button type="button" class="process-btn" data-negra-process="rodaja" onclick="selectNegraProcess('rodaja')">Rodaja</button>
                            <button type="button" class="process-btn" data-negra-process="deshuesada" onclick="selectNegraProcess('deshuesada')">Deshuesada</button>
                        </div>
                    </div>
                `;

                // Insertar despu√©s de la secci√≥n de variedad
                const varietySection = document.getElementById('varietySection');
                varietySection.insertAdjacentHTML('afterend', html);
                negraSection = document.getElementById('negraProcessSection');
            } else {
                // Actualizar t√≠tulo
                negraSection.querySelector('.process-title').textContent = `Tipo de Proceso - ${capitalize(selectedVariety)}`;
                // Resetear selecci√≥n
                negraSection.querySelectorAll('.process-btn').forEach(btn => btn.classList.remove('selected'));
            }

            negraSection.classList.add('active');
            document.getElementById('verdeSalSection').classList.remove('active');
        }

        // Selecci√≥n de proceso para negra (Entera, Rodaja, Deshuesada)
        function selectNegraProcess(proceso) {
            selectedProcess = proceso;

            // Actualizar UI
            document.querySelectorAll('#negraProcessSection .process-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.negraProcess === proceso);
            });

            // Mostrar secci√≥n de calibraci√≥n
            document.getElementById('calibrationSection').classList.add('active');
        }

        // Process selection
        function selectProcess(process) {
            selectedProcess = process;
            document.querySelectorAll('#verdeSalSection > .process-options > .process-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.process === process);
            });

            document.querySelectorAll('.subprocess-section').forEach(el => el.classList.remove('active'));
            document.getElementById('calibrationSection').classList.remove('active');

            if (process === 'entera') {
                document.getElementById('enteraOptions').classList.add('active');
            } else if (process === 'rodaja') {
                document.getElementById('rodajaOptions').classList.add('active');
            } else if (process === 'deshuesada') {
                document.getElementById('deshuesadaOptions').classList.add('active');
            }
        }

        // Sub-process selection
        function selectSubProcess(subprocess) {
            selectedSubProcess = subprocess;
            document.querySelectorAll('.subprocess-section.active .process-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.subprocess === subprocess);
            });
            document.getElementById('calibrationSection').classList.add('active');
        }

        // Destination selection
        function selectDestination(dest) {
            selectedDestination = dest;
            document.querySelectorAll('.destination-btn').forEach(el => {
                el.classList.toggle('selected', el.dataset.dest === dest);
            });

            // Si es Bidones de Exportaci√≥n, rellenar Kg por Bid√≥n con 60
            if (dest === 'exportacion') {
                calibresLote.forEach(calibre => {
                    const kilosInput = document.getElementById('calibre_kilos_' + calibre.id);
                    if (kilosInput && !kilosInput.value) {
                        kilosInput.value = '60';
                    }
                });
                actualizarTotalCalibres();
            }
        }

        // Caliber selection
        function selectCaliber(caliber) {
            selectedCaliber = caliber;
            document.querySelectorAll('.caliber-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.caliber === caliber);
            });
        }

        // Save entry (Create or Update)
        function saveEntry() {
            const entryData = {
                // C√≥digo de Lote
                codigoLote: document.getElementById('codigoLote').value,
                fecha: document.getElementById('fecha').value,
                vendedor: document.getElementById('vendedor').value,
                supervisor: document.getElementById('supervisor').value,
                precio: document.getElementById('precio').value,
                lugar: document.getElementById('lugar').value,
                cantidad: document.getElementById('cantidad').value,
                // Par√°metros de Calidad
                acidez: document.getElementById('acidez').value,
                gradosSal: document.getElementById('gradosSal').value,
                ph: document.getElementById('ph').value,
                // Tipo de Envase
                tipoEnvase: document.getElementById('tipoEnvase').value,
                envase_cantidad: document.getElementById('envase_cantidad').value,
                envase_kilos: document.getElementById('envase_kilos').value,
                envase_puchos: document.getElementById('envase_puchos').value,
                // Transporte
                transporteConductor: document.getElementById('transporteConductor').value,
                transporteViajes: document.getElementById('transporteViajes').value,
                transporteCostoViaje: document.getElementById('transporteCostoViaje').value,
                transporteTotal: document.getElementById('transporteTotal').value,
                // Observaciones
                observaciones: document.getElementById('observaciones').value,
                // Par√°metros de Calidad - Agua
                aguaCalidad: document.getElementById('aguaCalidad').value,
                // Informaci√≥n de Salmuera con precios
                salmueraAgua: document.getElementById('salmueraAgua').value,
                salmueraAguaPrecio: document.getElementById('salmueraAguaPrecio').value,
                sorbatoPotasio: document.getElementById('sorbatoPotasio').value,
                sorbatoPotasioPrecio: document.getElementById('sorbatoPotasioPrecio').value,
                acidoLactico: document.getElementById('acidoLactico').value,
                acidoLacticoPrecio: document.getElementById('acidoLacticoPrecio').value,
                acidoCitrico: document.getElementById('acidoCitrico').value,
                acidoCitricoPrecio: document.getElementById('acidoCitricoPrecio').value,
                calcio: document.getElementById('calcio').value,
                calcioPrecio: document.getElementById('calcioPrecio').value,
                acidoAcetico: document.getElementById('acidoAcetico').value,
                acidoAceticoPrecio: document.getElementById('acidoAceticoPrecio').value,
                acidoAscorbico: document.getElementById('acidoAscorbico').value,
                acidoAscorbicoPrecio: document.getElementById('acidoAscorbicoPrecio').value,
                benzoatoPotasio: document.getElementById('benzoatoPotasio').value,
                benzoatoPotasioPrecio: document.getElementById('benzoatoPotasioPrecio').value,
                salmueraOtros: document.getElementById('salmueraOtros').value,
                salmueraOtrosCosto: document.getElementById('salmueraOtrosCosto').value,
                totalCostoSalmuera: document.getElementById('totalCostoSalmuera').textContent,
                // Color y Variedad
                color: selectedColor,
                variedad: selectedVariety,
                proceso: selectedProcess,
                subProceso: selectedSubProcess,
                // Calibraci√≥n
                fechaCalibracion: document.getElementById('fechaCalibracion').value,
                responsableCalibracion: document.getElementById('responsableCalibracion').value,
                destino: 'exportacion',
                // Calibres (m√∫ltiples)
                calibres: obtenerCalibresData(),
                // Personal de Calibraci√≥n - Varones
                varonesQty: document.getElementById('varonesQty').value,
                varonesHoraHombre: document.getElementById('varonesHoraHombre').value,
                varonesHoraIngreso: document.getElementById('varonesHoraIngreso').value,
                varonesHoraFinal: document.getElementById('varonesHoraFinal').value,
                varonesHorasTrabajadas: document.getElementById('varonesHorasTrabajadas').value,
                varonesCostoTotal: document.getElementById('varonesCostoTotal').value,
                // Personal de Calibraci√≥n - Mujeres
                mujeresQty: document.getElementById('mujeresQty').value,
                mujeresHoraHombre: document.getElementById('mujeresHoraHombre').value,
                mujeresHoraIngreso: document.getElementById('mujeresHoraIngreso').value,
                mujeresHoraFinal: document.getElementById('mujeresHoraFinal').value,
                mujeresHorasTrabajadas: document.getElementById('mujeresHorasTrabajadas').value,
                mujeresCostoTotal: document.getElementById('mujeresCostoTotal').value,
                // Traspaleadores
                traspaleadoresQty: document.getElementById('traspaleadoresQty').value,
                traspaleadoresCostoDia: document.getElementById('traspaleadoresCostoDia').value,
                traspaleadoresDias: document.getElementById('traspaleadoresDias').value,
                traspaleadoresCostoTotal: document.getElementById('traspaleadoresCostoTotal').value,
                // Total Personal
                totalCostoPersonal: document.getElementById('totalCostoPersonal').textContent,
                // Otros Gastos
                otrosGastos: getOtrosGastosData(),
                totalOtrosGastos: document.getElementById('totalOtrosGastos').textContent
            };

            if (!entryData.codigoLote) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor ingrese el C√≥digo de Lote</p>', '‚ö†Ô∏è');
                document.getElementById('codigoLote').focus();
                return;
            }

            if (!entryData.fecha) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor seleccione la Fecha</p>', '‚ö†Ô∏è');
                document.getElementById('fecha').focus();
                return;
            }

            if (!entryData.vendedor) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor ingrese el nombre del Vendedor</p>', '‚ö†Ô∏è');
                document.getElementById('vendedor').focus();
                return;
            }

            if (!entryData.supervisor) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor ingrese el nombre del Supervisor</p>', '‚ö†Ô∏è');
                document.getElementById('supervisor').focus();
                return;
            }

            if (!entryData.tipoEnvase) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor seleccione el Tipo de Envase</p>', '‚ö†Ô∏è');
                document.getElementById('tipoEnvase').focus();
                return;
            }

            if (!entryData.cantidad || parseFloat(entryData.cantidad) <= 0) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor ingrese la Cantidad (debe ser mayor a 0)</p>', '‚ö†Ô∏è');
                document.getElementById('envase_cantidad').focus();
                return;
            }

            if (!selectedColor) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor seleccione el Color de la aceituna</p>', '‚ö†Ô∏è');
                return;
            }

            if (!selectedVariety) {
                mostrarModalInfo('Campo Requerido', '<p style="text-align: center; color: #64748b;">Por favor seleccione la Variedad de la aceituna</p>', '‚ö†Ô∏è');
                return;
            }

            if (editingEntryId !== null) {
                // Update existing entry
                const index = entries.findIndex(e => e.id === editingEntryId);
                if (index !== -1) {
                    entries[index] = { ...entryData, id: editingEntryId };
                }
                editingEntryId = null;
            } else {
                // Create new entry
                const entry = { ...entryData, id: Date.now() };
                entries.unshift(entry);
            }

            localStorage.setItem('aceitunaEntries', JSON.stringify(entries));
            renderEntries();
            filtrarReportes(); // Actualizar tambi√©n los reportes
            closeModalDirect(); // Cerrar sin confirmaci√≥n despu√©s de guardar
        }

        // Render entries
        // Pagination and sorting state
        let currentPage = 1;
        const entriesPerPage = 6;
        let currentSort = 'newest';

        function renderEntries() {
            const entriesList = document.getElementById('entriesList');
            const paginationContainer = document.getElementById('paginationContainer');

            if (entries.length === 0) {
                entriesList.innerHTML = `
                    <div class="no-entries" style="grid-column: 1 / -1;">
                        <div class="no-entries-icon">üì≠</div>
                        <p>No hay ventas registradas a√∫n</p>
                    </div>
                `;
                paginationContainer.innerHTML = '';
                return;
            }

            // Sort entries based on current sort
            let sortedEntries = [...entries];
            switch (currentSort) {
                case 'newest':
                    sortedEntries.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    break;
                case 'oldest':
                    sortedEntries.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    break;
                case 'price-high':
                    sortedEntries.sort((a, b) => parseFloat(b.precio || 0) - parseFloat(a.precio || 0));
                    break;
                case 'price-low':
                    sortedEntries.sort((a, b) => parseFloat(a.precio || 0) - parseFloat(b.precio || 0));
                    break;
                case 'weight-high':
                    sortedEntries.sort((a, b) => parseFloat(b.cantidad || 0) - parseFloat(a.cantidad || 0));
                    break;
                case 'weight-low':
                    sortedEntries.sort((a, b) => parseFloat(a.cantidad || 0) - parseFloat(b.cantidad || 0));
                    break;
            }

            // Calculate pagination
            const totalPages = Math.ceil(sortedEntries.length / entriesPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            const paginatedEntries = sortedEntries.slice(startIndex, endIndex);

            entriesList.innerHTML = paginatedEntries.map(entry => `
                <div class="entry-card" data-id="${entry.id}" onclick="viewEntry(${entry.id})" style="cursor: pointer;">
                    <div class="entry-card-header">
                        <span class="color-tag ${entry.color}">${capitalize(entry.color)}</span>
                        <span class="entry-date">${formatDate(entry.fecha)}</span>
                    </div>
                    ${entry.codigoLote ? `
                    <div style="padding: 0.5rem 1.2rem; background: linear-gradient(90deg, #0f172a, #1e293b); color: #4ade80; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px;">
                        üì¶ LOTE: ${entry.codigoLote}
                    </div>
                    ` : ''}
                    <div class="entry-card-body">
                        <div class="entry-field">
                            <span class="entry-field-label">Cliente</span>
                            <span class="entry-field-value">${entry.vendedor}</span>
                        </div>
                        <div class="entry-field">
                            <span class="entry-field-label">Peso</span>
                            <span class="entry-field-value highlight">${entry.cantidad} Kg</span>
                        </div>
                        ${puedeVerPrecios() ? `
                        <div class="entry-field">
                            <span class="entry-field-label">Precio</span>
                            <span class="entry-field-value">S/${entry.precio || '0'}</span>
                        </div>
                        ` : ''}
                        <div class="entry-field">
                            <span class="entry-field-label">Variedad</span>
                            <span class="entry-field-value">${entry.variedad ? capitalize(entry.variedad) : '-'}</span>
                        </div>
                        ${entry.calibres && entry.calibres.length > 0 ? `
                        <div class="entry-field" style="grid-column: 1 / -1;">
                            <span class="entry-field-label">Calibres (${entry.calibres.length})</span>
                            <span class="entry-field-value">${entry.calibres.map(c => c.calibre).join(', ')}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="entry-card-footer" onclick="event.stopPropagation();">
                        <button class="btn-icon view" onclick="viewEntry(${entry.id})" title="Ver Detalle">
                            <svg viewBox="0 0 24 24">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        <button class="btn-icon edit" onclick="editEntry(${entry.id})" title="Editar">
                            <svg viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-icon delete" onclick="showDeleteConfirm(${entry.id})" title="Eliminar">
                            <svg viewBox="0 0 24 24">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            // Render pagination
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ‚Äπ Anterior
                </button>
            `;

            // Show page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
            }

            paginationHTML += `
                <span class="pagination-info">P√°gina ${currentPage} de ${totalPages}</span>
                <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Siguiente ‚Ä∫
                </button>
            `;

            paginationContainer.innerHTML = paginationHTML;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(entries.length / entriesPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderEntries();
            }
        }

        function sortEntries(sortType) {
            if (!sortType) return;

            currentSort = sortType;
            currentPage = 1; // Reset to first page when sorting

            // Update active state for filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sort === sortType) {
                    btn.classList.add('active');
                }
            });

            // Reset dropdowns if using buttons
            if (sortType === 'newest' || sortType === 'oldest') {
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.selectedIndex = 0;
                });
            }

            renderEntries();
        }

        // Update title bar with username and time
        function updateTitleBar() {
            const userName = sessionStorage.getItem('userName') || 'Usuario';
            document.getElementById('titleBarName').textContent = `Bienvenido, ${userName}`;

            const now = new Date();
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        // Start time update interval
        setInterval(updateTitleBar, 1000);

        // Delete confirmation
        let deleteEntryId = null;

        function showDeleteConfirm(id) {
            deleteEntryId = id;
            document.getElementById('confirmOverlay').classList.add('active');
        }

        function closeConfirm() {
            deleteEntryId = null;
            document.getElementById('confirmOverlay').classList.remove('active');
        }

        function confirmDelete() {
            if (deleteEntryId !== null) {
                entries = entries.filter(e => e.id !== deleteEntryId);
                localStorage.setItem('aceitunaEntries', JSON.stringify(entries));
                renderEntries();
                filtrarReportes(); // Actualizar tambi√©n los reportes
                closeConfirm();
            }
        }

        // Edit entry - now properly updates instead of deleting
        let editingEntryId = null;

        function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            openModal(); // This calls resetForm() which clears editingEntryId
            editingEntryId = id; // Set AFTER openModal so it's not reset

            // C√≥digo de Lote e Informaci√≥n General
            document.getElementById('codigoLote').value = entry.codigoLote || '';
            document.getElementById('fecha').value = entry.fecha;
            document.getElementById('vendedor').value = entry.vendedor;
            document.getElementById('supervisor').value = entry.supervisor || '';
            document.getElementById('precio').value = entry.precio;
            document.getElementById('lugar').value = entry.lugar || '';
            document.getElementById('cantidad').value = entry.cantidad;

            // Par√°metros de Calidad
            document.getElementById('acidez').value = entry.acidez || '';
            document.getElementById('gradosSal').value = entry.gradosSal || '';
            document.getElementById('ph').value = entry.ph || '';
            document.getElementById('aguaCalidad').value = entry.aguaCalidad || '';

            // Observaciones
            document.getElementById('observaciones').value = entry.observaciones || '';

            // Informaci√≥n de Salmuera (cantidades y precios)
            document.getElementById('salmueraAgua').value = entry.salmueraAgua || '';
            document.getElementById('salmueraAguaPrecio').value = entry.salmueraAguaPrecio || '';
            document.getElementById('sorbatoPotasio').value = entry.sorbatoPotasio || '';
            document.getElementById('sorbatoPotasioPrecio').value = entry.sorbatoPotasioPrecio || '';
            document.getElementById('acidoLactico').value = entry.acidoLactico || '';
            document.getElementById('acidoLacticoPrecio').value = entry.acidoLacticoPrecio || '';
            document.getElementById('acidoCitrico').value = entry.acidoCitrico || '';
            document.getElementById('acidoCitricoPrecio').value = entry.acidoCitricoPrecio || '';
            document.getElementById('calcio').value = entry.calcio || '';
            document.getElementById('calcioPrecio').value = entry.calcioPrecio || '';
            document.getElementById('acidoAcetico').value = entry.acidoAcetico || '';
            document.getElementById('acidoAceticoPrecio').value = entry.acidoAceticoPrecio || '';
            document.getElementById('acidoAscorbico').value = entry.acidoAscorbico || '';
            document.getElementById('acidoAscorbicoPrecio').value = entry.acidoAscorbicoPrecio || '';
            document.getElementById('benzoatoPotasio').value = entry.benzoatoPotasio || '';
            document.getElementById('benzoatoPotasioPrecio').value = entry.benzoatoPotasioPrecio || '';
            document.getElementById('salmueraOtros').value = entry.salmueraOtros || '';
            document.getElementById('salmueraOtrosCosto').value = entry.salmueraOtrosCosto || '';
            // Recalcular costos de salmuera
            calcularCostoSalmuera();

            // Tipo de Envase
            if (entry.tipoEnvase) {
                document.getElementById('tipoEnvase').value = entry.tipoEnvase;
                document.getElementById('envaseFieldsContainer').style.display = 'block';
                document.getElementById('envase_cantidad').value = entry.envase_cantidad || '';
                document.getElementById('envase_kilos').value = entry.envase_kilos || '';
                document.getElementById('envase_puchos').value = entry.envase_puchos || '';
                document.getElementById('totalKgCalculado').textContent = (entry.cantidad || '0') + ' Kg';
            }

            // Transporte
            document.getElementById('transporteConductor').value = entry.transporteConductor || '';
            document.getElementById('transporteViajes').value = entry.transporteViajes || '';
            document.getElementById('transporteCostoViaje').value = entry.transporteCostoViaje || '';
            document.getElementById('transporteTotal').value = entry.transporteTotal || '';

            // Color y Variedad
            if (entry.color) selectColor(entry.color);
            if (entry.variedad) setTimeout(() => selectVariety(entry.variedad), 100);

            // Proceso: depende del color
            if (entry.proceso) {
                setTimeout(() => {
                    if (entry.color === 'negra' && (entry.variedad === 'empeltre' || entry.variedad === 'sevillana')) {
                        selectNegraProcess(entry.proceso);
                    } else if (entry.color === 'verde' && entry.variedad === 'sal') {
                        selectProcess(entry.proceso);
                    }
                }, 200);
            }
            if (entry.subProceso) setTimeout(() => selectSubProcess(entry.subProceso), 300);

            // Calibraci√≥n
            setTimeout(() => {
                document.getElementById('fechaCalibracion').value = entry.fechaCalibracion || '';
                document.getElementById('responsableCalibracion').value = entry.responsableCalibracion || '';

                if (entry.destino) selectDestination(entry.destino);

                // Cargar calibres m√∫ltiples
                if (entry.calibres && entry.calibres.length > 0) {
                    cargarCalibres(entry.calibres);
                }

                // Cargar Personal de Calibraci√≥n - Varones
                document.getElementById('varonesQty').value = entry.varonesQty || '';
                document.getElementById('varonesHoraHombre').value = entry.varonesHoraHombre || '';
                document.getElementById('varonesHoraIngreso').value = entry.varonesHoraIngreso || '';
                document.getElementById('varonesHoraFinal').value = entry.varonesHoraFinal || '';
                document.getElementById('varonesHorasTrabajadas').value = entry.varonesHorasTrabajadas || '';
                document.getElementById('varonesCostoTotal').value = entry.varonesCostoTotal || '';

                // Cargar Personal de Calibraci√≥n - Mujeres
                document.getElementById('mujeresQty').value = entry.mujeresQty || '';
                document.getElementById('mujeresHoraHombre').value = entry.mujeresHoraHombre || '';
                document.getElementById('mujeresHoraIngreso').value = entry.mujeresHoraIngreso || '';
                document.getElementById('mujeresHoraFinal').value = entry.mujeresHoraFinal || '';
                document.getElementById('mujeresHorasTrabajadas').value = entry.mujeresHorasTrabajadas || '';
                document.getElementById('mujeresCostoTotal').value = entry.mujeresCostoTotal || '';

                // Cargar Traspaleadores
                document.getElementById('traspaleadoresQty').value = entry.traspaleadoresQty || '';
                document.getElementById('traspaleadoresCostoDia').value = entry.traspaleadoresCostoDia || '';
                document.getElementById('traspaleadoresDias').value = entry.traspaleadoresDias || '1';
                document.getElementById('traspaleadoresCostoTotal').value = entry.traspaleadoresCostoTotal || '';

                // Cargar Total Personal
                document.getElementById('totalCostoPersonal').textContent = entry.totalCostoPersonal || 'S/0.00';

                // Cargar Otros Gastos
                if (entry.otrosGastos && entry.otrosGastos.length > 0) {
                    const container = document.getElementById('otrosGastosContainer');
                    container.innerHTML = '';
                    document.getElementById('noOtrosGastos').style.display = 'none';
                    document.getElementById('totalOtrosGastosRow').style.display = 'flex';

                    entry.otrosGastos.forEach(gasto => {
                        otrosGastosCounter++;
                        const gastoId = 'otroGasto_' + otrosGastosCounter;
                        const gastoHTML = `
                            <div id="${gastoId}" class="otro-gasto-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                                <input type="text" placeholder="Descripci√≥n del gasto" value="${gasto.descripcion || ''}"
                                    style="flex: 2; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem;">
                                <div style="display: flex; align-items: center; gap: 0.3rem;">
                                    <span style="color: #3d4f31; font-weight: 600;">S/</span>
                                    <input type="number" placeholder="0.00" step="0.01" min="0" value="${gasto.monto || 0}"
                                        style="width: 90px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; font-weight: 600;"
                                        oninput="calcularTotalOtrosGastos()">
                                </div>
                                <button type="button" onclick="eliminarOtroGasto('${gastoId}')"
                                    style="padding: 0.4rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
                                    ‚úï
                                </button>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', gastoHTML);
                    });
                    calcularTotalOtrosGastos();
                }
            }, 400);
        }

        // View entry - show all details
        let viewingEntryId = null;

        function viewEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            viewingEntryId = id;
            const content = document.getElementById('viewContent');

            // Format envase name
            const envaseNames = {
                'margaritos': 'Margaritos',
                'chavitos': 'Chavitos',
                'bidones': 'Bidones de Exportaci√≥n',
                'tarzas': 'Tarzas'
            };

            content.innerHTML = '<div style="display: grid; gap: 1rem;">' +
                // C√≥digo de Lote destacado - SIEMPRE mostrar
                '<div style="background: linear-gradient(135deg, #0f172a, #1e293b); padding: 1rem; border-radius: 10px; text-align: center;">' +
                '<div style="font-size: 0.75rem; color: #4ade80; text-transform: uppercase; margin-bottom: 0.3rem;">C√≥digo de Lote</div>' +
                '<div style="font-weight: 700; color: #ffffff; font-size: 1.3rem; letter-spacing: 1px;">' + (entry.codigoLote || 'Sin asignar') + '</div>' +
                '</div>' +
                // Informaci√≥n General - Grid 3 columnas
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem;">' +
                '<div style="background: #FAF8F5; padding: 0.8rem; border-radius: 10px;">' +
                '<div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">Fecha</div>' +
                '<div style="font-weight: 600; color: #0f172a;">' + formatDate(entry.fecha) + '</div>' +
                '</div>' +
                '<div style="background: #FAF8F5; padding: 0.8rem; border-radius: 10px;">' +
                '<div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">Vendedor</div>' +
                '<div style="font-weight: 600; color: #0f172a;">' + (entry.vendedor || '-') + '</div>' +
                '</div>' +
                '<div style="background: #FAF8F5; padding: 0.8rem; border-radius: 10px;">' +
                '<div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">Supervisor</div>' +
                '<div style="font-weight: 600; color: #0f172a;">' + (entry.supervisor || '-') + '</div>' +
                '</div>' +
                '<div style="background: #FAF8F5; padding: 0.8rem; border-radius: 10px;">' +
                '<div style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">Lugar</div>' +
                '<div style="font-weight: 600; color: #0f172a;">' + (entry.lugar || '-') + '</div>' +
                '</div>' +
                (puedeVerPrecios() ?
                    '<div style=\"background: #FAF8F5; padding: 0.8rem; border-radius: 10px;\">' +
                    '<div style=\"font-size: 0.7rem; color: #64748b; text-transform: uppercase;\">Precio</div>' +
                    '<div style=\"font-weight: 600; color: #0f172a;\">S/' + (entry.precio || '0') + '</div>' +
                    '</div>' : '') +
                '<div style="background: #f0fdf4; padding: 0.8rem; border-radius: 10px; border: 1px solid #bbf7d0;">' +
                '<div style="font-size: 0.7rem; color: #16a34a; text-transform: uppercase;">Cantidad Total</div>' +
                '<div style="font-weight: 700; color: #16a34a; font-size: 1.1rem;">' + (entry.cantidad || '0') + ' Kg</div>' +
                '</div>' +
                '</div>' +
                // Par√°metros de Calidad - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Par√°metros de Calidad</div>' +
                '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">' +
                '<div><div style="font-size: 0.7rem; color: #94a3b8;">Acidez</div><div style="font-weight: 600;">' + (entry.acidez || '-') + ' %</div></div>' +
                '<div><div style="font-size: 0.7rem; color: #94a3b8;">Grados de Sal</div><div style="font-weight: 600;">' + (entry.gradosSal || '-') + ' ¬∞B√©</div></div>' +
                '<div><div style="font-size: 0.7rem; color: #94a3b8;">pH</div><div style="font-weight: 600;">' + (entry.ph || '-') + '</div></div>' +
                '<div><div style="font-size: 0.7rem; color: #0369a1;">Agua</div><div style="font-weight: 600; color: #0369a1;">' + (entry.aguaCalidad || '-') + ' m¬≥</div></div>' +
                '</div>' +
                '</div>' +
                // Tipo de Envase - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Tipo de Envase</div>' +
                '<div style="font-weight: 600; color: #0f172a; font-size: 1.1rem;">' + (envaseNames[entry.tipoEnvase] || entry.tipoEnvase || '-') + '</div>' +
                '<div style="margin-top: 0.5rem; font-size: 0.9rem; color: #64748b;">' +
                'Envases: <strong>' + (entry.envase_cantidad || '0') + '</strong> √ó Kilos: <strong>' + (entry.envase_kilos || '0') + '</strong> + Puchos: <strong>' + (entry.envase_puchos || '0') + ' Kg</strong>' +
                '</div>' +
                '</div>' +
                // Transporte - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Transporte</div>' +
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; font-size: 0.85rem;">' +
                '<div><span style="color: #64748b;">Conductor:</span> <strong>' + (getConductorName(entry.transporteConductor) || '-') + '</strong></div>' +
                '<div><span style="color: #64748b;">Viajes:</span> <strong>' + (entry.transporteViajes || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Costo/Viaje:</span> <strong>S/' + (entry.transporteCostoViaje || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Traspaleadores:</span> <strong>' + (entry.transporteTraspaleadores || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Costo/Trasp.:</span> <strong>S/' + (entry.transporteCostoTraspaleador || '0') + '</strong></div>' +
                '<div style="background: #f0f9e8; padding: 0.5rem; border-radius: 6px;"><span style="color: #3d4f31; font-weight: 600;">Total:</span> <strong style="color: #3d4f31;">' + (entry.transporteTotal || 'S/0') + '</strong></div>' +
                '</div>' +
                '</div>' +
                // Aceituna
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Aceituna</div>' +
                '<div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">' +
                '<span class="color-tag ' + entry.color + '" style="padding: 0.4rem 1rem;">' + capitalize(entry.color) + '</span>' +
                '<span style="background: #e2e8f0; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 500;">' + (entry.variedad ? capitalize(entry.variedad) : '-') + '</span>' +
                (entry.proceso ? '<span style="background: #e2e8f0; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 500;">' + capitalize(entry.proceso) + '</span>' : '') +
                (entry.subProceso ? '<span style="background: #e2e8f0; padding: 0.4rem 1rem; border-radius: 20px; font-weight: 500;">' + capitalize(entry.subProceso) + '</span>' : '') +
                '</div>' +
                '</div>' +
                // Informaci√≥n de Salmuera - SIEMPRE mostrar (con costos si tiene permisos)
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Informaci√≥n de Salmuera</div>' +
                // Agua destacado
                '<div style="background: #e0f2fe; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem; border: 1px solid #7dd3fc;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<span style="color: #0369a1; font-weight: 600;">Agua</span>' +
                '<span style="font-weight: 600;">' + (entry.salmueraAgua || '0') + ' m¬≥</span>' +
                (puedeVerPrecios() ? '<span style="color: #64748b;">√ó S/' + (entry.salmueraAguaPrecio || '0') + '/m¬≥</span>' +
                    '<span style="font-weight: 700; color: #0369a1;">= S/' + ((parseFloat(entry.salmueraAgua || 0) * parseFloat(entry.salmueraAguaPrecio || 0)).toFixed(2)) + '</span>' : '') +
                '</div>' +
                '</div>' +
                // Grid de insumos
                '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">Sorbato de Potasio:</span> <strong>' + (entry.sorbatoPotasio || '-') + ' Kg</strong>' + (puedeVerPrecios() && entry.sorbatoPotasioPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.sorbatoPotasio || 0) * parseFloat(entry.sorbatoPotasioPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">√Åcido L√°ctico:</span> <strong>' + (entry.acidoLactico || '-') + ' Lt</strong>' + (puedeVerPrecios() && entry.acidoLacticoPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.acidoLactico || 0) * parseFloat(entry.acidoLacticoPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">√Åcido C√≠trico:</span> <strong>' + (entry.acidoCitrico || '-') + ' Kg</strong>' + (puedeVerPrecios() && entry.acidoCitricoPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.acidoCitrico || 0) * parseFloat(entry.acidoCitricoPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">Calcio:</span> <strong>' + (entry.calcio || '-') + ' Kg</strong>' + (puedeVerPrecios() && entry.calcioPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.calcio || 0) * parseFloat(entry.calcioPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">√Åcido Ac√©tico:</span> <strong>' + (entry.acidoAcetico || '-') + ' Lt</strong>' + (puedeVerPrecios() && entry.acidoAceticoPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.acidoAcetico || 0) * parseFloat(entry.acidoAceticoPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">√Åcido Asc√≥rbico:</span> <strong>' + (entry.acidoAscorbico || '-') + ' Kg</strong>' + (puedeVerPrecios() && entry.acidoAscorbicoPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.acidoAscorbico || 0) * parseFloat(entry.acidoAscorbicoPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">Benzoato de Potasio:</span> <strong>' + (entry.benzoatoPotasio || '-') + ' Kg</strong>' + (puedeVerPrecios() && entry.benzoatoPotasioPrecio ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + ((parseFloat(entry.benzoatoPotasio || 0) * parseFloat(entry.benzoatoPotasioPrecio || 0)).toFixed(2)) + '</span>' : '') + '</div>' +
                '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;"><span style="color: #64748b;">Otros:</span> <strong>' + (entry.salmueraOtros || '-') + '</strong>' + (puedeVerPrecios() && entry.salmueraOtrosCosto ? ' <span style="color: #3d4f31; font-weight: 600;">S/' + (parseFloat(entry.salmueraOtrosCosto || 0).toFixed(2)) + '</span>' : '') + '</div>' +
                '</div>' +
                // Total Costo Salmuera (solo si tiene permisos)
                (puedeVerPrecios() ? '<div style="margin-top: 0.8rem; padding: 0.6rem; background: linear-gradient(135deg, #0369a1, #0ea5e9); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                    '<span style="color: #fff; font-weight: 500;">Total Costo Salmuera:</span>' +
                    '<span style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">' + (entry.totalCostoSalmuera || 'S/0.00') + '</span>' +
                    '</div>' : '') +
                '</div>' +
                // Observaciones - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Observaciones</div>' +
                '<div style="font-size: 0.9rem; color: #0f172a;">' + (entry.observaciones || 'Sin observaciones') + '</div>' +
                '</div>' +
                // Calibraci√≥n - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Calibraci√≥n</div>' +
                '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin-bottom: 0.8rem;">' +
                '<div><div style="font-size: 0.7rem; color: #94a3b8;">Fecha de Calibraci√≥n</div><div style="font-weight: 500;">' + (entry.fechaCalibracion ? formatDate(entry.fechaCalibracion) : '-') + '</div></div>' +
                '<div><div style="font-size: 0.7rem; color: #94a3b8;">Responsable</div><div style="font-weight: 500;">' + (entry.responsableCalibracion || '-') + '</div></div>' +
                '</div>' +
                // Mostrar calibres m√∫ltiples
                (entry.calibres && entry.calibres.length > 0 ?
                    '<div style="margin-top: 0.8rem;">' +
                    '<div style="font-size: 0.7rem; color: #3d4f31; margin-bottom: 0.5rem; font-weight: 600;">Calibres del Lote (' + entry.calibres.length + ')</div>' +
                    entry.calibres.map((c, i) =>
                        '<div style="background: #e2e8f0; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<span style="font-weight: 600; color: #3d4f31;">' + c.calibre + '</span>' +
                        '<span style="font-weight: 600; color: #0f172a;">' + c.subtotal.toFixed(1) + ' Kg</span>' +
                        '</div>' +
                        '<div style="font-size: 0.8rem; color: #64748b; margin-top: 0.3rem;">' +
                        'Bidones: ' + c.bidones + ' √ó ' + c.kilosPorBidon + ' Kg + Sobras: ' + c.sobras + ' Kg' +
                        '</div>' +
                        '</div>'
                    ).join('') +
                    '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">' +
                    '<div style="display: flex; justify-content: space-between; color: white;">' +
                    '<span>TOTAL CALIBRES:</span>' +
                    '<strong>' + entry.calibres.reduce((sum, c) => sum + c.subtotal, 0).toFixed(1) + ' Kg</strong>' +
                    '</div></div>' +
                    '</div>'
                    : '<div style="color: #94a3b8; font-style: italic;">Sin calibres registrados</div>') +
                '</div>' +
                // Personal de Calibraci√≥n - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #3d4f31; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Personal de Calibraci√≥n</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
                // Varones
                '<div style="background: #fff; padding: 0.8rem; border-radius: 8px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.7rem; color: #3d4f31; font-weight: 600; margin-bottom: 0.5rem;">Varones</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem;">' +
                '<div><span style="color: #64748b;">Cantidad:</span> <strong>' + (entry.varonesQty || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Hora/Hombre:</span> <strong>S/' + (entry.varonesHoraHombre || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Ingreso:</span> <strong>' + (entry.varonesHoraIngreso || '-') + '</strong></div>' +
                '<div><span style="color: #64748b;">Salida:</span> <strong>' + (entry.varonesHoraFinal || '-') + '</strong></div>' +
                '<div><span style="color: #64748b;">Horas:</span> <strong>' + (entry.varonesHorasTrabajadas || '0:00') + '</strong></div>' +
                '<div style="background: #f0f9e8; padding: 0.3rem; border-radius: 4px;"><span style="color: #3d4f31;">Total:</span> <strong style="color: #3d4f31;">' + (entry.varonesCostoTotal || 'S/0.00') + '</strong></div>' +
                '</div></div>' +
                // Mujeres
                '<div style="background: #fff; padding: 0.8rem; border-radius: 8px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.7rem; color: #475569; font-weight: 600; margin-bottom: 0.5rem;">Mujeres</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem;">' +
                '<div><span style="color: #64748b;">Cantidad:</span> <strong>' + (entry.mujeresQty || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Hora/Hombre:</span> <strong>S/' + (entry.mujeresHoraHombre || '0') + '</strong></div>' +
                '<div><span style="color: #64748b;">Ingreso:</span> <strong>' + (entry.mujeresHoraIngreso || '-') + '</strong></div>' +
                '<div><span style="color: #64748b;">Salida:</span> <strong>' + (entry.mujeresHoraFinal || '-') + '</strong></div>' +
                '<div><span style="color: #64748b;">Horas:</span> <strong>' + (entry.mujeresHorasTrabajadas || '0:00') + '</strong></div>' +
                '<div style="background: #f0f9e8; padding: 0.3rem; border-radius: 4px;"><span style="color: #3d4f31;">Total:</span> <strong style="color: #3d4f31;">' + (entry.mujeresCostoTotal || 'S/0.00') + '</strong></div>' +
                '</div></div>' +
                '</div>' +
                // Total Personal de Calibraci√≥n
                '<div style="margin-top: 0.5rem; background: linear-gradient(135deg, #3d4f31, #1a1a1a); padding: 0.6rem 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                '<span style="color: #fff; font-weight: 500;">Total Personal:</span>' +
                '<span style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">' + (entry.totalCostoPersonal || 'S/0.00') + '</span>' +
                '</div>' +
                '</div>' +
                // Otros Gastos - SIEMPRE mostrar
                '<div style="background: #f8fafc; padding: 1rem; border-radius: 10px; border: 1px solid #e2e8f0;">' +
                '<div style="font-size: 0.75rem; color: #475569; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 600;">Otros Gastos</div>' +
                (entry.otrosGastos && entry.otrosGastos.length > 0 ?
                    entry.otrosGastos.map(g =>
                        '<div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fff; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #e2e8f0;">' +
                        '<span style="color: #64748b;">' + (g.descripcion || 'Sin descripci√≥n') + '</span>' +
                        '<strong style="color: #3d4f31;">S/' + (g.monto || 0).toFixed(2) + '</strong>' +
                        '</div>'
                    ).join('') +
                    '<div style="margin-top: 0.5rem; background: linear-gradient(135deg, #475569, #334155); padding: 0.6rem 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                    '<span style="color: #fff; font-weight: 500;">Total Otros Gastos:</span>' +
                    '<span style="color: #ffffff; font-weight: 700; font-size: 1.1rem;">' + (entry.totalOtrosGastos || 'S/0.00') + '</span>' +
                    '</div>'
                    : '<div style="color: #94a3b8; font-style: italic;">No hay otros gastos registrados</div>'
                ) +
                '</div>' +
                '</div>';

            document.getElementById('viewOverlay').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewOverlay').classList.remove('active');
            viewingEntryId = null;
        }

        function editFromView() {
            if (viewingEntryId) {
                closeViewModal();
                editEntry(viewingEntryId);
            }
        }

        // Utilities
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Helper para obtener nombre de conductor
        function getConductorName(value) {
            const conductorNames = {
                'costa_verde': 'Empresa Costa Verde',
                'mario': 'Mario',
                'john': 'John',
                'otro': 'Otro'
            };
            return conductorNames[value] || value || '';
        }

        // Modal events
        document.getElementById('modalOverlay').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeModal();
        });

        // ==================== M√ìDULO DE REPORTES ====================

        // Filter reports based on period and filters
        function filtrarReportes() {
            const periodo = document.getElementById('reportePeriodo').value;
            const tipoEnvase = document.getElementById('reporteTipoEnvase').value;
            const loteSeleccionado = document.getElementById('reporteLote').value;
            const fechaInicio = document.getElementById('reporteFechaInicio').value;
            const fechaFin = document.getElementById('reporteFechaFin').value;

            // Poblar selector de lotes din√°micamente
            const loteSelect = document.getElementById('reporteLote');
            const lotesUnicos = [...new Set(entries.map(e => e.codigoLote).filter(l => l))];
            const loteActual = loteSelect.value;
            loteSelect.innerHTML = '<option value="">Todos los Lotes</option>' +
                lotesUnicos.map(l => `<option value="${l}"${l === loteActual ? ' selected' : ''}>${l}</option>`).join('');

            // Show/hide custom date fields
            const fechaInicioContainer = document.getElementById('fechaInicioContainer');
            const fechaFinContainer = document.getElementById('fechaFinContainer');

            if (periodo === 'custom') {
                fechaInicioContainer.style.display = 'block';
                fechaFinContainer.style.display = 'block';
            } else {
                fechaInicioContainer.style.display = 'none';
                fechaFinContainer.style.display = 'none';
            }

            let filteredEntries = [...entries];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter by period
            if (periodo === 'today') {
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate.getTime() === today.getTime();
                });
            } else if (periodo === 'week') {
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= startOfWeek && entryDate <= today;
                });
            } else if (periodo === 'month') {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= startOfMonth && entryDate <= today;
                });
            } else if (periodo === 'custom' && fechaInicio && fechaFin) {
                const start = new Date(fechaInicio);
                const end = new Date(fechaFin);
                end.setHours(23, 59, 59, 999);
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= start && entryDate <= end;
                });
            }

            // Filter by container type
            if (tipoEnvase) {
                filteredEntries = filteredEntries.filter(e => e.tipoEnvase === tipoEnvase);
            }

            // Filter by lote
            if (loteSeleccionado) {
                filteredEntries = filteredEntries.filter(e => e.codigoLote === loteSeleccionado);
            }

            renderReporteTable(filteredEntries);
        }

        // Render report table with Excel-like format
        function renderReporteTable(data) {
            const tbody = document.getElementById('reporteTableBody');
            const noMessage = document.getElementById('noReportesMessage');
            const table = document.getElementById('reporteTable');

            const envaseNames = {
                'margaritos': 'Margaritos',
                'chavitos': 'Chavitos',
                'bidones': 'Bidones Exp.',
                'tarzas': 'Tarzas'
            };

            // Ocultar columnas de precio para no-admin
            const ocultarPrecios = !puedeVerPrecios();
            if (ocultarPrecios) {
                ['thValorCalibre', 'thCompraCol', 'thVentaCol', 'thGastosOpCol', 'thGananciaCol'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                const valorCard = document.getElementById('valorCalibresCard');
                if (valorCard) valorCard.style.display = 'none';
            } else {
                ['thValorCalibre', 'thCompraCol', 'thVentaCol', 'thGastosOpCol', 'thGananciaCol'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = '';
                });
                const valorCard = document.getElementById('valorCalibresCard');
                if (valorCard) valorCard.style.display = '';
            }

            if (data.length === 0) {
                tbody.innerHTML = '';
                table.style.display = 'none';
                noMessage.style.display = 'block';
                document.getElementById('totalRegistros').textContent = '0';
                document.getElementById('totalKilosReporte').textContent = '0 Kg';
                if (!ocultarPrecios) {
                    document.getElementById('totalValorCalibres').textContent = 'S/0';
                }
                return;
            }

            table.style.display = 'table';
            noMessage.style.display = 'none';

            let totalKilos = 0;
            let totalValorCalibres = 0;
            let rowIndex = 0;

            // Sort by lote then date descending
            data.sort((a, b) => {
                // Primero por lote
                if (a.codigoLote !== b.codigoLote) {
                    return (a.codigoLote || '').localeCompare(b.codigoLote || '');
                }
                // Luego por fecha descendente
                return new Date(b.fecha) - new Date(a.fecha);
            });

            let html = '';
            let currentLote = null;
            let loteKilos = 0;
            let loteValor = 0;
            let loteCompraReal = 0;
            let loteGanancias = 0;
            let loteGastosOperativos = 0;
            let totalGanancias = 0;

            // Funci√≥n para agregar fila de subtotal de lote
            const agregarSubtotalLote = (lote) => {
                if (lote && (loteKilos > 0 || loteValor > 0)) {
                    // Columnas antes de Subtotal Kg:
                    // Fecha, Lote, Vendedor, Supervisor, Envase, Calibre (6)
                    // + Precio Compra (1 si admin)
                    // + Bidones, Kg/Bid, Sobras (3)
                    // = 10 para admin, 9 para no-admin
                    const colspanSubtotal = ocultarPrecios ? 9 : 10;
                    // Ganancia Neta del Lote = Ganancia Bruta - Gastos Operativos
                    const loteGananciaNeta = loteGanancias - loteGastosOperativos;
                    return `
                        <tr style="background: #4b5563; color: white; font-weight: 500;">
                            <td colspan="${colspanSubtotal}" style="padding: 0.5rem; text-align: right; font-size: 0.8rem;">
                                Subtotal ${lote}
                            </td>
                            <td style="padding: 0.5rem; text-align: right; font-weight: 700; font-size: 0.85rem;">${loteKilos.toFixed(1)} Kg</td>
                            ${ocultarPrecios ? '' : `<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">S/${loteValor.toFixed(2)}</td>`}
                            ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: center; font-size: 0.85rem;">-</td>'}
                            ${ocultarPrecios ? '' : `<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">S/${loteGastosOperativos.toFixed(2)}</td>`}
                            ${ocultarPrecios ? '' : `<td style="padding: 0.5rem; text-align: right; font-weight: 700; font-size: 0.85rem;">S/${loteGananciaNeta.toFixed(2)}</td>`}
                        </tr>
                    `;
                }
                return '';
            };

            data.forEach((entry, dataIndex) => {
                const cantidad = parseFloat(entry.cantidad) || 0;

                totalKilos += cantidad;

                // A√±adir separador de lote si cambia
                if (entry.codigoLote !== currentLote && entry.codigoLote) {
                    // Primero agregar subtotal del lote anterior si existe
                    if (currentLote !== null) {
                        html += agregarSubtotalLote(currentLote);
                        // Resetear acumuladores para el nuevo lote
                        loteKilos = 0;
                        loteValor = 0;
                        loteCompraReal = 0;
                        loteGanancias = 0;
                        loteGastosOperativos = 0;
                    }

                    currentLote = entry.codigoLote;
                    // Total columnas: 10 sin precios, 15 con precios (6+1+3+1+4)
                    const totalCols = ocultarPrecios ? 10 : 15;
                    html += `
                        <tr style="background: #374151; color: white;">
                            <td colspan="${totalCols}" style="padding: 0.5rem; font-weight: 600; font-size: 0.85rem;">
                                üì¶ LOTE: ${currentLote}
                            </td>
                        </tr>
                    `;
                }

                // Acumular kilos del lote y costo de compra real
                loteKilos += cantidad;
                const precioCompra = parseFloat(entry.precio) || 0;
                loteCompraReal += precioCompra * cantidad;

                // Acumular gastos operativos del lote
                const transporteStr = entry.transporteTotal || '0';
                const transporteNum = parseFloat(transporteStr.replace('S/', '').replace(',', '')) || 0;
                const varonesStr = entry.varonesCostoTotal || '0';
                const varonesNum = parseFloat(varonesStr.replace('S/', '').replace(',', '')) || 0;
                const mujeresStr = entry.mujeresCostoTotal || '0';
                const mujeresNum = parseFloat(mujeresStr.replace('S/', '').replace(',', '')) || 0;
                const traspaleadoresStr = entry.traspaleadoresCostoTotal || '0';
                const traspaleadoresNum = parseFloat(traspaleadoresStr.replace('S/', '').replace(',', '')) || 0;
                // Agregar Otros Gastos
                const otrosGastosStr = entry.totalOtrosGastos || '0';
                const otrosGastosNum = parseFloat(otrosGastosStr.replace('S/', '').replace(',', '')) || 0;
                // Agregar Costo de Salmuera
                const salmueraStr = entry.totalCostoSalmuera || '0';
                const salmueraNum = parseFloat(salmueraStr.replace('S/', '').replace(',', '')) || 0;
                loteGastosOperativos += transporteNum + varonesNum + mujeresNum + traspaleadoresNum + otrosGastosNum + salmueraNum;

                // Si tiene calibres m√∫ltiples, crear una fila por cada calibre
                if (entry.calibres && entry.calibres.length > 0) {
                    entry.calibres.forEach((calibre, idx) => {
                        const bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f8fafc';
                        rowIndex++;

                        const calibreId = `${entry.id}_${idx}`;
                        const subtotalCalibre = calibre.subtotal || 0;

                        // Precio de venta: editable en simulaci√≥n
                        const precioVentaCalibre = preciosSimulados[calibreId] !== undefined ? preciosSimulados[calibreId] : (calibre.precio || 0);
                        const valorCalibre = modoSimularVenta ? (precioVentaCalibre * subtotalCalibre) : (calibre.valorTotal || 0);

                        // Calcular ganancia del calibre: (Precio Venta - Precio Compra) √ó Subtotal
                        const gananciaCalibre = (precioVentaCalibre - precioCompra) * subtotalCalibre;
                        loteGanancias += gananciaCalibre;
                        totalGanancias += gananciaCalibre;

                        totalValorCalibres += valorCalibre;
                        loteValor += valorCalibre; // Acumular valor del lote

                        // Celda de Precio de Venta - editable en modo simulaci√≥n
                        let precioVentaCeldaHtml = '';
                        let gananciaCeldaHtml = '';
                        if (!ocultarPrecios) {
                            if (modoSimularVenta) {
                                precioVentaCeldaHtml = `
                                    <td style="padding: 0.3rem 0.5rem; text-align: right; background: #d1fae5;">
                                        <input type="number" class="precio-simulado-input" 
                                            data-calibre-id="${calibreId}" 
                                            data-subtotal="${subtotalCalibre}"
                                            data-precio-compra="${precioCompra}"
                                            value="${precioVentaCalibre > 0 ? precioVentaCalibre : ''}" 
                                            placeholder="0.00" step="0.01" min="0"
                                            style="width: 70px; padding: 0.3rem; border: 1px solid #10b981; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-align: right; background: #ecfdf5;"
                                            oninput="actualizarPrecioSimulado('${calibreId}', this.value)">
                                    </td>`;
                            } else {
                                precioVentaCeldaHtml = `<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">${precioVentaCalibre > 0 ? 'S/' + precioVentaCalibre.toFixed(2) : '-'}</td>`;
                            }
                            // Celda de ganancia - sin colores llamativos
                            gananciaCeldaHtml = `<td data-ganancia-calibre="${calibreId}" style="padding: 0.5rem; text-align: right; font-weight: 600; font-size: 0.85rem;">${precioVentaCalibre > 0 ? 'S/' + gananciaCalibre.toFixed(2) : '-'}</td>`;
                        }

                        html += `
                            <tr style="background: ${bgColor}; border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.5rem; white-space: nowrap; font-size: 0.85rem;">${formatDate(entry.fecha)}</td>
                                <td style="padding: 0.5rem; font-weight: 600; color: #3d4f31; font-size: 0.85rem;">${entry.codigoLote || '-'}</td>
                                <td style="padding: 0.5rem; font-size: 0.85rem;">${entry.vendedor || '-'}</td>
                                <td style="padding: 0.5rem; font-size: 0.85rem;">${entry.responsableCalibracion || '-'}</td>
                                <td style="padding: 0.5rem; font-size: 0.85rem;">${envaseNames[entry.tipoEnvase] || '-'}</td>
                                <td style="padding: 0.5rem; font-weight: 500; font-size: 0.85rem;">${calibre.calibre}</td>
                                ${ocultarPrecios ? '' : `<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">S/${precioCompra.toFixed(2)}</td>`}
                                <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">${calibre.bidones}</td>
                                <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">${calibre.kilosPorBidon}</td>
                                <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">${calibre.sobras}</td>
                                <td style="padding: 0.5rem; text-align: right; font-weight: 600; font-size: 0.85rem;">${subtotalCalibre.toFixed(1)} Kg</td>
                                ${ocultarPrecios ? '' : `<td data-valor-calibre="${calibreId}" style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">${valorCalibre > 0 ? 'S/' + valorCalibre.toFixed(2) : '-'}</td>`}
                                ${ocultarPrecios ? '' : precioVentaCeldaHtml}
                                ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: right; color: #9ca3af; font-size: 0.85rem;">-</td>'}
                                ${ocultarPrecios ? '' : gananciaCeldaHtml}
                            </tr>
                        `;
                    });
                } else {
                    // Sin calibres
                    const bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                    rowIndex++;
                    html += `
                        <tr style="background: ${bgColor}; border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 0.5rem; white-space: nowrap; font-size: 0.85rem;">${formatDate(entry.fecha)}</td>
                            <td style="padding: 0.5rem; font-weight: 600; color: #3d4f31; font-size: 0.85rem;">${entry.codigoLote || '-'}</td>
                            <td style="padding: 0.5rem; font-size: 0.85rem;">${entry.vendedor || '-'}</td>
                            <td style="padding: 0.5rem; font-size: 0.85rem;">${entry.responsableCalibracion || '-'}</td>
                            <td style="padding: 0.5rem; font-size: 0.85rem;">${envaseNames[entry.tipoEnvase] || '-'}</td>
                            <td style="padding: 0.5rem; font-weight: 500; font-size: 0.85rem;">-</td>
                            ${ocultarPrecios ? '' : `<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">S/${precioCompra.toFixed(2)}</td>`}
                            <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>
                            <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>
                            <td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>
                            <td style="padding: 0.5rem; text-align: right; color: #9ca3af; font-size: 0.85rem;">-</td>
                            ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>'}
                            ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>'}
                            ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>'}
                            ${ocultarPrecios ? '' : '<td style="padding: 0.5rem; text-align: right; font-size: 0.85rem;">-</td>'}
                        </tr>
                    `;
                }
            });

            // Agregar subtotal del √∫ltimo lote
            if (currentLote !== null) {
                html += agregarSubtotalLote(currentLote);
            }

            // Add totals row - calcular costos operativos primero
            let totalCompraTabla = 0;
            let totalGastosOperativos = 0;

            data.forEach(entry => {
                const precio = parseFloat(entry.precio) || 0;
                const cantidad = parseFloat(entry.cantidad) || 0;
                totalCompraTabla += precio * cantidad;

                // Sumar costos operativos
                const transporteStr = entry.transporteTotal || '0';
                const transporteNum = parseFloat(transporteStr.replace('S/', '').replace(',', '')) || 0;

                const varonesStr = entry.varonesCostoTotal || '0';
                const varonesNum = parseFloat(varonesStr.replace('S/', '').replace(',', '')) || 0;

                const mujeresStr = entry.mujeresCostoTotal || '0';
                const mujeresNum = parseFloat(mujeresStr.replace('S/', '').replace(',', '')) || 0;

                const traspaleadoresStr = entry.traspaleadoresCostoTotal || '0';
                const traspaleadoresNum = parseFloat(traspaleadoresStr.replace('S/', '').replace(',', '')) || 0;

                // Agregar Otros Gastos
                const otrosGastosStr = entry.totalOtrosGastos || '0';
                const otrosGastosNum = parseFloat(otrosGastosStr.replace('S/', '').replace(',', '')) || 0;

                totalGastosOperativos += transporteNum + varonesNum + mujeresNum + traspaleadoresNum + otrosGastosNum;
            });

            // Ganancia Neta Total = Ganancia Bruta Total - Gastos Operativos Totales
            const totalGananciaNeta = totalGanancias - totalGastosOperativos;
            const colspanTotal = ocultarPrecios ? 9 : 10;
            html += `
                <tr style="background: #1f2937; color: white; font-weight: 600;">
                    <td colspan="${colspanTotal}" style="padding: 0.6rem; text-align: right; font-size: 0.85rem;">TOTAL GENERAL</td>
                    <td style="padding: 0.6rem; text-align: right; font-weight: 700; font-size: 0.9rem;">${totalKilos.toFixed(1)} Kg</td>
                    ${ocultarPrecios ? '' : `<td style="padding: 0.6rem; text-align: right; font-size: 0.9rem;">S/${totalValorCalibres.toFixed(2)}</td>`}
                    ${ocultarPrecios ? '' : '<td style="padding: 0.6rem; text-align: center; font-size: 0.9rem;">-</td>'}
                    ${ocultarPrecios ? '' : `<td style="padding: 0.6rem; text-align: right; font-size: 0.9rem;">S/${totalGastosOperativos.toFixed(2)}</td>`}
                    ${ocultarPrecios ? '' : `<td style="padding: 0.6rem; text-align: right; font-weight: 700; font-size: 0.9rem;">S/${totalGananciaNeta.toFixed(2)}</td>`}
                </tr>
            `;

            tbody.innerHTML = html;

            // Calcular costos adicionales
            let costoAceitunas = 0;
            let costoTransporte = 0;
            let costoVarones = 0;
            let costoMujeres = 0;
            let costoTraspaleadores = 0;

            data.forEach(entry => {
                // Costo de aceitunas: precio √ó cantidad
                const precio = parseFloat(entry.precio) || 0;
                const cantidad = parseFloat(entry.cantidad) || 0;
                costoAceitunas += precio * cantidad;

                // Costo de transporte
                const transporteStr = entry.transporteTotal || '';
                const transporteNum = parseFloat(transporteStr.replace('S/', '').replace(',', '')) || 0;
                costoTransporte += transporteNum;

                // Costo de personal varones
                const varonesStr = entry.varonesCostoTotal || '';
                const varonesNum = parseFloat(varonesStr.replace('S/', '').replace(',', '')) || 0;
                costoVarones += varonesNum;

                // Costo de personal mujeres
                const mujeresStr = entry.mujeresCostoTotal || '';
                const mujeresNum = parseFloat(mujeresStr.replace('S/', '').replace(',', '')) || 0;
                costoMujeres += mujeresNum;

                // Costo de traspaleadores
                const traspaleadoresStr = entry.traspaleadoresCostoTotal || '';
                const traspaleadoresNum = parseFloat(traspaleadoresStr.replace('S/', '').replace(',', '')) || 0;
                costoTraspaleadores += traspaleadoresNum;
            });

            const costoPersonalTotal = costoVarones + costoMujeres + costoTraspaleadores;

            // Costo de Compra = suma de (precio √ó cantidad) de cada entrada
            // costoAceitunas ya contiene este c√°lculo
            const costoCompra = costoAceitunas;

            // Update summary cards
            document.getElementById('totalRegistros').textContent = data.length;
            document.getElementById('totalKilosReporte').textContent = totalKilos.toFixed(1) + ' Kg';

            if (!ocultarPrecios) {
                // Costo de Venta (suma valores calibres)
                document.getElementById('totalValorCalibres').textContent = 'S/' + totalValorCalibres.toFixed(2);

                // Costo de Compra (Kg √ó 6.6)
                document.getElementById('costoCompra').textContent = 'S/' + costoCompra.toFixed(2);

                // Costos Operativos
                document.getElementById('costoTransporteTotal').textContent = 'S/' + costoTransporte.toFixed(2);
                document.getElementById('costoVarones').textContent = 'S/' + costoVarones.toFixed(2);
                document.getElementById('costoMujeres').textContent = 'S/' + costoMujeres.toFixed(2);
                document.getElementById('costoPersonalTotal').textContent = 'S/' + costoPersonalTotal.toFixed(2);

                // Guardar valores para el c√°lculo de ganancia
                window.reporteData = {
                    costoVenta: totalValorCalibres,
                    costoCompra: costoCompra,
                    costoTransporte: costoTransporte,
                    costoPersonal: costoPersonalTotal,
                    totalKilos: totalKilos
                };

                calcularGananciaReporte();
            }
        }

        // Calcular ganancia del reporte
        function calcularGananciaReporte() {
            const data = window.reporteData || { costoVenta: 0, costoCompra: 0, costoTransporte: 0, costoPersonal: 0, totalKilos: 0 };
            const otrosGastos = parseFloat(document.getElementById('otrosGastosReporte').value) || 0;

            // Costos Operativos = Personal + Transporte + Otros Gastos
            const totalOperativos = data.costoPersonal + data.costoTransporte + otrosGastos;
            document.getElementById('totalCostosOperativos').textContent = 'S/' + totalOperativos.toFixed(2);

            // Actualizar costos totales en el simulador
            const costosTotales = data.costoCompra + totalOperativos;
            document.getElementById('costosTotalesSimulador').textContent = 'S/' + costosTotales.toFixed(2);

            // Llamar al simulador para actualizar valores
            simularGanancia();
        }

        // Simular ganancia basado en precio de venta editable
        function simularGanancia() {
            const data = window.reporteData || { costoVenta: 0, costoCompra: 0, costoTransporte: 0, costoPersonal: 0, totalKilos: 0 };
            const otrosGastos = parseFloat(document.getElementById('otrosGastosReporte').value) || 0;

            // Obtener precio de venta del input
            const precioVenta = parseFloat(document.getElementById('precioVentaSimulador').value) || 0;
            const totalKilos = data.totalKilos || 0;

            // Calcular Ingreso de Venta = Precio de Venta √ó Total Kg
            const ingresoVenta = precioVenta * totalKilos;
            document.getElementById('ingresoVentaSimulador').textContent = 'S/' + ingresoVenta.toFixed(2);

            // Costos Totales = Compra + Operativos
            const totalOperativos = data.costoPersonal + data.costoTransporte + otrosGastos;
            const costosTotales = data.costoCompra + totalOperativos;
            document.getElementById('costosTotalesSimulador').textContent = 'S/' + costosTotales.toFixed(2);

            // Ganancia = Ingreso de Venta - Costos Totales
            const ganancia = ingresoVenta - costosTotales;

            const gananciaEl = document.getElementById('gananciaSimulador');
            const gananciaCard = document.getElementById('gananciaSimuladorCard');

            gananciaEl.textContent = 'S/' + ganancia.toFixed(2);

            // Cambiar color seg√∫n ganancia positiva o negativa
            if (ganancia >= 0) {
                gananciaEl.style.color = '#4ade80'; // Verde
                gananciaCard.style.background = 'linear-gradient(135deg, #3d4f31, #5a7247)';
                gananciaCard.style.borderColor = '#4ade80';
            } else {
                gananciaEl.style.color = '#ef4444'; // Rojo
                gananciaCard.style.background = 'linear-gradient(135deg, #7f1d1d, #991b1b)';
                gananciaCard.style.borderColor = '#ef4444';
            }
        }

        // Variable para modo de simulaci√≥n de venta
        let modoSimularVenta = false;
        let preciosSimulados = {}; // Almacena los precios simulados por calibre

        // Toggle modo simular venta
        function toggleSimularVenta() {
            modoSimularVenta = !modoSimularVenta;
            const btn = document.getElementById('btnSimularVenta');

            if (modoSimularVenta) {
                btn.style.background = 'linear-gradient(135deg, #dc2626, #ef4444)';
                btn.innerHTML = '‚úï Salir Simulaci√≥n';
                preciosSimulados = {}; // Reset precios simulados
            } else {
                btn.style.background = 'linear-gradient(135deg, #059669, #10b981)';
                btn.innerHTML = 'üí∞ Simular Venta';
            }

            // Mostrar/ocultar panel de llenado r√°pido
            const panelLlenado = document.getElementById('panelLlenadoRapido');
            if (panelLlenado) {
                panelLlenado.style.display = modoSimularVenta ? 'block' : 'none';
            }

            // Volver a renderizar la tabla con/sin modo simulaci√≥n
            filtrarReportes();
        }

        // Llenar todos los precios con un valor
        function llenarTodosPrecios() {
            const precio = parseFloat(document.getElementById('precioLlenadoTodos').value) || 0;
            if (precio <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Por favor ingrese un precio v√°lido</p>', '‚ö†Ô∏è');
                return;
            }

            document.querySelectorAll('.precio-simulado-input').forEach(input => {
                input.value = precio.toFixed(2);
                const calibreId = input.dataset.calibreId;
                preciosSimulados[calibreId] = precio;
            });

            recalcularTotalesSimulados();
        }

        // Llenar precios por rango (distribuye proporcionalmente)
        function llenarPreciosPorRango() {
            const precioDesde = parseFloat(document.getElementById('precioDesde').value) || 0;
            const precioHasta = parseFloat(document.getElementById('precioHasta').value) || 0;

            if (precioDesde <= 0 || precioHasta <= 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Por favor ingrese precios v√°lidos para el rango</p>', '‚ö†Ô∏è');
                return;
            }

            const inputs = document.querySelectorAll('.precio-simulado-input');
            const total = inputs.length;

            if (total === 0) return;

            const incremento = total > 1 ? (precioHasta - precioDesde) / (total - 1) : 0;

            inputs.forEach((input, index) => {
                const precio = precioDesde + (incremento * index);
                input.value = precio.toFixed(2);
                const calibreId = input.dataset.calibreId;
                preciosSimulados[calibreId] = precio;
            });

            recalcularTotalesSimulados();
        }

        // Limpiar todos los precios
        function limpiarTodosPrecios() {
            document.querySelectorAll('.precio-simulado-input').forEach(input => {
                input.value = '';
                const calibreId = input.dataset.calibreId;
                preciosSimulados[calibreId] = 0;
            });

            // Limpiar inputs del panel
            document.getElementById('precioLlenadoTodos').value = '';
            document.getElementById('precioDesde').value = '';
            document.getElementById('precioHasta').value = '';

            recalcularTotalesSimulados();
        }

        // Actualizar precio simulado
        function actualizarPrecioSimulado(calibreId, nuevoPrecio) {
            preciosSimulados[calibreId] = parseFloat(nuevoPrecio) || 0;
            recalcularTotalesSimulados();
        }

        // Recalcular totales cuando se cambian precios simulados
        function recalcularTotalesSimulados() {
            let totalValorSimulado = 0;
            let totalGananciasSimuladas = 0;

            // Recalcular cada valor de calibre y ganancia
            document.querySelectorAll('.precio-simulado-input').forEach(input => {
                const calibreId = input.dataset.calibreId;
                const subtotal = parseFloat(input.dataset.subtotal) || 0;
                const precioCompra = parseFloat(input.dataset.precioCompra) || 0;
                const precioVenta = parseFloat(input.value) || 0;
                const valorCalc = precioVenta * subtotal;
                const gananciaCalc = (precioVenta - precioCompra) * subtotal;

                // Actualizar celda de valor
                const valorCell = document.querySelector(`[data-valor-calibre="${calibreId}"]`);
                if (valorCell) {
                    valorCell.textContent = valorCalc > 0 ? 'S/' + valorCalc.toFixed(2) : '-';
                }

                // Actualizar celda de ganancia
                const gananciaCell = document.querySelector(`[data-ganancia-calibre="${calibreId}"]`);
                if (gananciaCell) {
                    gananciaCell.textContent = precioVenta > 0 ? 'S/' + gananciaCalc.toFixed(2) : '-';
                    // Cambiar color seg√∫n positivo o negativo
                    if (gananciaCalc >= 0) {
                        gananciaCell.style.background = '#dcfce7';
                        gananciaCell.style.color = '#22c55e';
                    } else {
                        gananciaCell.style.background = '#fee2e2';
                        gananciaCell.style.color = '#ef4444';
                    }
                }

                totalValorSimulado += valorCalc;
                totalGananciasSimuladas += gananciaCalc;
            });

            // Actualizar total de valor calibres
            document.getElementById('totalValorCalibres').textContent = 'S/' + totalValorSimulado.toFixed(2);

            // Actualizar simulador de ganancia
            if (window.reporteData) {
                window.reporteData.costoVenta = totalValorSimulado;
                simularGanancia();
            }
        }

        // Mostrar modal con f√≥rmulas del sistema
        function mostrarFormulas() {
            const modalHtml = `
                <div id="formulasModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid #3d4f31;">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="color: #4ade80; margin: 0; font-size: 1.3rem;">üìñ F√≥rmulas del Sistema</h2>
                            <button onclick="cerrarFormulas()" style="background: #dc2626; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                        </div>
                        
                        <div style="padding: 1.5rem;">
                            <!-- Calibraci√≥n -->
                            <div style="background: #334155; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <h3 style="color: #fbbf24; margin: 0 0 0.8rem 0; font-size: 1rem;">üì¶ Calibraci√≥n</h3>
                                <div style="background: #0f172a; padding: 0.8rem; border-radius: 8px; font-family: monospace; color: #a5f3fc;">
                                    <p style="margin: 0.3rem 0;"><strong style="color: #4ade80;">Subtotal Calibre</strong> = Bidones √ó Kg/Bid√≥n + Sobras</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #4ade80;">Total Kg</strong> = Œ£ (Subtotal de todos los calibres del lote)</p>
                                </div>
                            </div>

                            <!-- Costos de Compra -->
                            <div style="background: #334155; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <h3 style="color: #f87171; margin: 0 0 0.8rem 0; font-size: 1rem;">üí∞ Costos de Compra</h3>
                                <div style="background: #0f172a; padding: 0.8rem; border-radius: 8px; font-family: monospace; color: #a5f3fc;">
                                    <p style="margin: 0.3rem 0;"><strong style="color: #f87171;">Precio Compra</strong> = Precio por Kg ingresado al a√±adir compra</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #f87171;">Valor Total de Compra</strong> = Precio Compra √ó Subtotal Calibre</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #f87171;">Costo Total Aceitunas</strong> = Œ£ (Precio √ó Cantidad de cada entrada)</p>
                                </div>
                            </div>

                            <!-- Costos Operativos -->
                            <div style="background: #334155; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <h3 style="color: #fb923c; margin: 0 0 0.8rem 0; font-size: 1rem;">üè≠ Costos Operativos</h3>
                                <div style="background: #0f172a; padding: 0.8rem; border-radius: 8px; font-family: monospace; color: #a5f3fc;">
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fb923c;">Costo Varones</strong> = Cantidad √ó Hora/Hombre √ó Horas Trabajadas</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fb923c;">Costo Mujeres</strong> = Cantidad √ó Hora/Hombre √ó Horas Trabajadas</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fb923c;">Costo Traspaleadores</strong> = Cantidad √ó Costo/D√≠a √ó D√≠as</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fb923c;">Costo Transporte</strong> = Viajes √ó Costo por Viaje</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fb923c;">Costo Salmuera</strong> = Œ£ (Cantidad √ó Precio) de cada insumo</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #fbbf24;">Total Operativos</strong> = Personal + Transporte + Otros Gastos + Salmuera</p>
                                </div>
                            </div>

                            <!-- Ventas y Ganancias -->
                            <div style="background: #334155; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <h3 style="color: #4ade80; margin: 0 0 0.8rem 0; font-size: 1rem;">üìà Ventas y Ganancias</h3>
                                <div style="background: #0f172a; padding: 0.8rem; border-radius: 8px; font-family: monospace; color: #a5f3fc;">
                                    <p style="margin: 0.3rem 0;"><strong style="color: #4ade80;">Precio de Venta</strong> = Precio al que vendemos cada Kg</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #4ade80;">Ingreso por Calibre</strong> = Precio Venta √ó Subtotal Calibre</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #22d3ee;">Ganancia por Calibre</strong> = (Precio Venta - Precio Compra) √ó Subtotal</p>
                                    <p style="margin: 0.3rem 0;"><strong style="color: #22d3ee;">Ganancia Total</strong> = Œ£ (Ganancias de todos los calibres)</p>
                                </div>
                            </div>

                            <!-- Simulaci√≥n -->
                            <div style="background: #334155; padding: 1rem; border-radius: 10px;">
                                <h3 style="color: #a78bfa; margin: 0 0 0.8rem 0; font-size: 1rem;">üéØ Modo Simulaci√≥n</h3>
                                <div style="background: #0f172a; padding: 0.8rem; border-radius: 8px; font-family: monospace; color: #a5f3fc;">
                                    <p style="margin: 0.3rem 0;">Al activar "Simular Venta", puedes editar el <strong style="color: #4ade80;">Precio de Venta</strong></p>
                                    <p style="margin: 0.3rem 0;">de cada calibre y ver c√≥mo cambian las <strong style="color: #fbbf24;">Ganancias</strong> en tiempo real.</p>
                                    <p style="margin: 0.3rem 0; color: #94a3b8; font-size: 0.85rem;">Los cambios en simulaci√≥n NO se guardan permanentemente.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Cerrar modal de f√≥rmulas
        function cerrarFormulas() {
            const modal = document.getElementById('formulasModal');
            if (modal) modal.remove();
        }

        // Export report to Excel (.xlsx)
        function exportarReporteExcel() {
            const periodo = document.getElementById('reportePeriodo').value;
            const tipoEnvase = document.getElementById('reporteTipoEnvase').value;
            const fechaInicio = document.getElementById('reporteFechaInicio').value;
            const fechaFin = document.getElementById('reporteFechaFin').value;

            let filteredEntries = [...entries];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Apply same filters as table
            if (periodo === 'today') {
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate.getTime() === today.getTime();
                });
            } else if (periodo === 'week') {
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= startOfWeek && entryDate <= today;
                });
            } else if (periodo === 'month') {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= startOfMonth && entryDate <= today;
                });
            } else if (periodo === 'custom' && fechaInicio && fechaFin) {
                const start = new Date(fechaInicio);
                const end = new Date(fechaFin);
                end.setHours(23, 59, 59, 999);
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.fecha);
                    return entryDate >= start && entryDate <= end;
                });
            }

            if (tipoEnvase) {
                filteredEntries = filteredEntries.filter(e => e.tipoEnvase === tipoEnvase);
            }

            if (filteredEntries.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay datos para exportar</p>', '‚ö†Ô∏è');
                return;
            }

            const envaseNames = {
                'margaritos': 'Margaritos',
                'chavitos': 'Chavitos',
                'bidones': 'Bidones Exportacion',
                'tarzas': 'Tarzas'
            };

            // Sort by lote
            filteredEntries.sort((a, b) => {
                if (a.codigoLote !== b.codigoLote) {
                    return (a.codigoLote || '').localeCompare(b.codigoLote || '');
                }
                return new Date(b.fecha) - new Date(a.fecha);
            });

            // Create Excel XML content with improved styles
            let excel = '<?xml version="1.0" encoding="UTF-8"?>\n';
            excel += '<?mso-application progid="Excel.Sheet"?>\n';
            excel += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
            excel += '<Styles>\n';
            // Header principal - olivo oscuro
            excel += '  <Style ss:ID="Header"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3d4f31" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center"/></Style>\n';
            // Header lote - gris oscuro
            excel += '  <Style ss:ID="LoteHeader"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#1e293b" ss:Pattern="Solid"/></Style>\n';
            // Data normal
            excel += '  <Style ss:ID="Data"><Alignment ss:Vertical="Center"/></Style>\n';
            // N√∫meros
            excel += '  <Style ss:ID="Number"><NumberFormat ss:Format="0.00"/><Alignment ss:Horizontal="Right"/></Style>\n';
            // Total por lote - gris
            excel += '  <Style ss:ID="Subtotal"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#64748b" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/></Style>\n';
            // Total general - olivo
            excel += '  <Style ss:ID="Total"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3d4f31" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/></Style>\n';
            // Valor Calibres - verde olivo claro
            excel += '  <Style ss:ID="ValorCal"><Font ss:Bold="1" ss:Color="#3d4f31"/><Interior ss:Color="#d9f99d" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/><NumberFormat ss:Format="0.00"/></Style>\n';
            // Compra - rojo
            excel += '  <Style ss:ID="Compra"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#dc2626" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/><NumberFormat ss:Format="0.00"/></Style>\n';
            // Venta - verde
            excel += '  <Style ss:ID="Venta"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#059669" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/><NumberFormat ss:Format="0.00"/></Style>\n';
            excel += '</Styles>\n';
            excel += '<Worksheet ss:Name="Reporte de Compras">\n';
            excel += '<Table>\n';

            // Headers
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Fecha</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Lote</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Vendedor</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Supervisor</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Envase</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Calibre</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">P. Compra</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Bidones</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Kg/Bid</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Sobras</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Subtotal Kg</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Valor Compra</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Gastos Op.</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Gan. Netas</Data></Cell>\n';
            excel += '</Row>\n';

            let totalKilos = 0;
            let totalValorCalibres = 0;
            let totalGastosOperativos = 0;
            let totalGanancias = 0;
            let currentLote = null;
            let loteKilos = 0;
            let loteValor = 0;
            let loteGastosOp = 0;
            let loteGanancias = 0;

            // Function to add lote subtotal row
            const addLoteSubtotal = () => {
                if (currentLote && (loteKilos > 0 || loteValor > 0)) {
                    const loteGananciaNeta = loteGanancias - loteGastosOp;
                    excel += '<Row>\n';
                    excel += '  <Cell ss:StyleID="Subtotal" ss:MergeAcross="10"><Data ss:Type="String">Subtotal ' + currentLote + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Subtotal"><Data ss:Type="Number">' + loteKilos.toFixed(1) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Subtotal"><Data ss:Type="Number">' + loteValor.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Compra"><Data ss:Type="Number">' + loteGastosOp.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Venta"><Data ss:Type="Number">' + loteGananciaNeta.toFixed(2) + '</Data></Cell>\n';
                    excel += '</Row>\n';
                }
            };

            filteredEntries.forEach(entry => {
                const cantidad = parseFloat(entry.cantidad) || 0;
                totalKilos += cantidad;

                // Calcular gastos operativos de esta entrada
                const transporteStr = entry.transporteTotal || '0';
                const transporteNum = parseFloat(transporteStr.replace('S/', '').replace(',', '')) || 0;
                const varonesStr = entry.varonesCostoTotal || '0';
                const varonesNum = parseFloat(varonesStr.replace('S/', '').replace(',', '')) || 0;
                const mujeresStr = entry.mujeresCostoTotal || '0';
                const mujeresNum = parseFloat(mujeresStr.replace('S/', '').replace(',', '')) || 0;
                const traspaleadoresStr = entry.traspaleadoresCostoTotal || '0';
                const traspaleadoresNum = parseFloat(traspaleadoresStr.replace('S/', '').replace(',', '')) || 0;
                // Agregar Otros Gastos
                const otrosGastosStr = entry.totalOtrosGastos || '0';
                const otrosGastosNum = parseFloat(otrosGastosStr.replace('S/', '').replace(',', '')) || 0;
                // Agregar Costo de Salmuera
                const salmueraStr = entry.totalCostoSalmuera || '0';
                const salmueraNum = parseFloat(salmueraStr.replace('S/', '').replace(',', '')) || 0;
                const entryGastosOp = transporteNum + varonesNum + mujeresNum + traspaleadoresNum + otrosGastosNum + salmueraNum;

                // Precio de compra real
                const precioCompra = parseFloat(entry.precio) || 0;

                // Check if lote changed
                if (entry.codigoLote !== currentLote && entry.codigoLote) {
                    if (currentLote !== null) {
                        addLoteSubtotal();
                        loteKilos = 0;
                        loteValor = 0;
                        loteGastosOp = 0;
                        loteGanancias = 0;
                    }
                    currentLote = entry.codigoLote;
                    // Add lote header row
                    excel += '<Row>\n';
                    excel += '  <Cell ss:StyleID="LoteHeader" ss:MergeAcross="13"><Data ss:Type="String">LOTE: ' + currentLote + '</Data></Cell>\n';
                    excel += '</Row>\n';
                }

                loteKilos += cantidad;
                loteGastosOp += entryGastosOp;
                totalGastosOperativos += entryGastosOp;

                // Si tiene calibres m√∫ltiples
                if (entry.calibres && entry.calibres.length > 0) {
                    const entryValorTotal = entry.calibres.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                    loteValor += entryValorTotal;
                    totalValorCalibres += entryValorTotal;

                    // Calcular ganancias por calibre
                    entry.calibres.forEach(c => {
                        const gananciaCalibre = ((c.precio || 0) - precioCompra) * (c.subtotal || 0);
                        loteGanancias += gananciaCalibre;
                        totalGanancias += gananciaCalibre;
                    });

                    entry.calibres.forEach((calibre, idx) => {
                        const gananciaCalibre = ((calibre.precio || 0) - precioCompra) * (calibre.subtotal || 0);
                        const valorCompraCalibre = precioCompra * (calibre.subtotal || 0);
                        excel += '<Row>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.fecha || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.codigoLote || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.vendedor || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.responsableCalibracion || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (envaseNames[entry.tipoEnvase] || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + calibre.calibre + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + precioCompra.toFixed(2) + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.bidones + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.kilosPorBidon + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.sobras + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.subtotal.toFixed(1) + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + valorCompraCalibre.toFixed(2) + '</Data></Cell>\n';
                        // Gastos Op: solo mostrar en primera fila del entry
                        if (idx === 0) {
                            excel += '  <Cell ss:StyleID="Compra"><Data ss:Type="Number">' + entryGastosOp.toFixed(2) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Venta"><Data ss:Type="Number">' + gananciaCalibre.toFixed(2) + '</Data></Cell>\n';
                        } else {
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + gananciaCalibre.toFixed(2) + '</Data></Cell>\n';
                        }
                        excel += '</Row>\n';
                    });
                } else {
                    // Sin calibres
                    const valorCompraEntry = precioCompra * cantidad;
                    excel += '<Row>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.fecha || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.codigoLote || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.vendedor || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.responsableCalibracion || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (envaseNames[entry.tipoEnvase] || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + precioCompra.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + cantidad.toFixed(1) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + valorCompraEntry.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Compra"><Data ss:Type="Number">' + entryGastosOp.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '</Row>\n';
                }
            });

            // Add last lote subtotal
            addLoteSubtotal();

            // Add totals row
            const totalGananciaNeta = totalGanancias - totalGastosOperativos;
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Total" ss:MergeAcross="10"><Data ss:Type="String">TOTAL GENERAL</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalKilos.toFixed(1) + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalValorCalibres.toFixed(2) + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Compra"><Data ss:Type="Number">' + totalGastosOperativos.toFixed(2) + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Venta"><Data ss:Type="Number">' + totalGananciaNeta.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';

            excel += '</Table>\n';
            excel += '</Worksheet>\n';
            excel += '</Workbook>';

            // Download as Excel file
            const fileName = 'reporte_compras_' + periodo + '_' + new Date().toISOString().split('T')[0] + '.xls';
            const blob = new Blob([excel], { type: 'application/vnd.ms-excel' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // Export only selected lote to Excel
        function exportarLoteExcel() {
            const loteSeleccionado = document.getElementById('reporteLote').value;

            if (!loteSeleccionado) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">Por favor seleccione un lote espec√≠fico para exportar.</p><p style="text-align: center; font-size: 0.85rem; color: #94a3b8; margin-top: 0.5rem;">Use "Exportar Todo" para exportar todos los registros.</p>', '‚ö†Ô∏è');
                return;
            }

            // Filter only by selected lote
            let filteredEntries = entries.filter(e => e.codigoLote === loteSeleccionado);

            if (filteredEntries.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay datos para este lote</p>', '‚ö†Ô∏è');
                return;
            }

            const envaseNames = {
                'margaritos': 'Margaritos',
                'chavitos': 'Chavitos',
                'bidones': 'Bidones Exportacion',
                'tarzas': 'Tarzas'
            };

            // Create Excel XML content with expanded columns
            let excel = '<?xml version="1.0" encoding="UTF-8"?>\n';
            excel += '<?mso-application progid="Excel.Sheet"?>\n';
            excel += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
            excel += '<Styles>\n';
            // Header principal - olivo oscuro
            excel += '  <Style ss:ID="Header"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3d4f31" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center"/></Style>\n';
            // Header lote - gris oscuro
            excel += '  <Style ss:ID="LoteHeader"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#1e293b" ss:Pattern="Solid"/></Style>\n';
            // Data normal
            excel += '  <Style ss:ID="Data"><Alignment ss:Vertical="Center"/></Style>\n';
            // N√∫meros
            excel += '  <Style ss:ID="Number"><NumberFormat ss:Format="0.00"/><Alignment ss:Horizontal="Right"/></Style>\n';
            // Precio - verde olivo claro
            excel += '  <Style ss:ID="Price"><NumberFormat ss:Format="0.00"/><Alignment ss:Horizontal="Right"/><Interior ss:Color="#d9f99d" ss:Pattern="Solid"/></Style>\n';
            // Valor - verde olivo medio
            excel += '  <Style ss:ID="Value"><NumberFormat ss:Format="0.00"/><Alignment ss:Horizontal="Right"/><Interior ss:Color="#bbf7d0" ss:Pattern="Solid"/><Font ss:Bold="1"/></Style>\n';
            // Compra - rojo
            excel += '  <Style ss:ID="Compra"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#dc2626" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/><NumberFormat ss:Format="0.00"/></Style>\n';
            // Venta - verde
            excel += '  <Style ss:ID="Venta"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#059669" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/><NumberFormat ss:Format="0.00"/></Style>\n';
            // Total - olivo
            excel += '  <Style ss:ID="Total"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3d4f31" ss:Pattern="Solid"/><Alignment ss:Horizontal="Right"/></Style>\n';
            excel += '</Styles>\n';
            excel += '<Worksheet ss:Name="Lote ' + loteSeleccionado + '">\n';
            excel += '<Table>\n';

            // Headers with new columns
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Fecha</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Codigo Lote</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Vendedor</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Supervisor</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Tipo Envase</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Calibre</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Bidones</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Kg/Bidon</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Sobras Kg</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Subtotal Kg</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Precio/Kg</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Valor Calibre</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Total Lote Kg</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Costo Compra S/</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Conductor</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Viajes</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Costo/Viaje</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Traspaleadores</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Costo/Trasp</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Header"><Data ss:Type="String">Total Transp</Data></Cell>\n';
            excel += '</Row>\n';

            let totalKilos = 0;
            let totalCostoCompra = 0;
            let totalValorCalibres = 0;

            filteredEntries.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            filteredEntries.forEach(entry => {
                const cantidad = parseFloat(entry.cantidad) || 0;
                const costoCompra = parseFloat(entry.precio) || 0;

                totalKilos += cantidad;
                totalCostoCompra += costoCompra;

                if (entry.calibres && entry.calibres.length > 0) {
                    entry.calibres.forEach((calibre, idx) => {
                        const precioCalibre = calibre.precio || 0;
                        const valorCalibre = calibre.valorTotal || 0;
                        totalValorCalibres += valorCalibre;

                        excel += '<Row>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + formatDate(entry.fecha) + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.codigoLote || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.vendedor || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.responsableCalibracion || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (envaseNames[entry.tipoEnvase] || '') + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + calibre.calibre + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.bidones + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.kilosPorBidon + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.sobras + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + calibre.subtotal.toFixed(2) + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Price"><Data ss:Type="Number">' + precioCalibre.toFixed(2) + '</Data></Cell>\n';
                        excel += '  <Cell ss:StyleID="Value"><Data ss:Type="Number">' + valorCalibre.toFixed(2) + '</Data></Cell>\n';
                        if (idx === 0) {
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + cantidad.toFixed(2) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + costoCompra.toFixed(2) + '</Data></Cell>\n';
                            // Transporte - solo en primera fila
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (getConductorName(entry.transporteConductor) || '') + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteViajes || 0) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteCostoViaje || 0) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteTraspaleadores || 0) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteCostoTraspaleador || 0) + '</Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.transporteTotal || '') + '</Data></Cell>\n';
                        } else {
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            // Transporte vac√≠o
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String"></Data></Cell>\n';
                        }
                        excel += '</Row>\n';
                    });
                } else {
                    excel += '<Row>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + formatDate(entry.fecha) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.codigoLote || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.vendedor || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.responsableCalibracion || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (envaseNames[entry.tipoEnvase] || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">-</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Price"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Value"><Data ss:Type="Number">0</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + cantidad.toFixed(2) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + costoCompra.toFixed(2) + '</Data></Cell>\n';
                    // Transporte
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (getConductorName(entry.transporteConductor) || '') + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteViajes || 0) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteCostoViaje || 0) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteTraspaleadores || 0) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + (entry.transporteCostoTraspaleador || 0) + '</Data></Cell>\n';
                    excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">' + (entry.transporteTotal || '') + '</Data></Cell>\n';
                    excel += '</Row>\n';
                }
            });

            // Add totals row
            const totalInversion = totalCostoCompra + totalValorCalibres;
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Total" ss:MergeAcross="9"><Data ss:Type="String">TOTAL LOTE ' + loteSeleccionado + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="String">-</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalValorCalibres.toFixed(2) + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalKilos.toFixed(2) + '</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalCostoCompra.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';

            // Add summary row
            excel += '<Row></Row>\n';
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Header" ss:MergeAcross="1"><Data ss:Type="String">RESUMEN LOTE</Data></Cell>\n';
            excel += '</Row>\n';
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">Total Kilos:</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + totalKilos.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">Costo Compra:</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + totalCostoCompra.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Data"><Data ss:Type="String">Valor Calibres:</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Number"><Data ss:Type="Number">' + totalValorCalibres.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';
            excel += '<Row>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="String">Total Inversi√≥n:</Data></Cell>\n';
            excel += '  <Cell ss:StyleID="Total"><Data ss:Type="Number">' + totalInversion.toFixed(2) + '</Data></Cell>\n';
            excel += '</Row>\n';

            excel += '</Table>\n';
            excel += '</Worksheet>\n';
            excel += '</Workbook>';

            // Download as Excel file
            const fileName = 'Lote_' + loteSeleccionado + '_' + new Date().toISOString().split('T')[0] + '.xls';
            const blob = new Blob([excel], { type: 'application/vnd.ms-excel' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // =====================================================
        // SISTEMA DE ALMAC√âN DIN√ÅMICO
        // Jerarqu√≠a: Almac√©n > Filas > Cuadrantes > Lotes > Calibres
        // =====================================================

        // Asegurar que almacenData tenga estructura de filas
        if (!almacenData.filas) {
            almacenData.filas = [];
        }

        // Abrir modal de reubicaci√≥n desde el bot√≥n principal
        function abrirReubicacionDesdeAlmacen() {
            let html = '<div id="modalReubicacionMenu" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden;">';
            html += '<div style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<h3 style="margin: 0;">üîÑ Reubicaci√≥n</h3>';
            html += '<button onclick="cerrarModalReubicacionMenu()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem;">';
            html += '<p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem; text-align: center;">¬øQu√© deseas reubicar?</p>';

            html += '<div onclick="abrirReubicacionLote()" style="padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 1rem; cursor: pointer; display: flex; align-items: center; gap: 1rem;">';
            html += '<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3d4f31, #5a7247); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üì¶</div>';
            html += '<div><div style="font-weight: 700; color: #1e293b; font-size: 1.1rem;">Reubicar Lote</div>';
            html += '<div style="font-size: 0.85rem; color: #64748b;">Mover un lote completo a otro cuadrante</div></div>';
            html += '</div>';

            html += '<div onclick="abrirReubicacionCalibre()" style="padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 1rem;">';
            html += '<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #7c3aed, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚öñÔ∏è</div>';
            html += '<div><div style="font-weight: 700; color: #1e293b; font-size: 1.1rem;">Reubicar Calibre</div>';
            html += '<div style="font-size: 0.85rem; color: #64748b;">Mover un calibre espec√≠fico a otro cuadrante</div></div>';
            html += '</div>';

            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalReubicacionMenu() {
            var modal = document.getElementById('modalReubicacionMenu');
            if (modal) modal.remove();
        }

        // ===== REUBICAR LOTE =====
        function abrirReubicacionLote() {
            cerrarModalReubicacionMenu();
            var lotesDisponibles = [];
            for (var fi = 0; fi < almacenData.filas.length; fi++) {
                var fila = almacenData.filas[fi];
                for (var ci = 0; ci < fila.cuadrantes.length; ci++) {
                    var cuad = fila.cuadrantes[ci];
                    for (var li = 0; li < cuad.lotes.length; li++) {
                        var lote = cuad.lotes[li];
                        var totalKg = 0;
                        for (var c = 0; c < lote.calibres.length; c++) {
                            totalKg += lote.calibres[c].kg || 0;
                        }
                        lotesDisponibles.push({
                            fi: fi, ci: ci, li: li,
                            filaNombre: fila.nombre, cuadNombre: cuad.nombre,
                            codigo: lote.codigoLote, numCal: lote.calibres.length, kg: totalKg
                        });
                    }
                }
            }
            if (lotesDisponibles.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay lotes en el almac√©n para reubicar.</p>', '‚ö†Ô∏è');
                return;
            }
            var html = '<div id="modalReubicacionLote" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden;">';
            html += '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<h3 style="margin: 0;">üì¶ Reubicar Lote</h3>';
            html += '<button onclick="cerrarModalReubicacionLote()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div class="modal-scroll" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">';
            html += '<p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">Selecciona el lote que deseas mover:</p>';
            for (var i = 0; i < lotesDisponibles.length; i++) {
                var item = lotesDisponibles[i];
                html += '<div onclick="seleccionarLoteParaReubicar(' + item.fi + ',' + item.ci + ',' + item.li + ')" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 600; color: #1e293b; margin-bottom: 0.3rem;">üì¶ ' + item.codigo + '</div>';
                html += '<div style="font-size: 0.8rem; color: #64748b;">üìç ' + item.filaNombre + ' &gt; ' + item.cuadNombre + '</div></div>';
                html += '<div style="text-align: right;"><span style="font-weight: 600; color: #3d4f31;">' + item.kg.toFixed(1) + ' Kg</span>';
                html += '<div style="font-size: 0.7rem; color: #64748b;">' + item.numCal + ' calibre(s)</div></div></div>';
            }
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalReubicacionLote() {
            var modal = document.getElementById('modalReubicacionLote');
            if (modal) modal.remove();
        }

        function seleccionarLoteParaReubicar(fi, ci, li) {
            cerrarModalReubicacionLote();
            var lote = almacenData.filas[fi].cuadrantes[ci].lotes[li];
            var totalKg = 0;
            for (var c = 0; c < lote.calibres.length; c++) totalKg += lote.calibres[c].kg || 0;
            var destinos = [];
            for (var f = 0; f < almacenData.filas.length; f++) {
                for (var c = 0; c < almacenData.filas[f].cuadrantes.length; c++) {
                    if (f !== fi || c !== ci) {
                        destinos.push({ f: f, c: c, nombre: almacenData.filas[f].nombre + ' &gt; ' + almacenData.filas[f].cuadrantes[c].nombre });
                    }
                }
            }
            if (destinos.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay otros cuadrantes disponibles.</p>', '‚ö†Ô∏è');
                return;
            }
            var html = '<div id="modalDestinoLote" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px;">';
            html += '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;">';
            html += '<h3 style="margin: 0;">üìç Destino del Lote</h3>';
            html += '<button onclick="cerrarModalDestinoLote()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div class="modal-scroll" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">';
            html += '<p style="margin-bottom: 1rem; color: #64748b; font-size: 0.9rem;">Moviendo: <strong style="color: #1e293b;">üì¶ ' + lote.codigoLote + '</strong> (' + totalKg.toFixed(1) + ' Kg)</p>';
            for (var i = 0; i < destinos.length; i++) {
                var d = destinos[i];
                html += '<div onclick="ejecutarMoverLote(' + fi + ',' + ci + ',' + li + ',' + d.f + ',' + d.c + ')" style="padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;">üìç ' + d.nombre + '</div>';
            }
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalDestinoLote() {
            var modal = document.getElementById('modalDestinoLote');
            if (modal) modal.remove();
        }

        function ejecutarMoverLote(ofi, oci, oli, dfi, dci) {
            var lote = almacenData.filas[ofi].cuadrantes[oci].lotes[oli];
            var copia = JSON.parse(JSON.stringify(lote));
            almacenData.filas[dfi].cuadrantes[dci].lotes.push(copia);
            almacenData.filas[ofi].cuadrantes[oci].lotes.splice(oli, 1);
            guardarAlmacen();
            cerrarModalDestinoLote();
            renderizarAlmacen();
        }

        // ===== REUBICAR CALIBRE =====
        function abrirReubicacionCalibre() {
            cerrarModalReubicacionMenu();
            var calibres = [];
            for (var fi = 0; fi < almacenData.filas.length; fi++) {
                var fila = almacenData.filas[fi];
                for (var ci = 0; ci < fila.cuadrantes.length; ci++) {
                    var cuad = fila.cuadrantes[ci];
                    for (var li = 0; li < cuad.lotes.length; li++) {
                        var lote = cuad.lotes[li];
                        for (var cali = 0; cali < lote.calibres.length; cali++) {
                            var cal = lote.calibres[cali];
                            calibres.push({
                                fi: fi, ci: ci, li: li, cali: cali,
                                filaNombre: fila.nombre, cuadNombre: cuad.nombre,
                                loteCodigo: lote.codigoLote, calibre: cal.calibre, kg: cal.kg
                            });
                        }
                    }
                }
            }
            if (calibres.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay calibres en el almac√©n para reubicar.</p>', '‚ö†Ô∏è');
                return;
            }
            var html = '<div id="modalReubicacionGeneral" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden;">';
            html += '<div style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<h3 style="margin: 0;">‚öñÔ∏è Reubicar Calibre</h3>';
            html += '<button onclick="cerrarModalReubicacionGeneral()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div class="modal-scroll" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">';
            html += '<p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">Selecciona el calibre que deseas mover:</p>';
            for (var i = 0; i < calibres.length; i++) {
                var item = calibres[i];
                html += '<div onclick="seleccionarCalibreParaReubicar(' + item.fi + ',' + item.ci + ',' + item.li + ',' + item.cali + ')" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><div style="font-weight: 600; color: #1e293b; margin-bottom: 0.3rem;">‚öñÔ∏è ' + item.calibre + '</div>';
                html += '<div style="font-size: 0.8rem; color: #64748b;">üìç ' + item.filaNombre + ' &gt; ' + item.cuadNombre + ' &gt; ' + item.loteCodigo + '</div></div>';
                html += '<div style="text-align: right;"><span style="font-weight: 600; color: #8b5cf6;">' + item.kg + ' Kg</span></div></div>';
            }
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalReubicacionGeneral() {
            var modal = document.getElementById('modalReubicacionGeneral');
            if (modal) modal.remove();
        }

        function seleccionarCalibreParaReubicar(fi, ci, li, cali) {
            cerrarModalReubicacionGeneral();
            moverCalibre(fi, ci, li, cali);
        }

        // Guardar datos del almac√©n
        function guardarAlmacen() {
            localStorage.setItem('almacenData', JSON.stringify(almacenData));
        }

        // Renderizar el almac√©n completo
        function renderizarAlmacen() {
            const container = document.getElementById('filasAlmacenContainer');
            const sinFilas = document.getElementById('sinFilas');

            if (!container) return;

            if (almacenData.filas.length === 0) {
                container.innerHTML = `
                    <div id="sinFilas" style="text-align: center; padding: 3rem; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No hay filas en el almac√©n</p>
                        <p style="font-size: 0.9rem;">Haz clic en "Nueva Fila" para comenzar a organizar tu almac√©n</p>
                    </div>
                `;
                return;
            }

            let html = '';
            almacenData.filas.forEach((fila, filaIndex) => {
                html += `
                    <div class="fila-almacen" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem;">
                        <!-- Header de la Fila -->
                        <div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="font-size: 1.5rem;">üìç</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">${fila.nombre}</h3>
                                    <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">${fila.cuadrantes.length} cuadrante(s)</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="agregarCuadrante(${filaIndex})" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;">
                                    ‚ûï Cuadrante
                                </button>
                                <button onclick="editarFila(${filaIndex})" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="eliminarFila(${filaIndex})" style="background: rgba(239,68,68,0.8); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <!-- Cuadrantes de la Fila -->
                        <div style="padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                    ${fila.cuadrantes.length === 0 ? `
                                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94a3b8; border: 2px dashed #e2e8f0; border-radius: 10px;">
                                    <p style="margin: 0;">Sin cuadrantes - Haz clic en "+ Cuadrante"</p>
                                </div>
                            ` : fila.cuadrantes.map((cuadrante, cuadranteIndex) => renderizarCuadrante(cuadrante, filaIndex, cuadranteIndex)).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Renderizar un cuadrante
        function renderizarCuadrante(cuadrante, filaIndex, cuadranteIndex) {
            const totalKg = cuadrante.lotes.reduce((sum, lote) => {
                return sum + lote.calibres.reduce((s, c) => s + (c.kg || 0), 0);
            }, 0);

            return `
                <div class="cuadrante-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                    <!-- Header Cuadrante -->
                    <div style="background: #1e293b; color: white; padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; font-size: 0.95rem;">${cuadrante.nombre}</span>
                            <span style="font-size: 0.75rem; opacity: 0.7; margin-left: 0.5rem;">(${totalKg.toFixed(1)} Kg)</span>
                        </div>
                        <div style="display: flex; gap: 0.3rem;">
                            <button onclick="agregarLoteACuadrante(${filaIndex}, ${cuadranteIndex})" style="background: #3d4f31; color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                + Lote
                            </button>
                            <button onclick="eliminarCuadrante(${filaIndex}, ${cuadranteIndex})" style="background: #dc2626; color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenido del Cuadrante -->
                    <div style="padding: 0.8rem; max-height: 300px; overflow-y: auto;">
                        ${cuadrante.lotes.length === 0 ? `
                            <p style="text-align: center; color: #94a3b8; font-size: 0.85rem; padding: 1rem;">Sin lotes asignados</p>
                        ` : cuadrante.lotes.map((lote, loteIndex) => renderizarLoteEnCuadrante(lote, filaIndex, cuadranteIndex, loteIndex)).join('')}
                    </div>
                </div>
            `;
        }

        // Renderizar un lote dentro de un cuadrante
        function renderizarLoteEnCuadrante(lote, filaIndex, cuadranteIndex, loteIndex) {
            const totalLoteKg = lote.calibres.reduce((sum, c) => sum + (c.kg || 0), 0);

            return `
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden;">
                    <!-- Header del Lote -->
                    <div style="background: #e2e8f0; padding: 0.5rem 0.8rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 0.85rem; color: #1e293b;">üì¶ ${lote.codigoLote || 'Lote'}</span>
                        <div style="display: flex; align-items: center; gap: 0.3rem;">
                            <span style="font-size: 0.75rem; color: #64748b;">${totalLoteKg.toFixed(1)} Kg</span>
                            <button onclick="quitarLoteDeCuadrante(${filaIndex}, ${cuadranteIndex}, ${loteIndex})" style="background: transparent; border: none; color: #dc2626; cursor: pointer; font-size: 0.8rem;">‚úï</button>
                        </div>
                    </div>
                    
                    <!-- Calibres del Lote -->
                    <div style="padding: 0.5rem;">
                        ${lote.calibres.map((calibre, calibreIndex) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                                <span style="color: #3d4f31; font-weight: 500;">${calibre.calibre}</span>
                                <span style="color: #64748b;">${calibre.kg} Kg</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Abrir modal para nueva fila
        function abrirModalNuevaFila() {
            var html = '<div id="modalNuevaFila" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üìÅ</span><h3 style="margin: 0; font-size: 1.1rem;">Nueva Fila</h3></div>';
            html += '<button onclick="cerrarModalNuevaFila()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem;">';
            html += '<label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; font-weight: 600;">Nombre de la nueva fila:</label>';
            html += '<input type="text" id="inputNuevaFila" placeholder="Ej: Zona A" style="width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalNuevaFila()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarNuevaFila()" style="background: linear-gradient(135deg, #3d4f31, #5a7247); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Crear Fila</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('inputNuevaFila').focus();
        }

        function cerrarModalNuevaFila() {
            var modal = document.getElementById('modalNuevaFila');
            if (modal) modal.remove();
        }

        function confirmarNuevaFila() {
            var nombre = document.getElementById('inputNuevaFila').value.trim();
            if (nombre) {
                almacenData.filas.push({ nombre: nombre, cuadrantes: [] });
                guardarAlmacen();
                renderizarAlmacen();
            }
            cerrarModalNuevaFila();
        }

        // Editar nombre de fila
        function editarFila(filaIndex) {
            var fila = almacenData.filas[filaIndex];
            var html = '<div id="modalEditarFila" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">‚úèÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Editar Fila</h3></div>';
            html += '<button onclick="cerrarModalEditarFila()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem;">';
            html += '<label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; font-weight: 600;">Nuevo nombre de la fila:</label>';
            html += '<input type="text" id="inputEditarFila" value="' + fila.nombre + '" style="width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">';
            html += '<input type="hidden" id="indexEditarFila" value="' + filaIndex + '">';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalEditarFila()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarEditarFila()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Guardar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('inputEditarFila').focus();
            document.getElementById('inputEditarFila').select();
        }

        function cerrarModalEditarFila() {
            var modal = document.getElementById('modalEditarFila');
            if (modal) modal.remove();
        }

        function confirmarEditarFila() {
            var nombre = document.getElementById('inputEditarFila').value.trim();
            var index = parseInt(document.getElementById('indexEditarFila').value);
            if (nombre) {
                almacenData.filas[index].nombre = nombre;
                guardarAlmacen();
                renderizarAlmacen();
            }
            cerrarModalEditarFila();
        }

        // Eliminar fila
        function eliminarFila(filaIndex) {
            var fila = almacenData.filas[filaIndex];
            var html = '<div id="modalConfirmarEliminar" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üóëÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Eliminar Fila</h3></div>';
            html += '<button onclick="cerrarModalConfirmarEliminar()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem; text-align: center;">';
            html += '<p style="color: #1e293b; margin-bottom: 0.5rem;">¬øEliminar la fila <strong>"' + fila.nombre + '"</strong>?</p>';
            html += '<p style="color: #dc2626; font-size: 0.85rem;">Esta acci√≥n eliminar√° todos sus cuadrantes y no se puede deshacer.</p>';
            html += '<input type="hidden" id="indexEliminarFila" value="' + filaIndex + '">';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalConfirmarEliminar()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarEliminarFila()" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Eliminar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalConfirmarEliminar() {
            var modal = document.getElementById('modalConfirmarEliminar');
            if (modal) modal.remove();
        }

        function confirmarEliminarFila() {
            var index = parseInt(document.getElementById('indexEliminarFila').value);
            almacenData.filas.splice(index, 1);
            guardarAlmacen();
            renderizarAlmacen();
            cerrarModalConfirmarEliminar();
        }

        // Agregar cuadrante a una fila
        function agregarCuadrante(filaIndex) {
            var html = '<div id="modalNuevoCuadrante" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üì¶</span><h3 style="margin: 0; font-size: 1.1rem;">Nuevo Cuadrante</h3></div>';
            html += '<button onclick="cerrarModalNuevoCuadrante()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem;">';
            html += '<label style="display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; font-weight: 600;">Nombre del cuadrante:</label>';
            html += '<input type="text" id="inputNuevoCuadrante" placeholder="Ej: Cuadrante 1" style="width: 100%; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">';
            html += '<input type="hidden" id="indexFilaCuadrante" value="' + filaIndex + '">';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalNuevoCuadrante()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarNuevoCuadrante()" style="background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Crear</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('inputNuevoCuadrante').focus();
        }

        function cerrarModalNuevoCuadrante() {
            var modal = document.getElementById('modalNuevoCuadrante');
            if (modal) modal.remove();
        }

        function confirmarNuevoCuadrante() {
            var nombre = document.getElementById('inputNuevoCuadrante').value.trim();
            var filaIndex = parseInt(document.getElementById('indexFilaCuadrante').value);
            if (nombre) {
                almacenData.filas[filaIndex].cuadrantes.push({ nombre: nombre, lotes: [] });
                guardarAlmacen();
                renderizarAlmacen();
            }
            cerrarModalNuevoCuadrante();
        }

        // Eliminar cuadrante
        function eliminarCuadrante(filaIndex, cuadranteIndex) {
            var cuadrante = almacenData.filas[filaIndex].cuadrantes[cuadranteIndex];
            var html = '<div id="modalConfirmarEliminarCuad" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üóëÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Eliminar Cuadrante</h3></div>';
            html += '<button onclick="cerrarModalConfirmarEliminarCuad()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem; text-align: center;">';
            html += '<p style="color: #1e293b; margin-bottom: 0.5rem;">¬øEliminar el cuadrante <strong>"' + cuadrante.nombre + '"</strong>?</p>';
            html += '<p style="color: #dc2626; font-size: 0.85rem;">Esta acci√≥n no se puede deshacer.</p>';
            html += '<input type="hidden" id="indexFilaElimCuad" value="' + filaIndex + '">';
            html += '<input type="hidden" id="indexCuadElimCuad" value="' + cuadranteIndex + '">';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalConfirmarEliminarCuad()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarEliminarCuadrante()" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Eliminar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalConfirmarEliminarCuad() {
            var modal = document.getElementById('modalConfirmarEliminarCuad');
            if (modal) modal.remove();
        }

        function confirmarEliminarCuadrante() {
            var filaIndex = parseInt(document.getElementById('indexFilaElimCuad').value);
            var cuadranteIndex = parseInt(document.getElementById('indexCuadElimCuad').value);
            almacenData.filas[filaIndex].cuadrantes.splice(cuadranteIndex, 1);
            guardarAlmacen();
            renderizarAlmacen();
            cerrarModalConfirmarEliminarCuad();
        }

        // Agregar lote a un cuadrante (seleccionar de los lotes registrados)
        function agregarLoteACuadrante(filaIndex, cuadranteIndex) {
            // Crear modal de selecci√≥n de lotes
            const lotesDisponibles = entries.filter(e => e.codigoLote && e.calibres && e.calibres.length > 0);

            if (lotesDisponibles.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay lotes con calibres registrados. Primero registra entradas con calibres.</p>', '‚ö†Ô∏è');
                return;
            }

            let html = `
                <div id="modalSeleccionLote" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden;">
                        <div style="background: #3d4f31; color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">Seleccionar Lote</h3>
                            <button onclick="cerrarModalSeleccionLote()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
                        </div>
                        <div class="modal-scroll" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                            ${lotesDisponibles.map(lote => `
                                <div onclick="seleccionarLote(${filaIndex}, ${cuadranteIndex}, ${lote.id})" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;">
                                    <div style="font-weight: 600; color: #1e293b;">${lote.codigoLote}</div>
                                    <div style="font-size: 0.85rem; color: #64748b;">${lote.vendedor || 'Sin vendedor'} - ${lote.calibres.length} calibre(s)</div>
                                    <div style="font-size: 0.8rem; color: #3d4f31; margin-top: 0.3rem;">
                                        ${lote.calibres.map(c => c.calibre + ' (' + c.subtotal + ' Kg)').join(', ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', html);
        }

        // Cerrar modal de selecci√≥n de lote
        function cerrarModalSeleccionLote() {
            const modal = document.getElementById('modalSeleccionLote');
            if (modal) modal.remove();
        }

        // Seleccionar un lote para agregar al cuadrante
        function seleccionarLote(filaIndex, cuadranteIndex, loteId) {
            const entry = entries.find(e => e.id === loteId);
            if (!entry) return;

            // Crear estructura del lote para el cuadrante
            const loteParaCuadrante = {
                loteId: loteId,
                codigoLote: entry.codigoLote,
                calibres: entry.calibres.map(c => ({
                    calibre: c.calibre,
                    kg: c.subtotal || 0
                }))
            };

            almacenData.filas[filaIndex].cuadrantes[cuadranteIndex].lotes.push(loteParaCuadrante);
            guardarAlmacen();
            cerrarModalSeleccionLote();
            renderizarAlmacen();
        }

        var loteParaQuitar = null;

        // Quitar lote de un cuadrante
        function quitarLoteDeCuadrante(filaIndex, cuadranteIndex, loteIndex) {
            loteParaQuitar = { fi: filaIndex, ci: cuadranteIndex, li: loteIndex };
            var html = '<div id="modalConfirmarQuitarLote" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; padding: 1rem;">';
            html += '<div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">';
            html += '<div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
            html += '<div style="display: flex; align-items: center; gap: 0.8rem;"><span style="font-size: 1.5rem;">üóëÔ∏è</span><h3 style="margin: 0; font-size: 1.1rem;">Quitar Lote</h3></div>';
            html += '<button onclick="cerrarModalQuitarLote()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer;">√ó</button>';
            html += '</div>';
            html += '<div style="padding: 1.5rem; text-align: center;">';
            html += '<p style="color: #1e293b; margin-bottom: 0.5rem;">¬øQuitar este lote del cuadrante?</p>';
            html += '<p style="color: #64748b; font-size: 0.85rem;">El lote ser√° removido de este cuadrante.</p>';
            html += '</div>';
            html += '<div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.8rem;">';
            html += '<button onclick="cerrarModalQuitarLote()" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 0.7rem 1.2rem; border-radius: 8px; cursor: pointer; color: #64748b;">Cancelar</button>';
            html += '<button onclick="confirmarQuitarLote()" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Quitar</button>';
            html += '</div></div></div>';
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function cerrarModalQuitarLote() {
            var modal = document.getElementById('modalConfirmarQuitarLote');
            if (modal) modal.remove();
            loteParaQuitar = null;
        }

        function confirmarQuitarLote() {
            if (loteParaQuitar) {
                almacenData.filas[loteParaQuitar.fi].cuadrantes[loteParaQuitar.ci].lotes.splice(loteParaQuitar.li, 1);
                guardarAlmacen();
                renderizarAlmacen();
            }
            cerrarModalQuitarLote();
        }

        // Mover calibre a otro cuadrante
        function moverCalibre(filaIndex, cuadranteIndex, loteIndex, calibreIndex) {
            const calibre = almacenData.filas[filaIndex].cuadrantes[cuadranteIndex].lotes[loteIndex].calibres[calibreIndex];

            // Crear lista de destinos posibles
            let destinos = [];
            almacenData.filas.forEach((fila, fi) => {
                fila.cuadrantes.forEach((cuad, ci) => {
                    if (fi !== filaIndex || ci !== cuadranteIndex) {
                        destinos.push({
                            filaIndex: fi,
                            cuadranteIndex: ci,
                            nombre: `${fila.nombre} > ${cuad.nombre} `
                        });
                    }
                });
            });

            if (destinos.length === 0) {
                mostrarModalInfo('Aviso', '<p style="text-align: center; color: #64748b;">No hay otros cuadrantes disponibles. Crea m√°s cuadrantes primero.</p>', '‚ö†Ô∏è');
                return;
            }

            let html = `
                <div id="modalMoverCalibre" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px;">
                        <div style="background: #8b5cf6; color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0;">üîÑ Mover Calibre</h3>
                            <button onclick="cerrarModalMoverCalibre()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
                        </div>
                        <div class="modal-scroll" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                            <p style="margin-bottom: 1rem; color: #64748b; font-size: 0.9rem;">Moviendo: <strong style="color: #1e293b;">${calibre.calibre} (${calibre.kg} Kg)</strong></p>
                            <p style="margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Selecciona destino:</p>
                            ${destinos.map((d, i) => `
                                <div onclick="ejecutarMoverCalibre(${filaIndex}, ${cuadranteIndex}, ${loteIndex}, ${calibreIndex}, ${d.filaIndex}, ${d.cuadranteIndex})" 
                                     style="padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                    üìç ${d.nombre}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', html);
        }

        // Cerrar modal de mover calibre
        function cerrarModalMoverCalibre() {
            const modal = document.getElementById('modalMoverCalibre');
            if (modal) modal.remove();
        }

        // Ejecutar el movimiento del calibre
        function ejecutarMoverCalibre(origenFilaIndex, origenCuadranteIndex, origenLoteIndex, calibreIndex, destinoFilaIndex, destinoCuadranteIndex) {
            const calibre = almacenData.filas[origenFilaIndex].cuadrantes[origenCuadranteIndex].lotes[origenLoteIndex].calibres[calibreIndex];
            const loteOrigen = almacenData.filas[origenFilaIndex].cuadrantes[origenCuadranteIndex].lotes[origenLoteIndex];

            // Buscar si el lote ya existe en el destino
            const cuadranteDestino = almacenData.filas[destinoFilaIndex].cuadrantes[destinoCuadranteIndex];
            let loteDestino = cuadranteDestino.lotes.find(l => l.loteId === loteOrigen.loteId);

            if (!loteDestino) {
                // Crear el lote en el destino si no existe
                loteDestino = {
                    loteId: loteOrigen.loteId,
                    codigoLote: loteOrigen.codigoLote,
                    calibres: []
                };
                cuadranteDestino.lotes.push(loteDestino);
            }

            // Agregar calibre al destino
            loteDestino.calibres.push({ ...calibre });

            // Quitar calibre del origen
            almacenData.filas[origenFilaIndex].cuadrantes[origenCuadranteIndex].lotes[origenLoteIndex].calibres.splice(calibreIndex, 1);

            // Si el lote origen queda sin calibres, eliminarlo
            if (almacenData.filas[origenFilaIndex].cuadrantes[origenCuadranteIndex].lotes[origenLoteIndex].calibres.length === 0) {
                almacenData.filas[origenFilaIndex].cuadrantes[origenCuadranteIndex].lotes.splice(origenLoteIndex, 1);
            }

            guardarAlmacen();
            cerrarModalMoverCalibre();
            renderizarAlmacen();
        }

        // Buscar en el almac√©n
        function buscarEnAlmacen() {
            const termino = document.getElementById('searchCodigo').value.toLowerCase().trim();
            if (!termino) {
                renderizarAlmacen();
                return;
            }

            // Resaltar coincidencias (simplificado: solo alertar)
            let encontrados = [];
            almacenData.filas.forEach((fila, fi) => {
                fila.cuadrantes.forEach((cuad, ci) => {
                    cuad.lotes.forEach((lote, li) => {
                        const codigoLote = lote.codigoLote || '';
                        if (codigoLote.toLowerCase().includes(termino)) {
                            encontrados.push(`${fila.nombre} > ${cuad.nombre} > ${codigoLote}`);
                        }
                        lote.calibres.forEach(cal => {
                            const calibreNombre = cal.calibre || '';
                            if (calibreNombre.toLowerCase().includes(termino)) {
                                encontrados.push(`${fila.nombre} > ${cuad.nombre} > ${codigoLote} > ${calibreNombre}`);
                            }
                        });
                    });
                });
            });

            if (encontrados.length > 0) {
                var contenidoBusqueda = '<div style="margin-bottom: 0.5rem; color: #64748b;">Se encontraron <strong style="color: #16a34a;">' + encontrados.length + '</strong> resultados:</div>';
                contenidoBusqueda += '<div style="max-height: 300px; overflow-y: auto;">';
                encontrados.forEach(function (item) {
                    contenidoBusqueda += '<div style="padding: 0.6rem; background: #f8fafc; border-radius: 6px; margin-bottom: 0.4rem; font-size: 0.9rem;">üìç ' + item + '</div>';
                });
                contenidoBusqueda += '</div>';
                mostrarModalInfo('Resultados de B√∫squeda', contenidoBusqueda, 'üîç');
            } else {
                mostrarModalInfo('Sin Resultados', '<p style="text-align: center; color: #64748b; padding: 1rem;">No se encontraron resultados para: <strong>' + termino + '</strong></p>', 'üîç');
            }
        }

        // Inicializar almac√©n cuando se muestra la secci√≥n
        function initAlmacenAceitunas() {
            renderizarAlmacen();
        }

        // Initialize reports when section is shown
        const originalShowSection = showSection;
        showSection = function (section) {
            originalShowSection(section);
            if (section === 'reportes') {
                filtrarReportes();
            }
            if (section === 'record') {
                initRecordAnos();
                renderRecordHistorico();
            }
            if (section === 'almacen') {
                initAlmacenAceitunas();
            }
        };
    </script>
</body>

</html>